<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ALPHA ENTRY SCANNER v8 â€” Long Setups Â· Entry Timing</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#03060a;--card:#070d12;--border:#0d1e2c;--border2:#152030;
  --green:#00ff88;--red:#ff3355;--yellow:#ffd700;
  --accent:#00d4ff;--orange:#fb923c;--purple:#c084fc;
  --dim:#2a4555;--text:#d8eaf8;--muted:#0f1e2b;
  --mono:'JetBrains Mono',monospace;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:var(--mono);min-height:100vh}
.gridbg{position:fixed;inset:0;pointer-events:none;z-index:0;opacity:.12;
  background-image:linear-gradient(rgba(0,212,255,.3) 1px,transparent 1px),
  linear-gradient(90deg,rgba(0,212,255,.3) 1px,transparent 1px);background-size:44px 44px}
.wrap{max-width:1480px;margin:0 auto;padding:22px 24px;position:relative;z-index:1}

/* â”€â”€ HEADER â”€â”€ */
.hdr{display:flex;justify-content:space-between;align-items:flex-start;border-bottom:2px solid var(--border);padding-bottom:18px;margin-bottom:18px;flex-wrap:wrap;gap:12px}
.title{font-family:'Bebas Neue',sans-serif;font-size:42px;line-height:1;letter-spacing:.06em;
  background:linear-gradient(135deg,var(--yellow),var(--orange));-webkit-background-clip:text;background-clip:text;color:transparent}
.sub{font-size:9px;color:var(--dim);letter-spacing:.22em;margin-top:5px;text-transform:uppercase}
.hdr-right{display:flex;flex-direction:column;align-items:flex-end;gap:10px}
.btn-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}

/* â”€â”€ BUTTONS â”€â”€ */
.btn-scan{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:.12em;padding:12px 34px;
  background:linear-gradient(135deg,var(--yellow),var(--orange));color:#000;border:none;cursor:pointer;transition:all .2s;
  box-shadow:0 0 28px rgba(255,215,0,.25)}
.btn-scan:hover{box-shadow:0 0 40px rgba(255,215,0,.4);transform:translateY(-1px)}
.btn-scan:disabled{background:var(--muted);color:var(--dim);cursor:not-allowed;box-shadow:none;transform:none}
.btn-monitor{font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:.1em;padding:10px 22px;
  background:transparent;color:var(--green);border:2px solid var(--green);cursor:pointer;transition:all .2s}
.btn-monitor:hover{background:rgba(0,255,136,.08)}
.btn-monitor.active{background:rgba(0,255,136,.12);box-shadow:0 0 18px rgba(0,255,136,.2)}
.btn-tg{padding:9px 16px;background:var(--muted);border:1px solid var(--border2);color:var(--dim);cursor:pointer;font-family:var(--mono);font-size:11px;letter-spacing:.08em;transition:all .2s}
.btn-tg:hover{border-color:var(--accent);color:var(--accent)}

/* â”€â”€ TG TOGGLE â”€â”€ */
.tg-row{display:flex;align-items:center;gap:10px}
.tg-toggle{display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none;font-size:9px;letter-spacing:.12em}
.tg-track{position:relative;width:40px;height:22px;border-radius:11px;background:var(--muted);border:1px solid var(--border2);transition:all .25s;flex-shrink:0}
.tg-thumb{position:absolute;top:3px;left:3px;width:14px;height:14px;border-radius:50%;background:var(--dim);transition:all .25s}
.tg-lbl{color:var(--dim);transition:color .25s;white-space:nowrap}

/* â”€â”€ MARKET STATUS BAR â”€â”€ */
.market-bar{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap}
.mcard{flex:1;min-width:140px;background:var(--card);border:1px solid var(--border);padding:11px 14px;display:flex;align-items:center;gap:10px}
.mdot{width:8px;height:8px;border-radius:50%;flex-shrink:0;animation:blink 2s infinite}
.mc-sym{font-family:'Bebas Neue',sans-serif;font-size:15px;letter-spacing:.08em}
.mc-price{font-size:13px;font-weight:700}
.mc-chg{font-size:11px;font-weight:700}
.mc-lbl{font-size:8px;color:var(--dim);letter-spacing:.12em;text-transform:uppercase;margin-top:2px}
.mc-status{font-size:9px;font-weight:700;letter-spacing:.1em}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.25}}

/* â”€â”€ STRATEGY STEPS â”€â”€ */
.steps-bar{display:flex;gap:2px;margin-bottom:16px;flex-wrap:nowrap;overflow-x:auto}
.step{flex:1;min-width:140px;background:var(--card);border:1px solid var(--border);padding:11px 14px;position:relative}
.step-num{font-family:'Bebas Neue',sans-serif;font-size:28px;line-height:1;color:var(--dim);margin-bottom:2px}
.step-title{font-size:9px;font-weight:700;letter-spacing:.14em;text-transform:uppercase;margin-bottom:3px}
.step-desc{font-size:8px;color:var(--dim);letter-spacing:.04em;line-height:1.6}
.step.active .step-num{color:var(--yellow)}
.step.active{border-color:rgba(255,215,0,.25);background:rgba(255,215,0,.03)}
.step.done .step-num{color:var(--green)}
.step.done{border-color:rgba(0,255,136,.2)}
.step-arrow{position:absolute;right:-10px;top:50%;transform:translateY(-50%);color:var(--dim);font-size:14px;z-index:2}

/* â”€â”€ FILTER BAR â”€â”€ */
.filter-bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;padding:12px 16px;background:var(--card);border:1px solid var(--border);margin-bottom:16px}
.fl{font-size:9px;color:var(--dim);letter-spacing:.12em;white-space:nowrap}
.fi{background:#020609;border:1px solid var(--border2);color:var(--text);font-family:var(--mono);font-size:11px;padding:6px 10px;outline:none;width:70px;transition:border-color .2s}
.fi:focus{border-color:var(--accent)}
.fi-sep{width:1px;height:20px;background:var(--border2)}
label.fl{display:flex;align-items:center;gap:7px;cursor:pointer}
label.fl input[type=checkbox]{width:14px;height:14px;cursor:pointer}

/* â”€â”€ PROGRESS / LOG â”€â”€ */
.prog-wrap{margin-bottom:12px;display:none}.prog-wrap.on{display:block}
.prog-lbl{font-size:9px;color:var(--dim);letter-spacing:.08em;margin-bottom:5px;display:flex;justify-content:space-between}
.prog-bg{height:3px;background:var(--muted);overflow:hidden}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--yellow),var(--orange));transition:width .3s;width:0}
.log{background:var(--card);border:1px solid var(--border);padding:10px 14px;max-height:110px;overflow:auto;font-size:9px;line-height:1.9;margin-bottom:14px;display:none;letter-spacing:.04em}
.log.on{display:block}
.lok{color:var(--green)}.lerr{color:var(--red)}.linfo{color:var(--accent)}.lwarn{color:var(--yellow)}

/* â”€â”€ STATS â”€â”€ */
.stats{display:grid;grid-template-columns:repeat(8,1fr);gap:1px;background:var(--border);margin-bottom:16px}
.stat{background:var(--card);padding:13px 8px;text-align:center;transition:background .15s}
.stat.clickable{cursor:pointer}
.stat.clickable:hover{background:var(--muted)}
.stat.stat-active{background:rgba(255,215,0,.08);outline:1px solid rgba(255,215,0,.3)}
.snum{font-family:'Bebas Neue',sans-serif;font-size:26px;line-height:1;display:block;margin-bottom:3px}
.slbl{font-size:7px;color:var(--dim);letter-spacing:.14em;text-transform:uppercase}
.snum.y{color:var(--yellow)}.snum.g{color:var(--green)}.snum.a{color:var(--accent)}.snum.o{color:var(--orange)}.snum.r{color:var(--red)}.snum.p{color:var(--purple)}

/* â”€â”€ MONITOR BAR â”€â”€ */
.monitor-bar{display:flex;gap:10px;align-items:center;padding:10px 16px;background:rgba(0,255,136,.04);border:1px solid rgba(0,255,136,.15);margin-bottom:16px;font-size:9px;flex-wrap:wrap;display:none}
.monitor-bar.on{display:flex}
.mon-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:blink 1s infinite;flex-shrink:0}

/* â”€â”€ TABLE SECTION â”€â”€ */
.table-section{display:none}
.table-wrap{overflow-x:auto;margin-top:8px}
table{width:100%;border-collapse:separate;border-spacing:0 3px;min-width:900px}
thead tr th{font-size:9px;color:var(--dim);letter-spacing:.14em;text-transform:uppercase;padding:8px 10px;text-align:left;border-bottom:1px solid var(--border);white-space:nowrap}
tbody tr{background:var(--card);transition:background .15s;cursor:pointer}
tbody tr:hover{background:var(--border)}
tbody tr.tr-strong{border-left:3px solid var(--yellow)}
tbody tr.tr-mom{border-left:3px solid var(--accent)}
tbody tr.tr-norm{border-left:3px solid var(--dim)}
tbody tr.tr-entry-ready{outline:1px solid rgba(0,255,136,.3);background:rgba(0,255,136,.03)}
td{padding:9px 10px;font-size:11px;white-space:nowrap}

/* â”€â”€ BADGE SIGNALS â”€â”€ */
.badge-sig{display:inline-block;font-size:8px;font-weight:700;letter-spacing:.1em;padding:3px 7px;border-radius:2px}
.badge-ap{background:rgba(255,215,0,.15);color:var(--yellow);border:1px solid rgba(255,215,0,.3)}
.badge-watch{background:rgba(0,212,255,.1);color:var(--accent);border:1px solid rgba(0,212,255,.2)}

/* â”€â”€ ENTRY STATUS BADGES â”€â”€ */
.es{display:inline-block;font-size:8px;letter-spacing:.08em;padding:3px 8px;border-radius:2px;font-weight:700}
.es-now{background:rgba(0,255,136,.15);color:var(--green);border:1px solid rgba(0,255,136,.4);animation:pulseglow 2s infinite}
.es-close{background:rgba(255,215,0,.12);color:var(--yellow);border:1px solid rgba(255,215,0,.3)}
.es-wait{background:rgba(0,212,255,.08);color:var(--accent);border:1px solid rgba(0,212,255,.2)}
.es-hold{background:var(--muted);color:var(--dim);border:1px solid var(--border2)}
@keyframes pulseglow{0%,100%{box-shadow:0 0 6px rgba(0,255,136,.3)}50%{box-shadow:0 0 14px rgba(0,255,136,.6)}}

/* â”€â”€ TAGS â”€â”€ */
.tag{display:inline-block;font-size:7.5px;letter-spacing:.06em;padding:2px 6px;border-radius:2px;margin:1px 2px}
.tg{background:rgba(0,255,136,.1);color:var(--green)}
.tr{background:rgba(255,51,85,.08);color:var(--red)}
.ty{background:rgba(255,215,0,.1);color:var(--yellow)}
.ta{background:rgba(0,212,255,.08);color:var(--accent)}
.tp{background:rgba(192,132,252,.1);color:var(--purple)}
.to{background:rgba(251,146,60,.1);color:var(--orange)}

/* â”€â”€ TOP PICK â”€â”€ */
.table-top-pick{background:var(--card);border:1px solid rgba(255,215,0,.2);padding:14px 18px;margin-bottom:10px;position:relative}
.table-top-pick::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--yellow)}

/* â”€â”€ EMPTY STATE â”€â”€ */
.empty{display:block;padding:50px 20px;text-align:center}
.empty-icon{font-size:44px;margin-bottom:12px}

/* â”€â”€ TICKER SEARCH â”€â”€ */
.ticker-search{margin-top:18px;background:var(--card);border:1px solid var(--border);padding:16px 18px}
.ts-title{font-size:10px;color:var(--yellow);letter-spacing:.18em;text-transform:uppercase;font-weight:700;margin-bottom:12px}
.ts-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

/* â”€â”€ EXPANDED ROW â”€â”€ */
.expand-detail{background:var(--muted);border-left:2px solid var(--accent)}
.expand-detail td{padding:12px 16px;font-size:10px}
.exp-grid{display:flex;gap:20px;flex-wrap:wrap}
.exp-col{min-width:130px}
.exp-lbl{font-size:8px;color:var(--dim);letter-spacing:.12em;text-transform:uppercase;margin-bottom:3px}
.exp-val{font-size:12px;font-weight:700;color:var(--text)}
.exp-reason{font-size:10px;line-height:1.7;color:var(--text);max-width:500px}

/* â”€â”€ MODAL â”€â”€ */
.modal-ov{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:100;display:flex;align-items:center;justify-content:center;display:none}
.modal-ov.open{display:flex}
.modal{background:var(--card);border:1px solid var(--border2);padding:28px 32px;max-width:480px;width:90%}
.modal-title{font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:.1em;color:var(--yellow);margin-bottom:8px}
.modal-sub{font-size:9px;color:var(--dim);line-height:1.8;margin-bottom:16px}
.modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
.ml{font-size:8px;color:var(--dim);letter-spacing:.12em;margin-bottom:5px}
.mi{width:100%;background:#020609;border:1px solid var(--border2);color:var(--text);font-family:var(--mono);font-size:11px;padding:8px 10px;outline:none}
.mi:focus{border-color:var(--accent)}
.modal-btns{display:flex;gap:10px;justify-content:flex-end}
.mbtn{font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:.1em;padding:10px 24px;border:none;cursor:pointer}
.mbtn-cancel{background:var(--muted);color:var(--dim)}
.mbtn-save{background:linear-gradient(135deg,var(--yellow),var(--orange));color:#000}

/* â”€â”€ PRESET BUTTONS â”€â”€ */
.preset-btn{font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:.1em;padding:6px 14px;background:var(--muted);color:var(--dim);border:1px solid var(--border2);cursor:pointer;transition:all .18s;white-space:nowrap}
.preset-btn:hover{border-color:var(--accent);color:var(--accent)}
.preset-btn.active{background:rgba(255,215,0,.1);color:var(--yellow);border-color:rgba(255,215,0,.4);box-shadow:0 0 10px rgba(255,215,0,.1)}

/* â”€â”€ HOURS BANNER â”€â”€ */
.hours-open{background:rgba(0,255,136,.04);border-color:rgba(0,255,136,.2)!important;color:var(--green)}
.hours-pre{background:rgba(0,212,255,.04);border-color:rgba(0,212,255,.2)!important;color:var(--accent)}
.hours-after{background:rgba(255,215,0,.04);border-color:rgba(255,215,0,.15)!important;color:var(--yellow)}
.hours-closed{background:rgba(255,51,85,.04);border-color:rgba(255,51,85,.2)!important;color:var(--red)}

/* â”€â”€ WATCHLIST STAR â”€â”€ */
.wl-star{background:none;border:none;cursor:pointer;font-size:14px;padding:2px 4px;opacity:.35;transition:opacity .18s;line-height:1}
.wl-star:hover,.wl-star.wl-on{opacity:1}
.wl-star.wl-on{color:var(--yellow)}

/* â”€â”€ STALE BADGE on presets â”€â”€ */
.preset-stale-badge{
  display:none;font-size:7px;color:var(--orange);letter-spacing:.06em;
  position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);
  white-space:nowrap;pointer-events:none;
}
.preset-btn{position:relative;}
.preset-btn.stale .preset-stale-badge{display:block;}
.preset-btn.stale{opacity:.65;border-color:rgba(251,146,60,.25)!important;}

/* â”€â”€ WATCHLIST PANEL â”€â”€ */
.wl-panel{background:var(--card);border:1px solid var(--border2);padding:16px 20px;margin-top:20px}
.wl-panel-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px}
.wl-panel-title{font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:.12em;color:var(--yellow)}
.wl-chips{display:flex;flex-wrap:wrap;gap:8px}
.wl-chip{display:flex;align-items:center;gap:6px;background:var(--muted);border:1px solid var(--border2);padding:6px 10px;cursor:pointer;transition:border-color .18s}
.wl-chip:hover{border-color:var(--accent)}
.wl-chip-sym{font-family:'Bebas Neue',sans-serif;font-size:15px;letter-spacing:.06em;color:var(--yellow)}
.wl-chip-data{font-size:9px;color:var(--dim);letter-spacing:.06em;line-height:1.6}
.wl-chip-remove{background:none;border:none;color:var(--dim);cursor:pointer;font-size:12px;padding:0 0 0 4px;line-height:1;transition:color .15s}
.wl-chip-remove:hover{color:var(--red)}
.wl-empty{font-size:9px;color:var(--dim);letter-spacing:.1em;padding:10px 0}

/* â”€â”€ PERFORMANCE TRACKER TAB â”€â”€ */
.perf-tab-bar{display:flex;gap:0;border-bottom:2px solid var(--border);margin:24px 0 0 0}
.perf-tab{font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:.1em;padding:10px 22px;background:transparent;color:var(--dim);border:none;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .18s}
.perf-tab:hover{color:var(--text)}
.perf-tab.active{color:var(--yellow);border-bottom-color:var(--yellow)}

.perf-section{padding:20px 0;display:none}
.perf-section.active{display:block}

/* scorecard grid */
.sc-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px}
.sc-card{background:var(--card);border:1px solid var(--border2);padding:14px 16px;text-align:center}
.sc-num{font-family:'Bebas Neue',sans-serif;font-size:32px;letter-spacing:.06em;line-height:1}
.sc-lbl{font-size:8px;color:var(--dim);letter-spacing:.14em;text-transform:uppercase;margin-top:4px}

/* alert log table */
.al-table{width:100%;border-collapse:collapse;font-size:11px}
.al-table th{font-size:8px;letter-spacing:.14em;color:var(--dim);padding:6px 10px;text-align:left;border-bottom:1px solid var(--border);white-space:nowrap}
.al-table td{padding:8px 10px;border-bottom:1px solid var(--border);vertical-align:middle}
.al-table tr:hover td{background:var(--muted)}
.al-outcome-tp2{color:var(--green);font-weight:700}
.al-outcome-tp1{color:#7fffcc;font-weight:700}
.al-outcome-stop{color:var(--red);font-weight:700}
.al-outcome-open{color:var(--yellow)}
.al-outcome-expired{color:var(--dim)}

/* breakdown charts */
.bk-row{display:flex;gap:20px;flex-wrap:wrap;margin-bottom:20px}
.bk-card{background:var(--card);border:1px solid var(--border2);padding:16px;flex:1;min-width:220px}
.bk-title{font-size:9px;color:var(--dim);letter-spacing:.14em;text-transform:uppercase;margin-bottom:12px}
.bk-bar-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.bk-bar-lbl{font-size:9px;color:var(--text);width:90px;flex-shrink:0;letter-spacing:.04em}
.bk-bar-bg{flex:1;height:14px;background:var(--muted);border-radius:1px;overflow:hidden}
.bk-bar-fill{height:100%;background:var(--green);transition:width .4s;border-radius:1px}
.bk-bar-pct{font-size:9px;color:var(--dim);width:36px;text-align:right;flex-shrink:0}

/* export row */
.perf-actions{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;align-items:center}

/* â”€â”€ FOOTER â”€â”€ */
.foot{display:flex;justify-content:space-between;font-size:8px;color:var(--dim);letter-spacing:.08em;border-top:1px solid var(--border);padding-top:14px;margin-top:20px;flex-wrap:wrap;gap:8px}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- PASSWORD GATE â€” blocks entire app until correct   -->
<!-- Password fetched live from your Google Sheet.     -->
<!-- Change the sheet value â†’ everyone locked out.     -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="pwGate" style="
  position:fixed;inset:0;z-index:99999;
  background:#03060a;
  display:flex;align-items:center;justify-content:center;
  font-family:'JetBrains Mono',monospace;">
  <div style="width:360px;padding:36px 32px;border:1px solid #0d1e2c;background:#070d12;text-align:center">

    <!-- Logo -->
    <div style="font-family:'Bebas Neue',sans-serif;font-size:36px;letter-spacing:.06em;
      background:linear-gradient(135deg,#ffd700,#fb923c);-webkit-background-clip:text;
      background-clip:text;color:transparent;margin-bottom:4px">
      ALPHA ENTRY SCANNER
    </div>
    <div style="font-size:8px;color:#2a4555;letter-spacing:.22em;margin-bottom:32px">
      NDX100 Â· A+ LONG SETUPS Â· ENTRY TIMING
    </div>

    <!-- Lock icon -->
    <div style="font-size:32px;margin-bottom:20px">ğŸ”</div>

    <div style="font-size:10px;color:#2a4555;letter-spacing:.14em;margin-bottom:16px">
      ENTER ACCESS PASSWORD
    </div>

    <input id="pwInput" type="password"
      placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
      onkeydown="if(event.key==='Enter') checkPassword()"
      style="width:100%;padding:12px 14px;background:#03060a;border:1px solid #0d1e2c;
        color:#d8eaf8;font-family:'JetBrains Mono',monospace;font-size:14px;
        text-align:center;letter-spacing:.2em;outline:none;margin-bottom:12px;
        box-sizing:border-box">

    <button onclick="checkPassword()" style="
      width:100%;padding:12px;font-family:'Bebas Neue',sans-serif;font-size:18px;
      letter-spacing:.12em;background:linear-gradient(135deg,#ffd700,#fb923c);
      color:#000;border:none;cursor:pointer;margin-bottom:16px">
      UNLOCK
    </button>

    <div id="pwError" style="font-size:9px;color:#ff3355;letter-spacing:.1em;
      min-height:16px;margin-bottom:8px"></div>

    <div id="pwStatus" style="font-size:8px;color:#2a4555;letter-spacing:.1em">
      Checking access serverâ€¦
    </div>
  </div>
</div>


<div class="wrap">

<!-- HEADER -->
<div class="hdr">
  <div>
    <div class="title">ALPHA ENTRY SCANNER</div>
    <div class="sub">NDX100 Â· A+ LONG SETUPS Â· C13 TREND + C1 MOMENTUM Â· ENTRY TIMING Â· v8</div>
  </div>
  <div class="hdr-right">
    <div style="font-size:9px;color:var(--dim);letter-spacing:.08em" id="scanStatus">READY TO SCAN</div>
    <div class="btn-row">
      <div class="tg-row">
        <div class="tg-toggle" onclick="toggleTG()">
          <div class="tg-track" id="tgTrack"><div class="tg-thumb" id="tgThumb"></div></div>
          <span class="tg-lbl" id="tgLbl">ğŸ“² TELEGRAM OFF</span>
        </div>
        <button class="btn-tg" onclick="openTGSettings()">âš™ SETUP</button>
      </div>
      <button class="btn-monitor" id="monBtn" onclick="toggleMonitor()">â± AUTO MONITOR</button>
      <button class="btn-scan" id="scanBtn" onclick="runScan()">â–¶ SCAN NOW</button>
    </div>
    <div style="font-size:8px;color:var(--dim)" id="scanTime"></div>
  </div>
</div>

<!-- MARKET HOURS BANNER -->
<div id="hoursBar" style="display:none;padding:10px 16px;margin-bottom:12px;border:1px solid;border-radius:2px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">
  <div style="display:flex;align-items:center;gap:10px">
    <span id="hoursIcon" style="font-size:18px">ğŸ•</span>
    <div>
      <div id="hoursTitle" style="font-family:'Bebas Neue',sans-serif;font-size:15px;letter-spacing:.1em"></div>
      <div id="hoursDesc" style="font-size:9px;color:var(--dim);letter-spacing:.08em;margin-top:2px"></div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:12px">
    <span id="hoursNextOpen" style="font-size:9px;color:var(--dim)"></span>
    <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:9px;color:var(--dim);letter-spacing:.1em;user-select:none">
      <input type="checkbox" id="devOverride" style="width:12px;height:12px;accent-color:var(--yellow)"
        onchange="updateHoursBanner()">
      DEV OVERRIDE â€” TEST ANYTIME
    </label>
  </div>
</div>

<!-- MARKET BAR -->
<div class="market-bar">
  <div class="mcard" id="mc-qqq">
    <div class="mdot" id="dot-qqq" style="background:var(--dim)"></div>
    <div><div class="mc-sym">QQQ</div><div class="mc-lbl">Nasdaq ETF</div></div>
    <div style="margin-left:auto;text-align:right">
      <div class="mc-price" id="qqq-price">â€”</div>
      <div class="mc-chg" id="qqq-chg" style="color:var(--dim)">â€”</div>
    </div>
    <div style="margin-left:12px;text-align:right">
      <div class="mc-status" id="qqq-status" style="color:var(--dim)">â€”</div>
      <div class="mc-lbl">VWAP</div>
    </div>
  </div>
  <div class="mcard" id="mc-spy">
    <div class="mdot" id="dot-spy" style="background:var(--dim)"></div>
    <div><div class="mc-sym">SPY</div><div class="mc-lbl">S&amp;P 500 ETF</div></div>
    <div style="margin-left:auto;text-align:right">
      <div class="mc-price" id="spy-price">â€”</div>
      <div class="mc-chg" id="spy-chg" style="color:var(--dim)">â€”</div>
    </div>
    <div style="margin-left:12px;text-align:right">
      <div class="mc-status" id="spy-status" style="color:var(--dim)">â€”</div>
      <div class="mc-lbl">TREND</div>
    </div>
  </div>
  <div class="mcard" id="mc-vix">
    <div class="mdot" id="dot-vix" style="background:var(--dim)"></div>
    <div><div class="mc-sym">VIX</div><div class="mc-lbl">Fear Index</div></div>
    <div style="margin-left:auto;text-align:right">
      <div class="mc-price" id="vix-price">â€”</div>
      <div class="mc-chg" id="vix-chg" style="color:var(--dim)">â€”</div>
    </div>
    <div style="margin-left:12px;text-align:right">
      <div class="mc-status" id="vix-status" style="color:var(--dim)">â€”</div>
      <div class="mc-lbl">RISK</div>
    </div>
  </div>
  <div class="mcard" style="flex:2;min-width:200px">
    <div>
      <div class="mc-status" id="mkt-verdict" style="color:var(--dim);font-size:11px;font-weight:700;letter-spacing:.12em">AWAITING SCAN</div>
      <div class="mc-lbl" style="margin-top:3px">MARKET GO/NO-GO</div>
      <div style="font-size:8px;color:var(--dim);margin-top:4px;line-height:1.6" id="mkt-reason">Run scan to check market conditions</div>
    </div>
  </div>
</div>

<!-- STRATEGY STEPS -->
<div class="steps-bar" id="stepsBar">
  <div class="step" id="step1">
    <div class="step-num">01</div>
    <div class="step-title" style="color:var(--accent)">CHECK THE TIDE</div>
    <div class="step-desc">QQQ + SPY above VWAP?<br>VIX below 25? â†’ GO<br>One or more failing â†’ WAIT</div>
    <div class="step-arrow">â€º</div>
  </div>
  <div class="step" id="step2">
    <div class="step-num">02</div>
    <div class="step-title" style="color:var(--yellow)">FIND A+ STOCKS</div>
    <div class="step-desc">C13 trend + C1 momentum<br>Both models must agree<br>EMA stack + volume confirm<br>A+ = C13â‰¥5 AND C1â‰¥6</div>
    <div class="step-arrow">â€º</div>
  </div>
  <div class="step" id="step3">
    <div class="step-num">03</div>
    <div class="step-title" style="color:var(--orange)">WAIT FOR PULLBACK</div>
    <div class="step-desc">Price pulls to EMA20 / SMA20<br>or dips to VWAP zone<br>RSI cools to 40â€“60</div>
    <div class="step-arrow">â€º</div>
  </div>
  <div class="step" id="step4">
    <div class="step-num">04</div>
    <div class="step-title" style="color:var(--green)">ENTER + SET LEVELS</div>
    <div class="step-desc">Buy at pullback support<br>Stop = 0.5Ã— ATR below entry<br>TP1 = +1% Â· TP2 = +1.8%</div>
    <div class="step-arrow">â€º</div>
  </div>
  <div class="step" id="step5">
    <div class="step-num">05</div>
    <div class="step-title" style="color:var(--purple)">MONITOR + EXIT</div>
    <div class="step-desc">Auto-refresh every 3 min<br>Telegram alert when entry hits<br>Exit at TP or stop â€” no debate</div>
  </div>
</div>

<!-- PRESET BUTTONS -->
<div style="display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap;align-items:center">
  <span style="font-size:8px;color:var(--dim);letter-spacing:.14em;text-transform:uppercase;margin-right:4px">PRESETS:</span>
  <button class="preset-btn" id="preset-balanced" onclick="applyPreset('balanced')">âš– BALANCED</button>
  <button class="preset-btn" id="preset-best-entry" onclick="applyPreset('best-entry')">âœ… BEST ENTRIES<span class="preset-stale-badge">âš  signals stale</span></button>
  <button class="preset-btn" id="preset-aplus" onclick="applyPreset('aplus')">â­ A+ STRICT</button>
  <button class="preset-btn" id="preset-momentum" onclick="applyPreset('momentum')">ğŸ”¥ MOMENTUM<span class="preset-stale-badge">âš  AM only</span></button>
  <button class="preset-btn" id="preset-bull" onclick="applyPreset('bull')">ğŸ‚ BULL DAY</button>
  <button class="preset-btn" id="preset-bear" onclick="applyPreset('bear')">ğŸ» BEAR / RS DAY</button>
  <button class="preset-btn" id="preset-premarket" onclick="applyPreset('premarket')">ğŸŒ… PRE-MARKET<span class="preset-stale-badge">âš  AM only</span></button>
  <button class="preset-btn" id="preset-breakout" onclick="applyPreset('breakout')">ğŸš€ MORNING BREAKOUT<span class="preset-stale-badge">âš  AM only</span></button>
  <button class="preset-btn" id="preset-afterhours" onclick="applyPreset('afterhours')">ğŸŒ™ AFTER HOURS</button>
  <div style="margin-left:auto;font-size:8px;color:var(--dim);letter-spacing:.08em" id="presetDesc">Balanced: good mix of A+ setups + entry timing â€” best for most days</div>
</div>

<!-- FILTERS -->
<div class="filter-bar">
  <span class="fl">MIN GAP</span>
  <input class="fi" type="number" id="fGap" value="0" step="0.1" min="0" max="10">
  <div class="fi-sep"></div>
  <span class="fl">MIN C13</span>
  <input class="fi" type="number" id="fC13" value="4" min="0" max="9">
  <span class="fl" style="color:var(--dim)">/9</span>
  <div class="fi-sep"></div>
  <span class="fl">MIN C1</span>
  <input class="fi" type="number" id="fC1" value="5" min="0" max="14">
  <span class="fl" style="color:var(--dim)">/14</span>
  <div class="fi-sep"></div>
  <span class="fl">MIN VOL</span>
  <input class="fi" type="number" id="fVol" value="1.1" step="0.1" min="0" max="10">
  <span class="fl" style="color:var(--dim)">x</span>
  <div class="fi-sep"></div>
  <span class="fl" style="color:var(--yellow)">MIN R:R</span>
  <input class="fi" type="number" id="fMinRR" value="1.5" step="0.1" min="0" max="10"
    style="border-color:rgba(255,215,0,.3);width:58px"
    title="Min reward:risk ratio â€” 1.5 recommended. Filters table AND blocks Telegram alerts below this threshold.">
  <span class="fl" style="color:var(--dim)">x</span>
  <div class="fi-sep"></div>
  <label class="fl"><input type="checkbox" id="fAplusOnly"> A+ ONLY (C13â‰¥5 AND C1â‰¥6)</label>
  <div class="fi-sep"></div>
  <label class="fl"><input type="checkbox" id="fEntryReady"> ENTRY READY ONLY âœ…</label>
  <div class="fi-sep"></div>
  <label class="fl"><input type="checkbox" id="modeMomentum"> MOMENTUM SNIPER MODE</label>
  <div class="fi-sep"></div>
  <label class="fl"><input type="checkbox" id="fGoodMarket"> SKIP ON BAD MARKET</label>
  <div class="fi-sep"></div>
  <div style="display:flex;align-items:center;gap:7px">
    <span class="fl">DEPTH</span>
    <span style="font-size:8px;color:var(--dim)">FAST</span>
    <input type="range" id="enrichSlider" min="0" max="2" step="1" value="1"
      style="width:52px;accent-color:var(--yellow);cursor:pointer;vertical-align:middle"
      oninput="syncDepthLabel()">
    <span style="font-size:8px;color:var(--dim)">FULL</span>
    <span id="depthLabel" style="font-size:9px;color:var(--yellow);letter-spacing:.08em;min-width:70px">NORMALÂ·24</span>
  </div>
  <div class="fi-sep"></div>
  <div id="proxyStatus" style="font-size:8px;color:var(--dim);letter-spacing:.06em" title="Proxy health â€” green=fast, red=penalized">P1Â· P2Â· P3Â·</div>
</div>

<!-- PROGRESS + LOG -->
<div class="prog-wrap" id="prog">
  <div class="prog-lbl"><span id="progLbl">Scanningâ€¦</span><span id="progPct">0%</span></div>
  <div class="prog-bg"><div class="prog-fill" id="progFill"></div></div>
</div>
<div class="log" id="log"></div>

<!-- STATS -->
<div class="stats">
  <div class="stat"><span class="snum" id="s1">â€”</span><span class="slbl">Scanned</span></div>
  <div class="stat clickable" onclick="filterByStat('all')" title="Show all candidates"><span class="snum y" id="s2">â€”</span><span class="slbl">Candidates</span></div>
  <div class="stat clickable" onclick="filterByStat('aplus')" title="Show A+ setups only"><span class="snum y" id="s3">â€”</span><span class="slbl">A+ Setups</span></div>
  <div class="stat clickable" onclick="filterByStat('ready')" title="Show entry ready stocks"><span class="snum g" id="s4">â€”</span><span class="slbl">Entry Ready</span></div>
  <div class="stat clickable" onclick="filterByStat('close')" title="Show close to entry stocks"><span class="snum a" id="s5">â€”</span><span class="slbl">Close to Entry</span></div>
  <div class="stat clickable" onclick="filterByStat('c13')" title="Show C13 qualified stocks"><span class="snum o" id="s6">â€”</span><span class="slbl">C13 Qualified</span></div>
  <div class="stat"><span class="snum p" id="s7">â€”</span><span class="slbl">TG Alerts Sent</span></div>
  <div class="stat"><span class="snum" id="s8">â€”</span><span class="slbl">Scan Time</span></div>
</div>

<!-- MONITOR BAR -->
<div class="monitor-bar" id="monBar">
  <div class="mon-dot"></div>
  <span style="color:var(--green);font-weight:700;letter-spacing:.1em">MONITORING ACTIVE</span>
  <span style="color:var(--dim)">â€”</span>
  <span style="color:var(--text)" id="monStatus">Watching for entry conditionsâ€¦</span>
  <span style="margin-left:auto;color:var(--dim)" id="monNext"></span>
  <button onclick="toggleMonitor()" style="margin-left:8px;padding:5px 12px;background:transparent;border:1px solid rgba(255,51,85,.4);color:var(--red);font-family:var(--mono);font-size:9px;cursor:pointer;letter-spacing:.08em">STOP</button>
</div>

<!-- TABLE SECTION -->
<div id="tableSection" class="table-section">
  <div id="tableTopPick"></div>
  <div class="table-wrap"><table>
    <thead><tr>
      <th style="width:28px"></th>
      <th style="width:36px">#</th>
      <th style="width:120px">Symbol</th>
      <th style="width:80px">Signal</th>
      <th style="width:80px;text-align:right">Price</th>
      <th style="width:72px;text-align:right">Chg%</th>
      <th style="width:48px;text-align:center">C13</th>
      <th style="width:48px;text-align:center">C1</th>
      <th style="width:58px;text-align:center">Blend</th>
      <th style="width:64px;text-align:right">Vol</th>
      <th style="width:120px">Entry Status</th>
      <th style="width:200px">Entry Â· Stop Â· TP</th>
      <th>Reasons</th>
    </tr></thead>
    <tbody id="tableBody"></tbody>
  </table></div>
</div>

<!-- POSITION SIZE CALCULATOR -->
<div id="posSizer" style="background:var(--card);border:1px solid var(--border2);padding:14px 18px;margin-bottom:14px;display:none">
  <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
    <span style="font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:.12em;color:var(--yellow)">âš– POSITION SIZER</span>
    <div style="display:flex;align-items:center;gap:6px">
      <span style="font-size:9px;color:var(--dim);letter-spacing:.1em">ACCOUNT $</span>
      <input type="number" id="psAccount" value="10000" min="100" step="500"
        style="background:var(--muted);border:1px solid var(--border2);color:var(--text);font-family:var(--mono);font-size:11px;padding:5px 8px;width:90px;outline:none"
        oninput="updatePosSizer()">
    </div>
    <div style="display:flex;align-items:center;gap:6px">
      <span style="font-size:9px;color:var(--dim);letter-spacing:.1em">RISK %</span>
      <input type="number" id="psRisk" value="1" min="0.1" max="5" step="0.1"
        style="background:var(--muted);border:1px solid var(--border2);color:var(--text);font-family:var(--mono);font-size:11px;padding:5px 8px;width:60px;outline:none"
        oninput="updatePosSizer()">
      <span style="font-size:9px;color:var(--dim)">%</span>
    </div>
    <div id="psResult" style="font-size:10px;color:var(--dim);letter-spacing:.06em">â€” enter account size and risk % to calculate shares</div>
  </div>
</div>

<!-- EMPTY STATE -->
<div class="empty" id="emptyState">
  <div class="empty-icon">ğŸ“¡</div>
  <div style="font-size:11px;color:var(--dim);letter-spacing:.12em">PRESS SCAN NOW TO START</div>
  <div style="font-size:9px;color:var(--dim);margin-top:10px;line-height:2">
    Best used: 9:30â€“11:30 AM ET Â· Scanner checks all 100 NDX stocks<br>
    Scores with C13 (trend) + C1 (momentum) dual-model<br>
    Tells you exactly when to enter based on EMA20 / SMA20 / VWAP pullback<br>
    <span style="color:var(--yellow)">Works in ALL market conditions â€” strong RS stocks show up even on red days</span>
  </div>
</div>

<!-- TICKER SEARCH -->
<div class="ticker-search">
  <div class="ts-title">ğŸ” CHECK ANY TICKER â€” Alpha Dual-Model Analysis on Demand</div>
  <div class="ts-row">
    <input id="anyTickerInput" placeholder="e.g. ADSK, PLTR, TSLA, COIN" maxlength="12"
      style="background:#020509;border:1px solid var(--border2);color:var(--text);font-family:var(--mono);font-size:13px;padding:10px 14px;width:240px;letter-spacing:.10em;text-transform:uppercase;outline:none"
      onkeydown="if(event.key==='Enter') analyzeAnyTicker()"
      oninput="this.value=this.value.toUpperCase()">
    <button class="btn-tg" id="anyTickerBtn" onclick="analyzeAnyTicker()" style="padding:10px 18px;border-color:rgba(255,215,0,.35);color:var(--yellow)">
      â–¶ ANALYZE
    </button>
    <span style="font-size:10px;color:var(--dim)">Works on any stock â€” not just NDX100</span>
  </div>
  <div id="anyTickerOut" style="margin-top:12px"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- PERFORMANCE TRACKER                               -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div style="margin-top:32px;border-top:2px solid var(--border);padding-top:4px">
  <div class="perf-tab-bar">
    <button class="perf-tab active" onclick="perfTab('log')">ğŸ“‹ ALERT LOG</button>
    <button class="perf-tab" onclick="perfTab('scorecard')">ğŸ“Š SCORECARD</button>
    <button class="perf-tab" onclick="perfTab('breakdown')">ğŸ”¬ BREAKDOWN</button>
    <div style="margin-left:auto;display:flex;align-items:center;gap:8px;padding-bottom:6px">
      <span style="font-size:9px;color:var(--dim)" id="perfGradeStatus"></span>
      <button class="btn-tg" onclick="gradeOpenAlerts()" style="font-size:9px;padding:5px 12px;border-color:rgba(0,212,255,.3);color:var(--accent)" title="Check open alerts against current prices">â†» GRADE NOW</button>
      <button class="btn-tg" onclick="exportCSV()" style="font-size:9px;padding:5px 12px" title="Download full alert log as CSV">â¬‡ EXPORT CSV</button>
      <button class="btn-tg" onclick="clearAlertLog()" style="font-size:9px;padding:5px 12px;color:var(--red);border-color:rgba(255,51,85,.2)" title="Clear all alert history">âœ• CLEAR LOG</button>
    </div>
  </div>

  <!-- TAB 1: ALERT LOG -->
  <div class="perf-section active" id="perf-log">
    <div style="font-size:9px;color:var(--dim);margin-bottom:10px;letter-spacing:.08em">
      Every alert that fires is logged here automatically. Outcomes are graded at 4 PM ET daily, or manually via GRADE NOW.
    </div>
    <div style="overflow-x:auto">
      <table class="al-table">
        <thead><tr>
          <th>Date / Time</th>
          <th>Symbol</th>
          <th>Preset</th>
          <th style="text-align:right">Entry $</th>
          <th style="text-align:right">Stop $</th>
          <th style="text-align:right">TP1 $</th>
          <th style="text-align:right">TP2 $</th>
          <th style="text-align:center">R:R</th>
          <th style="text-align:center">C13</th>
          <th style="text-align:center">C1</th>
          <th style="text-align:right">Vol</th>
          <th style="text-align:center">Outcome</th>
          <th style="text-align:right">P&L pts</th>
          <th style="text-align:right">Actual R:R</th>
          <th>Graded At</th>
        </tr></thead>
        <tbody id="alertLogBody"></tbody>
      </table>
    </div>
    <div id="alertLogEmpty" style="text-align:center;padding:32px;font-size:10px;color:var(--dim);letter-spacing:.12em">
      NO ALERTS LOGGED YET â€” alerts appear here automatically when they fire
    </div>
  </div>

  <!-- TAB 2: SCORECARD -->
  <div class="perf-section" id="perf-scorecard">
    <div class="sc-grid" id="scGrid"></div>
    <div id="scInsights" style="font-size:10px;color:var(--dim);line-height:2;padding:12px 16px;background:var(--card);border:1px solid var(--border2)">
      Run the scanner and let alerts fire to start building your scorecard.
    </div>
  </div>

  <!-- TAB 3: BREAKDOWN -->
  <div class="perf-section" id="perf-breakdown">
    <div class="bk-row">
      <div class="bk-card">
        <div class="bk-title">Win Rate by Preset</div>
        <div id="bkPreset"></div>
      </div>
      <div class="bk-card">
        <div class="bk-title">Win Rate by Time of Day</div>
        <div id="bkTime"></div>
      </div>
      <div class="bk-card">
        <div class="bk-title">Win Rate by C13 Score</div>
        <div id="bkC13"></div>
      </div>
      <div class="bk-card">
        <div class="bk-title">Win Rate by Market Condition</div>
        <div id="bkMarket"></div>
      </div>
    </div>
    <div id="bkEmpty" style="text-align:center;padding:32px;font-size:10px;color:var(--dim);letter-spacing:.12em">
      Need at least 5 graded alerts to show breakdown analysis
    </div>
  </div>
</div>


<div class="wl-panel">
  <div class="wl-panel-hdr">
    <div class="wl-panel-title">â˜… WATCHLIST</div>
    <div style="display:flex;align-items:center;gap:10px">
      <span style="font-size:9px;color:var(--dim)" id="wlCount">0 stocks saved</span>
      <button onclick="rescanWatchlist()" class="btn-tg" style="font-size:10px;padding:5px 12px;border-color:rgba(255,215,0,.3);color:var(--yellow)" title="Re-score all watchlist stocks with latest data">â†º RESCAN WATCHLIST</button>
      <button onclick="clearWatchlist()" class="btn-tg" style="font-size:10px;padding:5px 12px" title="Remove all watchlist entries">âœ• CLEAR ALL</button>
    </div>
  </div>
  <div id="wlChips" class="wl-chips">
    <div class="wl-empty">Star any stock in the results table to save it here. Persists across page refreshes.</div>
  </div>
</div>

<div class="foot">
  <span>Yahoo Finance Â· NDX100 Â· A+ Dual-Model Â· C13 Trend + C1 Momentum Â· EMA20/SMA20/VWAP Entry Timing Â· Not financial advice</span>
  <span id="footRight"></span>
</div>

</div><!-- /wrap -->

<!-- TG MODAL -->
<div class="modal-ov" id="tgModal">
  <div class="modal">
    <div class="modal-title">TELEGRAM ALERT SETTINGS</div>
    <div class="modal-sub">
      Alerts fire for A+ setups (C13 â‰¥ 5 AND C1 â‰¥ 6) when entry conditions are met.<br>
      How to get your bot token: Telegram â†’ @BotFather â†’ /newbot â†’ copy token.<br>
      Chat ID: send a message to your bot, then visit https://api.telegram.org/bot&lt;TOKEN&gt;/getUpdates
    </div>
    <div class="modal-grid">
      <div><div class="ml">BOT TOKEN</div><input class="mi" type="text" id="tgTok" placeholder="123456:ABC-DEFâ€¦"></div>
      <div><div class="ml">CHAT ID</div><input class="mi" type="text" id="tgChat" placeholder="-100123456 or user ID"></div>
    </div>
    <div style="margin-bottom:16px">
      <label style="display:flex;align-items:center;gap:8px;font-size:10px;color:var(--text);cursor:pointer">
        <input type="checkbox" id="tgAlertEntry" style="width:14px;height:14px">
        Send alert when A+ stock hits entry zone (pullback to EMA20/VWAP)
      </label>
      <label style="display:flex;align-items:center;gap:8px;font-size:10px;color:var(--text);cursor:pointer;margin-top:8px">
        <input type="checkbox" id="tgAlertScan" style="width:14px;height:14px">
        Send summary after each scan (top 3 A+ setups)
      </label>
    </div>
    <div class="modal-btns">
      <button class="mbtn mbtn-cancel" onclick="closeTGModal()">CANCEL</button>
      <button class="mbtn mbtn-save" onclick="saveTGSettings()">SAVE SETTINGS</button>
    </div>
  </div>
</div>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PASSWORD GATE
// Password is stored in YOUR Google Sheet (one cell).
// Change it there â†’ everyone is locked out immediately.
//
// SETUP (one time):
//  1. Create a new Google Sheet
//  2. In cell A1, type your password e.g. trader2026
//  3. File â†’ Share â†’ "Anyone with link can VIEW"
//  4. Copy the Sheet ID from the URL:
//     docs.google.com/spreadsheets/d/SHEET_ID/edit
//  5. Paste your SHEET_ID in the line below
//
// TO CHANGE PASSWORD: edit cell A1 in your sheet.
// Takes effect within 1 hour (cache expiry).
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PW_SHEET_ID  = '1G32ROOsgSgyfqmOk1pmijQRh1N_56bwLDwdUhSlYiNI'; // â† your Sheet ID
const PW_CACHE_KEY = 'alpha_pw_cache';
const PW_CACHE_TTL = 60 * 60 * 1000; // 1 hour cache

let CORRECT_PASSWORD = null;

async function fetchPassword(){
  // Use cached password if fresh
  try{
    const cached = JSON.parse(localStorage.getItem(PW_CACHE_KEY)||'null');
    if(cached && Date.now() - cached.ts < PW_CACHE_TTL){
      CORRECT_PASSWORD = cached.pw;
      return cached.pw;
    }
  }catch(e){}
  // Fetch live from Google Sheets (public sheet, no API key needed)
  try{
    const url = `https://docs.google.com/spreadsheets/d/${PW_SHEET_ID}/gviz/tq?tqx=out:json&sheet=Sheet1&range=A1`;
    const res  = await fetch(url);
    const txt  = await res.text();
    const json = JSON.parse(txt.replace(/^[^(]+\(/, '').replace(/\);?$/, ''));
    const pw   = json?.table?.rows?.[0]?.c?.[0]?.v?.toString().trim();
    if(pw){
      CORRECT_PASSWORD = pw;
      localStorage.setItem(PW_CACHE_KEY, JSON.stringify({pw, ts:Date.now()}));
      return pw;
    }
  }catch(e){}
  return null;
}

async function initPasswordGate(){
  const statusEl = document.getElementById('pwStatus');
  // Developer mode â€” sheet ID not set yet, skip gate
  if(PW_SHEET_ID === 'YOUR_GOOGLE_SHEET_ID_HERE'){
    unlockApp(); return;
  }
  // Already unlocked this browser session (won't ask again until tab closes)
  if(sessionStorage.getItem('alpha_unlocked') === '1'){
    unlockApp(); return;
  }
  statusEl.textContent = 'Connecting to access serverâ€¦';
  const pw = await fetchPassword();
  if(!pw){
    // Sheet unreachable â€” try last cached password
    const cached = JSON.parse(localStorage.getItem(PW_CACHE_KEY)||'null');
    if(cached){ CORRECT_PASSWORD = cached.pw; statusEl.textContent = 'âš  Offline â€” using cached credentials'; }
    else { statusEl.textContent = 'âš  Cannot reach access server â€” contact admin'; return; }
  } else {
    statusEl.textContent = 'âœ“ Ready â€” enter your password';
  }
  document.getElementById('pwInput').focus();
}

function checkPassword(){
  const input = document.getElementById('pwInput').value.trim();
  const errEl = document.getElementById('pwError');
  if(!input){ errEl.textContent = 'ENTER A PASSWORD'; return; }
  if(!CORRECT_PASSWORD){ errEl.textContent = 'STILL LOADING â€” TRY AGAIN'; return; }
  if(input === CORRECT_PASSWORD){
    sessionStorage.setItem('alpha_unlocked', '1');
    unlockApp();
  } else {
    errEl.textContent = 'INCORRECT PASSWORD';
    document.getElementById('pwInput').value = '';
    document.getElementById('pwInput').focus();
    // Force re-fetch on next attempt â€” catches password change
    localStorage.removeItem(PW_CACHE_KEY);
    CORRECT_PASSWORD = null;
    fetchPassword().then(pw => { if(pw) document.getElementById('pwStatus').textContent = 'âœ“ Ready'; });
  }
}

function unlockApp(){
  const gate = document.getElementById('pwGate');
  gate.style.transition = 'opacity .3s';
  gate.style.opacity = '0';
  setTimeout(() => gate.style.display='none', 300);
}

// Run immediately on page load
initPasswordGate();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TELEGRAM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let TG_TOKEN   = localStorage.getItem('pm_tg_token')  || '';
let TG_CHAT_ID = localStorage.getItem('pm_tg_chat')   || '';
let tgEnabled  = localStorage.getItem('pm_tg_on') === '1';
let tgAlertEntry = localStorage.getItem('pm_tg_entry') !== '0';
let tgAlertScan  = localStorage.getItem('pm_tg_scan')  !== '0';

function syncTGUI(){
  const on = tgEnabled;
  document.getElementById('tgTrack').style.background  = on?'var(--green)':'var(--muted)';
  document.getElementById('tgTrack').style.borderColor = on?'var(--green)':'var(--border2)';
  document.getElementById('tgThumb').style.background  = on?'#000':'var(--dim)';
  document.getElementById('tgThumb').style.left        = on?'22px':'3px';
  document.getElementById('tgLbl').textContent  = on?'ğŸ“² TELEGRAM ON':'ğŸ“² TELEGRAM OFF';
  document.getElementById('tgLbl').style.color  = on?'var(--green)':'var(--dim)';
}
function toggleTG(){
  tgEnabled = !tgEnabled;
  localStorage.setItem('pm_tg_on', tgEnabled?'1':'0');
  syncTGUI();
  if(tgEnabled && (!TG_TOKEN || !TG_CHAT_ID)) openTGSettings();
}
function openTGSettings(){
  document.getElementById('tgTok').value  = TG_TOKEN;
  document.getElementById('tgChat').value = TG_CHAT_ID;
  document.getElementById('tgAlertEntry').checked = tgAlertEntry;
  document.getElementById('tgAlertScan').checked  = tgAlertScan;
  document.getElementById('tgModal').classList.add('open');
}
function closeTGModal(){ document.getElementById('tgModal').classList.remove('open'); }
function saveTGSettings(){
  TG_TOKEN   = document.getElementById('tgTok').value.trim();
  TG_CHAT_ID = document.getElementById('tgChat').value.trim();
  tgAlertEntry = document.getElementById('tgAlertEntry').checked;
  tgAlertScan  = document.getElementById('tgAlertScan').checked;
  localStorage.setItem('pm_tg_token', TG_TOKEN);
  localStorage.setItem('pm_tg_chat',  TG_CHAT_ID);
  localStorage.setItem('pm_tg_entry', tgAlertEntry?'1':'0');
  localStorage.setItem('pm_tg_scan',  tgAlertScan ?'1':'0');
  closeTGModal();
  logTo('âœ“ Telegram settings saved','lok');
}
async function tgSend(msg){
  if(!tgEnabled || !TG_TOKEN || !TG_CHAT_ID) return false;
  try{
    const r = await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({chat_id:TG_CHAT_ID, text:msg, parse_mode:'Markdown'})
    });
    return r.ok;
  }catch(e){ return false; }
}

async function sendEntryAlert(r){
  if(!tgAlertEntry) return;
  // R:R gate â€” never alert on low quality setups
  const minRR = parseFloat(document.getElementById('fMinRR')?.value) || 1.5;
  if(r.rr < minRR){
    logTo(`âš  TG alert skipped: ${r.sym} R:R ${r.rr.toFixed(1)}x < min ${minRR}x`,'lwarn');
    return;
  }
  const rrColor = r.rr >= 2 ? 'ğŸŸ¢' : r.rr >= 1.5 ? 'ğŸŸ¡' : 'ğŸ”´';
  const msg =
`â­ *A+ ENTRY SIGNAL â€” ALPHA SCANNER*
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“Œ *${r.sym}* â€” ${r.name||r.sym}
ğŸ’° Price: \$${r.price.toFixed(2)}  |  Chg: ${r.chgPct>=0?'+':''}${r.chgPct.toFixed(2)}%
ğŸ¯ Entry: \$${r.entryPrice.toFixed(2)}  â† *BUY HERE*
ğŸ›‘ Stop Loss: \$${r.stopLoss.toFixed(2)}
âœ… TP1: \$${r.tp1.toFixed(2)} (+1%)
ğŸš€ TP2: \$${r.tp2.toFixed(2)} (+1.8%)
${rrColor} R:R = ${r.rr.toFixed(1)}x
ğŸ“Š C13: ${r.c13}/9  |  C1: ${r.c1}/14  |  Vol: ${r.vr.toFixed(1)}x
ğŸ” ${r.entryReason}
â° ${new Date().toLocaleTimeString()}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âš ï¸ Not financial advice`;
  const ok = await tgSend(msg);
  if(ok){ alertsSent++; document.getElementById('s7').textContent = alertsSent; }
  // Log every alert regardless of Telegram status
  logAlert(r);
}

// Distinct Telegram alert for watchlist stocks hitting entry
// Fires even if stock didn't score A+ â€” because you starred it for your own reasons
async function sendWatchlistAlert(r){
  if(!tgAlertEntry) return;
  const rrColor = r.rr >= 2 ? 'ğŸŸ¢' : r.rr >= 1.5 ? 'ğŸŸ¡' : 'ğŸ”´';
  const msg =
`â˜… *WATCHLIST ALERT â€” ALPHA SCANNER*
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“Œ *${r.sym}* â€” ${r.name||r.sym}
ğŸ’° Price: \$${r.price.toFixed(2)}  |  Chg: ${r.chgPct>=0?'+':''}${r.chgPct.toFixed(2)}%
ğŸ¯ Entry: \$${r.entryPrice.toFixed(2)}  â† *BUY ZONE*
ğŸ›‘ Stop Loss: \$${r.stopLoss.toFixed(2)}
âœ… TP1: \$${r.tp1?.toFixed(2)||'â€”'}
ğŸš€ TP2: \$${r.tp2?.toFixed(2)||'â€”'}
${rrColor} R:R = ${r.rr?.toFixed(1)||'â€”'}x
ğŸ” ${r.entryReason||'At support level'}
â° ${new Date().toLocaleTimeString()}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“‹ You starred this stock â€” it just hit your entry level
âš ï¸ Not financial advice`;
  const ok = await tgSend(msg);
  if(ok){ alertsSent++; document.getElementById('s7').textContent = alertsSent; }
}

async function sendScanSummary(apStocks){
  if(!tgAlertScan || !apStocks.length) return;
  const minRR = parseFloat(document.getElementById('fMinRR')?.value) || 1.5;
  // Only show READY stocks in summary â€” others are just watchlist
  const readyNow = apStocks.filter(r => r.entryStatus === 'READY' && r.rr >= minRR);
  const watching = apStocks.filter(r => r.entryStatus !== 'READY');
  const readyLines = readyNow.length
    ? readyNow.slice(0,3).map((r,i) =>
        `${i+1}. *${r.sym}*  âœ… ENTER NOW  Entry:\$${r.entryPrice.toFixed(2)}  R:R:${r.rr.toFixed(1)}x  C13:${r.c13}/9  C1:${r.c1}/14`
      ).join('\n')
    : '  (none at entry zone yet â€” monitor running)';
  const watchLines = watching.slice(0,4).map(r =>
    `  â€¢ ${r.sym}  ${r.entryStatus}  C13:${r.c13}/9  C1:${r.c1}/14`
  ).join('\n');
  const mktTxt = lastMarketOk ? 'âœ… BULLISH' : 'âš ï¸ BEARISH â€” RS ONLY';
  const msg =
`ğŸ“¡ *ALPHA SCAN COMPLETE*
${new Date().toLocaleTimeString()}  |  Market: ${mktTxt}
A+ Setups: ${apStocks.length}  |  Entry Ready: ${readyNow.length}  |  Min R:R: ${minRR}x
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ¯ *READY TO ENTER NOW:*
${readyLines}
ğŸ“‹ *WATCHING (waiting for pullback):*
${watchLines || '  (none)'}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âš ï¸ Not financial advice`;
  await tgSend(msg);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NETWORK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NETWORK â€” Yahoo crumb auth + smart proxy health
// Yahoo Finance now requires a crumb + cookie on every
// request. We fetch the crumb once at scan start and
// append it to every data URL. Proxies rotate with
// health scoring â€” bad proxies get 10min penalty.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Yahoo crumb â€” fetched once per session
let YH_CRUMB = null;
let YH_CRUMB_FETCHING = false;

// Proxy definitions â€” ordered best to worst by default
// Some proxies handle Yahoo auth better than others
const PROXY_FNS = [
  url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
  url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
  url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
  url => `https://corsproxy.io/?url=${encodeURIComponent(url)}`,  // alt format
  url => `https://thingproxy.freeboard.io/fetch/${url}`,
];

// Yahoo-specific proxies that inject proper headers
const YH_DIRECT_URLS = [
  sym => `https://query1.finance.yahoo.com/v8/finance/chart/${sym}`,
  sym => `https://query2.finance.yahoo.com/v8/finance/chart/${sym}`,
];

const pH = PROXY_FNS.map((_,i) => ({
  i, consec:0, wins:0, avgMs:9999, badUntil:0,
}));

function proxyOrder(){
  const now = Date.now();
  return [...pH].sort((a,b) => {
    const aBad = a.badUntil > now ? 1 : 0;
    const bBad = b.badUntil > now ? 1 : 0;
    if(aBad !== bBad) return aBad - bBad;
    return (a.avgMs - a.wins*30) - (b.avgMs - b.wins*30);
  });
}

function proxyHit(i, ok, ms){
  const h = pH[i];
  if(ok){
    h.consec=0; h.wins++; h.badUntil=0;
    h.avgMs = h.avgMs>5000 ? ms : Math.round(h.avgMs*0.65 + ms*0.35);
  } else {
    h.consec++;
    if(h.consec >= 2){
      h.badUntil = Date.now() + 10*60*1000;
      logTo(`âš¡ Proxy ${i+1} penalized 10min (${h.consec} fails)`, 'lwarn');
    }
  }
  refreshProxyUI();
}

function refreshProxyUI(){
  const now = Date.now();
  const el = document.getElementById('proxyStatus');
  if(!el) return;
  el.innerHTML = pH.slice(0,3).map(h => {
    const bad = h.badUntil > now;
    const color = bad ? 'var(--red)' : h.wins>0 ? 'var(--green)' : 'var(--dim)';
    const ms = h.avgMs<5000 ? ` ${h.avgMs}ms` : '';
    return `<span style="color:${color}">P${h.i+1}${bad?'âœ—':'âœ“'}${ms}</span>`;
  }).join(' ');
}

async function proxyFetch(url, timeoutMs=10000){
  const order = proxyOrder();
  let lastErr;
  for(let attempt=0; attempt<order.length; attempt++){
    const h = order[attempt];
    const ctrl = new AbortController();
    const timer = setTimeout(() => ctrl.abort(), timeoutMs);
    const t0 = Date.now();
    try{
      const proxyUrl = PROXY_FNS[h.i](url);
      const r = await fetch(proxyUrl, {
        signal: ctrl.signal,
        headers: { 'Accept': 'application/json, text/plain, */*' }
      });
      clearTimeout(timer);
      if(r.status === 429){ proxyHit(h.i,false,0); lastErr='Rate limited'; continue; }
      if(r.status === 403){ proxyHit(h.i,false,0); lastErr='Forbidden'; continue; }
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      proxyHit(h.i, true, Date.now()-t0);
      return r;
    }catch(e){
      clearTimeout(timer);
      proxyHit(h.i, false, 0);
      lastErr = e.message;
    }
  }
  throw new Error(lastErr || 'All proxies failed');
}

// â”€â”€ Yahoo crumb fetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Yahoo requires a crumb token on all data requests.
// We get it by hitting their consent page first.
// The crumb is appended to every chart API URL.
async function fetchYahooCrumb(){
  if(YH_CRUMB) return YH_CRUMB;
  if(YH_CRUMB_FETCHING) {
    // Wait for in-flight crumb fetch
    for(let i=0; i<20; i++){
      await new Promise(r=>setTimeout(r,200));
      if(YH_CRUMB) return YH_CRUMB;
    }
    return null;
  }
  YH_CRUMB_FETCHING = true;
  try{
    // Hit Yahoo Finance home to get cookies
    const r = await proxyFetch('https://finance.yahoo.com/quote/AAPL/', 8000);
    const html = await r.text();
    // Extract crumb from page HTML
    const match = html.match(/"crumb"\s*:\s*"([^"]+)"/);
    if(match) {
      YH_CRUMB = match[1].replace(/\\u002F/g, '/');
      logTo(`âœ“ Yahoo crumb obtained`, 'lok');
      return YH_CRUMB;
    }
    // Try alternate crumb location
    const match2 = html.match(/crumb=([A-Za-z0-9._-]+)/);
    if(match2){ YH_CRUMB = match2[1]; return YH_CRUMB; }
    logTo('âš  Could not extract Yahoo crumb â€” trying without', 'lwarn');
    return null;
  }catch(e){
    logTo(`âš  Crumb fetch failed: ${e.message} â€” trying without`, 'lwarn');
    return null;
  }finally{
    YH_CRUMB_FETCHING = false;
  }
}

function buildYhUrl(sym, interval, params){
  const base = `https://query1.finance.yahoo.com/v8/finance/chart/${sym}?interval=${interval}&${params}`;
  return YH_CRUMB ? `${base}&crumb=${encodeURIComponent(YH_CRUMB)}` : base;
}

function extractJSON(txt){
  // Strip HTML error pages â€” if response is HTML, throw immediately
  const trimmed = txt.trim();
  if(trimmed.startsWith('<')){
    // Try to extract any JSON embedded in HTML (some proxies wrap it)
    const jsonMatch = trimmed.match(/\{[^<]{20,}/);
    if(!jsonMatch) throw new Error('Got HTML instead of JSON');
    txt = jsonMatch[0];
  }
  const i = Math.min(
    txt.indexOf('{') >= 0 ? txt.indexOf('{') : 99999,
    txt.indexOf('[') >= 0 ? txt.indexOf('[') : 99999
  );
  if(i === 99999) throw new Error('No JSON found');
  try { return JSON.parse(txt.slice(i)); }
  catch(e) { throw new Error('JSON parse failed: '+e.message); }
}
async function safeJSON(r){ return extractJSON(await r.text()); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TICKERS â€” 24h localStorage cache
// Wikipedia + proxy is the #1 flaky dependency.
// Cache the parsed list; only re-fetch once per day.
// Saves ~1-2s on every repeat scan. Falls back to
// built-in list if both cache and network fail.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TC_KEY = 'alpha_ndx_v2';
const TC_TTL  = 24 * 60 * 60 * 1000;

let TICKERS = [], TICKERS_LOADED = false;

function tickerCacheLoad() {
  try {
    const raw = localStorage.getItem(TC_KEY);
    if (!raw) return null;
    const {tickers, ts} = JSON.parse(raw);
    if (!Array.isArray(tickers) || tickers.length < 80) return null;
    if (Date.now() - ts > TC_TTL) return null;
    return tickers;
  } catch(e) { return null; }
}
function tickerCacheSave(t) {
  try { localStorage.setItem(TC_KEY, JSON.stringify({tickers:t, ts:Date.now()})); } catch(e) {}
}
function tickerCacheAge() {
  try {
    const raw = localStorage.getItem(TC_KEY);
    if (!raw) return null;
    const {ts} = JSON.parse(raw);
    const m = Math.round((Date.now()-ts)/60000);
    return m < 60 ? `${m}m ago` : `${Math.round(m/60)}h ago`;
  } catch(e) { return null; }
}

async function fetchNDX100List(){
  const url = "https://en.wikipedia.org/wiki/Nasdaq-100";
  const r = await proxyFetch(url);
  const html = await r.text();
  const k = html.toLowerCase().indexOf('<html');
  const doc = new DOMParser().parseFromString(html.slice(k>=0?k:0), "text/html");
  const tables = [...doc.querySelectorAll("table.wikitable")];
  let best = null;
  for(const t of tables){
    const hdr = (t.querySelector("tr")?.innerText||"").toLowerCase();
    if(hdr.includes("ticker")||hdr.includes("symbol")){ best=t; break; }
  }
  if(!best) throw new Error("Wikitable not found");
  const hdrs = [...best.querySelectorAll("tr th")].map(x=>x.innerText.trim().toLowerCase());
  let symCol = hdrs.findIndex(h=>h.includes("ticker")||h.includes("symbol"));
  if(symCol<0) symCol=0;
  const rows = [...best.querySelectorAll("tr")].slice(1);
  const out=[]; const seen=new Set();
  for(const row of rows){
    const tds=[...row.querySelectorAll("td")];
    if(!tds.length) continue;
    const raw=(tds[symCol]?.innerText||"").trim();
    if(!raw) continue;
    const sym=(raw.replace(/\s+/g,"").replace(/\[.*?\]/g,"").replace(".","-")).toUpperCase();
    if(!sym||seen.has(sym)) continue;
    seen.add(sym);
    const name=(tds.find((_,i)=>i!==symCol)?.innerText||sym).trim();
    out.push({sym,name});
  }
  if(out.length<80) throw new Error(`Too few tickers (${out.length})`);
  return out.slice(0,110);
}

const FALLBACK_TICKERS = [
  {sym:"AAPL",name:"Apple"},{sym:"MSFT",name:"Microsoft"},{sym:"NVDA",name:"NVIDIA"},
  {sym:"AMZN",name:"Amazon"},{sym:"META",name:"Meta"},{sym:"TSLA",name:"Tesla"},
  {sym:"GOOGL",name:"Alphabet A"},{sym:"GOOG",name:"Alphabet C"},{sym:"AVGO",name:"Broadcom"},
  {sym:"COST",name:"Costco"},{sym:"AMD",name:"AMD"},{sym:"NFLX",name:"Netflix"},
  {sym:"ADBE",name:"Adobe"},{sym:"PEP",name:"PepsiCo"},{sym:"CSCO",name:"Cisco"},
  {sym:"INTC",name:"Intel"},{sym:"TXN",name:"Texas Instruments"},{sym:"AMAT",name:"Applied Materials"},
  {sym:"QCOM",name:"Qualcomm"},{sym:"MU",name:"Micron"},{sym:"PANW",name:"Palo Alto Networks"},
  {sym:"SBUX",name:"Starbucks"},{sym:"BKNG",name:"Booking"},{sym:"REGN",name:"Regeneron"},
  {sym:"CRWD",name:"CrowdStrike"},{sym:"SNPS",name:"Synopsys"},{sym:"CDNS",name:"Cadence"},
  {sym:"INTU",name:"Intuit"},{sym:"AMGN",name:"Amgen"},{sym:"LRCX",name:"Lam Research"},
  {sym:"ADSK",name:"Autodesk"},{sym:"MELI",name:"MercadoLibre"},{sym:"ASML",name:"ASML"},
  {sym:"KLAC",name:"KLA Corp"},{sym:"MRVL",name:"Marvell"},{sym:"FTNT",name:"Fortinet"},
  {sym:"ABNB",name:"Airbnb"},{sym:"WDAY",name:"Workday"},{sym:"DXCM",name:"Dexcom"},
  {sym:"IDXX",name:"IDEXX Labs"},{sym:"ROST",name:"Ross Stores"},{sym:"ODFL",name:"Old Dominion"},
  {sym:"FAST",name:"Fastenal"},{sym:"CPRT",name:"Copart"},{sym:"PAYX",name:"Paychex"},
  {sym:"PCAR",name:"PACCAR"},{sym:"MNST",name:"Monster Bev"},{sym:"MCHP",name:"Microchip"},
  {sym:"CEG",name:"Constellation Energy"},{sym:"ADP",name:"ADP"},{sym:"FANG",name:"Diamondback"},
];

async function ensureTickers(){
  if(TICKERS_LOADED && TICKERS.length) return;

  // 1. Try cache â€” no network hit needed
  const cached = tickerCacheLoad();
  if(cached){
    TICKERS = cached; TICKERS_LOADED = true;
    logTo(`âœ“ ${TICKERS.length} tickers from cache (${tickerCacheAge()}) â€” Wikipedia skipped`,'lok');
    return;
  }

  // 2. Cache miss/expired â€” fetch fresh
  try{
    logTo("â–º Fetching NDX100 list from Wikipediaâ€¦","linfo");
    TICKERS = await fetchNDX100List();
    TICKERS_LOADED = true;
    tickerCacheSave(TICKERS);
    logTo(`âœ“ ${TICKERS.length} tickers fetched + cached for 24h`,"lok");
  }catch(e){
    // 3. Network dead â€” use built-in fallback
    logTo(`âš  Wikipedia failed (${e.message}) â€” using built-in list`,"lwarn");
    TICKERS = FALLBACK_TICKERS;
    TICKERS_LOADED = true;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA FETCHERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cache1d={}, cache5m={};

async function yh1d(sym, days=160){
  const key=`${sym}_${days}`;
  if(cache1d[key]) return cache1d[key];
  const to=Math.floor(Date.now()/1000), from=to-days*86400;
  const url = buildYhUrl(sym, '1d', `period1=${from}&period2=${to}&events=history`);
  const r=await proxyFetch(url);
  const j=await safeJSON(r);
  const res=j?.chart?.result?.[0];
  if(!res) throw new Error(j?.chart?.error?.description||"No daily data");
  const q=res.indicators?.quote?.[0];
  const adj=res.indicators?.adjclose?.[0]?.adjclose||q?.close;
  if(!q?.high||!adj) throw new Error("Bad daily series");
  const valid=[];
  for(let i=0;i<res.timestamp.length;i++){
    const c=adj[i],h=q.high[i],l=q.low[i],o=q.open[i],v=q.volume[i];
    if([c,h,l].some(x=>x==null)) continue;
    valid.push({c,h,l,o,v:v||0});
  }
  if(valid.length<60) throw new Error(`Only ${valid.length} bars`);
  const meta=res.meta;
  const lastBar=valid.at(-1), prevBar=valid.at(-2);
  const price = meta.regularMarketPrice||lastBar.c;
  const prevClose = prevBar?.c||null;
  const chgPct = (price&&prevClose) ? ((price-prevClose)/prevClose)*100 : (meta.regularMarketChangePercent||0);
  // Gap = today's open vs prev close
  const todayOpen = meta.regularMarketOpen||lastBar.o;
  const gapPct = (todayOpen&&prevClose) ? ((todayOpen-prevClose)/prevClose)*100 : 0;
  const out={price, chgPct, gapPct, closes:valid.map(x=>x.c), highs:valid.map(x=>x.h), lows:valid.map(x=>x.l), volumes:valid.map(x=>x.v)};
  cache1d[key]=out;
  return out;
}

async function yh5m(sym){
  if(cache5m[sym]) return cache5m[sym];
  const now=Math.floor(Date.now()/1000), start=now-7*3600;
  const url = buildYhUrl(sym, '5m', `period1=${start}&period2=${now}`);
  const r=await proxyFetch(url);
  const j=await safeJSON(r);
  const res=j?.chart?.result?.[0];
  if(!res) throw new Error("No 5m data");
  const m=res.meta,q=res.indicators?.quote?.[0],t=res.timestamp||[];
  if(!q?.close||q.close.length<6) throw new Error("Not enough 5m candles");
  const candles=[];
  for(let i=0;i<t.length;i++){
    const o=q.open?.[i],h=q.high?.[i],l=q.low?.[i],c=q.close?.[i],v=q.volume?.[i];
    if([o,h,l,c,v].some(x=>x==null)) continue;
    candles.push({t:t[i],o,h,l,c,v});
  }
  if(candles.length<6) throw new Error("Too few valid 5m candles");
  const out={price:m.regularMarketPrice||candles.at(-1).c, prev:m.previousClose||null, open:m.regularMarketOpen||null, candles};
  cache5m[sym]=out;
  return out;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INDICATORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ema(arr,p){if(!arr||arr.length<p)return null;const k=2/(p+1);let v=arr.slice(0,p).reduce((a,b)=>a+b,0)/p;for(let i=p;i<arr.length;i++)v=arr[i]*k+v*(1-k);return v;}
function sma(arr,p){if(!arr||arr.length<p)return null;return arr.slice(-p).reduce((a,b)=>a+b,0)/p;}
function rsi14(c){if(!c||c.length<15)return null;let g=0,l=0;for(let i=c.length-14;i<c.length;i++){const d=c[i]-c[i-1];d>0?g+=d:l-=d;}const ag=g/14,al=l/14;return al===0?100:100-100/(1+ag/al);}
function atrFn(h,l,c,n=14){if(!c||c.length<n+1)return null;const tr=[];for(let i=c.length-n;i<c.length;i++)tr.push(Math.max(h[i]-l[i],Math.abs(h[i]-c[i-1]),Math.abs(l[i]-c[i-1])));return tr.reduce((a,b)=>a+b,0)/n;}
function avgVol(vols,n=20){if(!vols||vols.length<n)return null;return vols.slice(-n-1,-1).reduce((a,b)=>a+b,0)/n;}
function vwapFromCandles(candles){if(!candles||!candles.length)return null;let tp=0,vl=0;for(const c of candles){tp+=(c.h+c.l+c.c)/3*c.v;vl+=c.v;}return vl>0?tp/vl:null;}
function vSpike(candles){if(!candles||candles.length<11)return 1;const last=candles.at(-1),prev=candles.slice(-11,-1),avg=prev.reduce((s,c)=>s+c.v,0)/10;return avg>0?last.v/avg:1;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCORING â€” v5: market-neutral pre-filter fix
// C13: Trend quality (max 9)
// C1:  Momentum quality (max 14)
// KEY FIX: market gets 1pt when neutral (not -2pts penalty)
// Relative strength vs SPY is rewarded EXTRA on down days
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function scoreC13(d, market){
  let pts=0; const tags=[];
  // EMA stack 20/50/200 (2pts)
  const emaOK=d.ema20!=null&&d.ema50!=null&&d.ema200!=null&&d.price>d.ema20&&d.price>d.ema50&&d.price>d.ema200;
  if(emaOK){pts+=2;tags.push({t:'EMA STACK âœ“',c:'tg'});}
  else {
    // Partial: above EMA20 only still gets 1pt
    if(d.ema20&&d.price>d.ema20){pts+=1;tags.push({t:'ABOVE EMA20',c:'ty'});}
    else tags.push({t:'EMA STACK âœ—',c:'tr'});
  }
  // Volume (2pts)
  if(d.vr>=1.2){pts+=2;tags.push({t:`VOL ${d.vr.toFixed(1)}x âœ“`,c:'ty'});}
  else if(d.vr>0) tags.push({t:`VOL ${d.vr.toFixed(1)}x`,c:'ta'});
  else tags.push({t:'VOL â€”',c:'ta'});
  // Market condition (2pts bull, 1pt neutral/mixed, 0pt bear)
  // FIX: removed -2pt penalty that killed all scores on bear days
  if(market?.qqqBull && market?.spyBull){pts+=2;tags.push({t:`MKT âœ“ QQQ+SPY up`,c:'tg'});}
  else if(market?.qqqBull || market?.spyBull){pts+=1;tags.push({t:`MKT MIXED`,c:'ty'});}
  else tags.push({t:`MKT âœ— BEARISH`,c:'tr'}); // 0pts, not negative
  // RSI 40â€“65 sweet spot (1pt)
  if(d.rsi!=null&&d.rsi>=40&&d.rsi<=65){pts+=1;tags.push({t:`RSI ${d.rsi.toFixed(0)} âœ“`,c:'tp'});}
  else if(d.rsi!=null) tags.push({t:`RSI ${d.rsi.toFixed(0)}`,c:'ta'});
  // Room to / breakout above 20d high (2pts)
  if(d.room!=null&&d.room<0){pts+=2;tags.push({t:'BREAKOUT âœ“',c:'tg'});}
  else if(d.room!=null&&d.room<=2){pts+=2;tags.push({t:`NEAR 20D HI âœ“`,c:'to'});}
  else if(d.room!=null&&d.room<=5){pts+=1;tags.push({t:`ROOM ${d.room.toFixed(1)}%`,c:'ty'});}
  else tags.push({t:'FAR FROM HI',c:'ta'});
  return {pts,max:9,tags};
}

function scoreC1(d){
  let pts=0; const tags=[];
  // Intraday move (4pts) â€” positive chg required for long
  if(d.chgPct>=3){pts+=4;tags.push({t:`+${d.chgPct.toFixed(1)}% ğŸ”¥`,c:'tg'});}
  else if(d.chgPct>=2){pts+=3;tags.push({t:`+${d.chgPct.toFixed(1)}%`,c:'tg'});}
  else if(d.chgPct>=1){pts+=2;tags.push({t:`+${d.chgPct.toFixed(1)}%`,c:'ty'});}
  else if(d.chgPct>=0){pts+=1;tags.push({t:`+${d.chgPct.toFixed(1)}%`,c:'ta'});}
  else tags.push({t:`${d.chgPct.toFixed(1)}%`,c:'tr'});
  // Volume spike (3pts)
  if(d.vr>=2.5){pts+=3;tags.push({t:`VOL ${d.vr.toFixed(1)}x ğŸ”¥`,c:'tg'});}
  else if(d.vr>=1.5){pts+=2;tags.push({t:`VOL ${d.vr.toFixed(1)}x`,c:'ty'});}
  else if(d.vr>=1.1){pts+=1;tags.push({t:`VOL ${d.vr.toFixed(1)}x`,c:'ta'});}
  else tags.push({t:`VOL ${d.vr.toFixed(1)}x`,c:'tr'});
  // Relative strength vs SPY (2pts) â€” BONUS on red days
  const rsBonus = (!d.marketBull && d.rs>0) ? 1 : 0; // extra pt for outperforming a down market
  if(d.rs>1.5){pts+=2+rsBonus;tags.push({t:`RS +${d.rs.toFixed(1)}% vs SPY${rsBonus?' ğŸ”¥':''}`,c:'tg'});}
  else if(d.rs>0){pts+=1;tags.push({t:`RS +${d.rs.toFixed(1)}%`,c:'ty'});}
  else tags.push({t:`RS ${d.rs.toFixed(1)}%`,c:'tr'});
  // Gap up (2pts) â€” uses real gap now
  if(d.gapPct>=1.5){pts+=2;tags.push({t:`GAP +${d.gapPct.toFixed(1)}% âœ“`,c:'tg'});}
  else if(d.gapPct>=0.5){pts+=1;tags.push({t:`GAP +${d.gapPct.toFixed(1)}%`,c:'ty'});}
  else if(d.gapPct>0) tags.push({t:`GAP +${d.gapPct.toFixed(1)}%`,c:'ta'});
  else tags.push({t:'NO GAP',c:'ta'});
  // Above VWAP (2pts)
  if(d.abvVWAP===true){pts+=2;tags.push({t:'ABOVE VWAP âœ“',c:'tg'});}
  else if(d.abvVWAP===false) tags.push({t:'BELOW VWAP',c:'tr'});
  else tags.push({t:'VWAP â€”',c:'ta'});
  // ATR range expansion (1pt)
  if(d.rr!=null&&d.rr>=1.3){pts+=1;tags.push({t:`RANGE ${d.rr.toFixed(1)}x ATR`,c:'ta'});}
  return {pts,max:14,tags};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENTRY TIMING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcEntryZone(price, ema20, sma20, vwap, atr14){
  const zones=[];
  if(ema20) zones.push({name:'EMA20',level:ema20,dist:((price-ema20)/price)*100});
  if(sma20) zones.push({name:'SMA20',level:sma20,dist:((price-sma20)/price)*100});
  if(vwap)  zones.push({name:'VWAP', level:vwap, dist:((price-vwap)/price)*100});

  const support=zones.filter(z=>z.level<price).sort((a,b)=>b.level-a.level);
  const nearest=support[0]||null;

  let status='WAITING', entryReason='', entryPrice=price;
  if(!nearest){
    status='NO_SUPPORT'; entryReason='No EMA20/SMA20/VWAP support below price'; entryPrice=price;
  } else {
    const d=nearest.dist; entryPrice=nearest.level;
    if(d<=0.3)     {status='READY';    entryReason=`âœ… At ${nearest.name} ($${nearest.level.toFixed(2)}) â€” ENTER NOW`;}
    else if(d<=1.0){status='CLOSE';    entryReason=`â³ ${d.toFixed(2)}% above ${nearest.name} ($${nearest.level.toFixed(2)}) â€” wait for dip`;}
    else if(d<=2.5){status='EXTENDED'; entryReason=`ğŸ“ˆ Running ${d.toFixed(2)}% above ${nearest.name} ($${nearest.level.toFixed(2)}) â€” wait`;}
    else           {status='CHASING';  entryReason=`âš ï¸ Too extended (${d.toFixed(2)}% above ${nearest.name}) â€” do NOT chase`;}
  }
  return {status,entryReason,entryPrice,nearestSupport:nearest,allZones:zones};
}

function calcLevels(price, entryPrice, atr14, gapPct, nearestSupport){
  const supportLevel = nearestSupport?.level || entryPrice;
  const buffer = atr14 * 0.10;

  // Structure-based stop: just below support level
  const structureStop = +(supportLevel - buffer).toFixed(2);

  // ATR-based stop: 0.5Ã—ATR below entry (traditional, always gives valid R:R)
  const atrStop = +(entryPrice - atr14 * 0.5).toFixed(2);

  // Use whichever stop is LOWER (wider) â€” ensures stop isn't above entry
  // and gives a more realistic risk distance
  const stopLoss = Math.min(structureStop, atrStop);

  const tp1 = +(entryPrice * 1.010).toFixed(2);
  const tp2 = +(Math.max(entryPrice * 1.018, entryPrice + atr14 * 2)).toFixed(2);
  const reward = tp1 - entryPrice;
  const risk   = entryPrice - stopLoss;
  const rr = risk > 0 ? +Math.min(reward / risk, 10).toFixed(2) : 0;
  return {stopLoss, tp1, tp2, rr};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MARKET CHECK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lastMarketOk=true, spyChg=0, qqqChg=0;

async function checkMarket(){
  let qqqBull=false, spyBull=false, vixOk=true;
  try{
    const d=await yh1d('QQQ');
    let vwapQ=null;
    try{ vwapQ=vwapFromCandles((await yh5m('QQQ')).candles); }catch(e){}
    qqqChg=d.chgPct; qqqBull=qqqChg>0;
    const abvV=vwapQ?d.price>vwapQ:false;
    document.getElementById('qqq-price').textContent='$'+d.price.toFixed(2);
    document.getElementById('qqq-chg').textContent=(qqqChg>=0?'+':'')+qqqChg.toFixed(2)+'%';
    document.getElementById('qqq-chg').style.color=qqqBull?'var(--green)':'var(--red)';
    document.getElementById('dot-qqq').style.background=qqqBull?'var(--green)':'var(--red)';
    document.getElementById('qqq-status').textContent=(qqqBull?'BULLISH':'BEARISH')+(abvV?' Â· ABOVE VWAP':' Â· BELOW VWAP');
    document.getElementById('qqq-status').style.color=qqqBull?'var(--green)':'var(--red)';
  }catch(e){logTo(`âš  QQQ failed: ${e.message}`,'lwarn');}
  try{
    const d=await yh1d('SPY');
    spyChg=d.chgPct; spyBull=spyChg>0;
    const em20=ema(d.closes,20);
    document.getElementById('spy-price').textContent='$'+d.price.toFixed(2);
    document.getElementById('spy-chg').textContent=(spyChg>=0?'+':'')+spyChg.toFixed(2)+'%';
    document.getElementById('spy-chg').style.color=spyBull?'var(--green)':'var(--red)';
    document.getElementById('dot-spy').style.background=spyBull?'var(--green)':'var(--red)';
    document.getElementById('spy-status').textContent=(em20&&d.price>em20)?'ABOVE EMA20 âœ“':'BELOW EMA20 âœ—';
    document.getElementById('spy-status').style.color=(em20&&d.price>em20)?'var(--green)':'var(--red)';
  }catch(e){logTo(`âš  SPY failed: ${e.message}`,'lwarn');}
  try{
    const d=await yh1d('^VIX');
    vixOk=d.price<25;
    document.getElementById('vix-price').textContent=d.price.toFixed(1);
    document.getElementById('vix-chg').textContent=(d.chgPct>=0?'+':'')+d.chgPct.toFixed(2)+'%';
    document.getElementById('vix-chg').style.color=d.chgPct<=0?'var(--green)':'var(--red)';
    document.getElementById('dot-vix').style.background=vixOk?'var(--green)':'var(--red)';
    document.getElementById('vix-status').textContent=vixOk?'CALM < 25 âœ“':'HIGH > 25 âš ';
    document.getElementById('vix-status').style.color=vixOk?'var(--green)':'var(--yellow)';
  }catch(e){logTo(`âš  VIX failed: ${e.message}`,'lwarn');}

  lastMarketOk=qqqBull||spyBull;
  const verdict=document.getElementById('mkt-verdict');
  const reason=document.getElementById('mkt-reason');
  if(qqqBull&&spyBull&&vixOk){
    verdict.textContent='âœ… GO â€” ALL CLEAR'; verdict.style.color='var(--green)';
    reason.textContent='QQQ + SPY both green Â· VIX calm Â· Market supports longs'; reason.style.color='var(--green)';
    setStep(1,'done');
  }else if(qqqBull||spyBull){
    verdict.textContent='âš ï¸ PROCEED CAREFULLY'; verdict.style.color='var(--yellow)';
    reason.textContent='Mixed signals â€” only take A+ setups with strong RS'; reason.style.color='var(--yellow)';
    setStep(1,'active');
  }else{
    verdict.textContent='ğŸ›‘ BEARISH â€” STRONG RS ONLY'; verdict.style.color='var(--red)';
    reason.textContent='Both red Â· Scanner still runs â€” strong RS stocks show up! Lower your position size.'; reason.style.color='var(--yellow)';
    setStep(1,'active'); // not done, but not blocked
  }
  return {bull:qqqBull||spyBull, qqqBull, spyBull, vixOk};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function logTo(msg,cls=''){
  const b=document.getElementById('log'); b.classList.add('on');
  const d=document.createElement('div'); d.textContent=msg; d.className=cls;
  b.appendChild(d); b.scrollTop=b.scrollHeight;
}
function setProgress(pct,label){
  document.getElementById('prog').classList.add('on');
  document.getElementById('progFill').style.width=pct+'%';
  document.getElementById('progLbl').textContent=label;
  document.getElementById('progPct').textContent=Math.round(pct)+'%';
}
function setStep(n,state){
  const el=document.getElementById('step'+n);
  if(!el) return;
  el.className='step'+(state?' '+state:'');
}
function fmt2(x){return(typeof x==='number'&&isFinite(x))?x.toFixed(2):'â€”';}
function fmtX(x){return(typeof x==='number'&&isFinite(x))?x.toFixed(2)+'x':'â€”';}
function fmtPct(x){if(typeof x!=='number'||!isFinite(x))return'â€”';return(x>=0?'+':'')+x.toFixed(2)+'%';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ALL_RESULTS=[], ALL_MARKET=null, ALL_FILTERS={minC13:3,minC1:4,minVol:0};
let TOP_PICK=null; // always the rank-1 stock from the last renderAll
let alertsSent=0, alreadyAlerted=new Set();
let monitorTimer=null, monitorActive=false, monitorCountdown=180, monCountTimer=null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN SCAN
// KEY FIX: pre-filter is now VERY loose (just removes clear 0-score cases)
// All stocks pass through to scoring. Best 30 get 5m enrichment.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function runScan(isSilent=false){
  if(!isSilent){
    cache1d={}; cache5m={}; ALL_RESULTS=[];
    YH_CRUMB = null; // force fresh crumb on each full scan
    document.getElementById('log').innerHTML='';
    document.getElementById('log').className='log';
    document.getElementById('emptyState').style.display='block';
    document.getElementById('tableSection').style.display='none';
  }
  const btn=document.getElementById('scanBtn');
  btn.disabled=true; btn.textContent='SCANNINGâ€¦';
  document.getElementById('scanStatus').textContent='SCANNINGâ€¦';
  document.getElementById('scanStatus').style.color='var(--yellow)';
  document.getElementById('prog').classList.add('on');
  const t0=Date.now();

  await ensureTickers();
  setStep(1,'active');

  // Fetch Yahoo crumb first â€” required for all data requests
  logTo('â–º Fetching Yahoo Finance auth tokenâ€¦','linfo');
  await fetchYahooCrumb();

  logTo('â–º Checking market conditions (QQQ / SPY / VIX)â€¦','linfo');
  const market=await checkMarket();
  logTo(`âœ“ QQQ ${qqqChg>=0?'+':''}${qqqChg.toFixed(2)}%  SPY ${spyChg>=0?'+':''}${spyChg.toFixed(2)}%  Market: ${market.bull?'BULLISH âœ…':'BEARISH âš ï¸ (strong RS stocks still run)'}`, market.bull?'lok':'lwarn');

  const skipBad=document.getElementById('fGoodMarket').checked;
  if(skipBad && !market.bull){
    logTo('â›” Market not bullish and SKIP ON BAD MARKET is checked â€” uncheck to run anyway','lwarn');
    document.getElementById('prog').classList.remove('on');
    btn.disabled=false; btn.textContent='â–¶ SCAN NOW';
    document.getElementById('scanStatus').textContent='MARKET BEARISH â€” uncheck "SKIP ON BAD MARKET" to run';
    document.getElementById('scanStatus').style.color='var(--red)';
    return;
  }

  const fMinGap=parseFloat(document.getElementById('fGap').value)||0;
  const fMinC13=parseInt(document.getElementById('fC13').value,10)||3;
  const fMinC1 =parseInt(document.getElementById('fC1').value,10)||4;
  const fMinVol=parseFloat(document.getElementById('fVol').value)||0;

  setStep(1,'done'); setStep(2,'active');
  logTo(`â–º Scanning ${TICKERS.length} tickers (1D data)â€¦`,'linfo');

  const total=TICKERS.length;
  let done=0, fail1d=0;
  const allScored=[]; // ALL stocks get scored â€” no pre-filter killing candidates
  const BATCH1=6;

  for(let i=0;i<total;i+=BATCH1){
    const batch=TICKERS.slice(i,i+BATCH1);
    const res=await Promise.allSettled(batch.map(async tk=>{
      const d1=await yh1d(tk.sym);
      const price=d1.price;
      const chgPct=d1.chgPct||0;
      const gapPct=d1.gapPct||0;

      // Only skip if gap filter is set AND gap doesn't meet it
      if(fMinGap>0 && gapPct<fMinGap) return null;

      const em20=ema(d1.closes,20);
      const em50=ema(d1.closes,50);
      const em200=ema(d1.closes,200);
      const rsiv=rsi14(d1.closes);
      const atr14=atrFn(d1.highs,d1.lows,d1.closes,14)||price*0.01;
      const av=avgVol(d1.volumes,20);
      const todayVol=d1.volumes.at(-1)||0;
      // FEATURE 5: Adjust volume ratio for time of day
      // At 9:45 AM the day's volume looks 3x just because it's compressed
      // into 15 minutes. Scale by how much of the day has elapsed.
      const volAdj = getVolAdjustmentFactor();
      const vr=av&&av>0?(todayVol*volAdj)/av:1;
      const hi20=d1.highs.length>=20?Math.max(...d1.highs.slice(-20)):null;
      const room=hi20&&price?((hi20-price)/price*100):null;
      const rs=chgPct-spyChg;
      const sma20v=sma(d1.closes,20);

      const dObj={price,chgPct,gapPct,vr,ema20:em20,ema50:em50,ema200:em200,rsi:rsiv,room,abvVWAP:null,rr:null,rs,marketBull:market.bull};
      const c13r=scoreC13(dObj,market);
      const c1r=scoreC1(dObj);

      return {
        sym:tk.sym, name:tk.name,
        price, gapPct, chgPct,
        c13:c13r.pts, c1:c1r.pts,
        c13tags:c13r.tags, c1tags:c1r.tags,
        vr, rsi:rsiv,
        ema20:em20, ema50:em50, ema200:em200, sma20:sma20v,
        atr14, room,
        vwap:null, abvVWAP:null,
        entryStatus:'WAITING',
        entryReason:'Enriching with 5m dataâ€¦',
        entryPrice:price,
        nearestSupport:null,
        stopLoss:+(price-atr14*0.5).toFixed(2),
        tp1:+(price*1.010).toFixed(2),
        tp2:+(Math.max(price*1.018,price+atr14*2)).toFixed(2),
        rr:0, rs, _monitoring:false
      };
    }));
    res.forEach(r=>{ done++; if(r.status==='fulfilled'&&r.value) allScored.push(r.value); else fail1d++; });
    setProgress((done/total)*55,`${done}/${total} scored`);
    await new Promise(r=>setTimeout(r,160));
  }

  logTo(`âœ“ 1D pass: ${allScored.length} scored Â· ${fail1d} failed`,'lok');
  if(!allScored.length){
    logTo('âš  All fetches failed â€” check network/proxy','lerr');
    btn.disabled=false; btn.textContent='â–¶ SCAN NOW';
    document.getElementById('prog').classList.remove('on');
    return;
  }

  // Sort by combined score + chgPct to pick best candidates for 5m enrichment
  allScored.sort((a,b)=>(b.c13+b.c1+Math.max(b.chgPct,0)*0.5)-(a.c13+a.c1+Math.max(a.chgPct,0)*0.5));

  // Depth slider: 0=Fast(12), 1=Normal(24), 2=Full(40)
  const ENRICH_N = [12, 24, 40][parseInt(document.getElementById('enrichSlider').value)] ?? 24;
  const enrich=allScored.slice(0,ENRICH_N);

  logTo(`â–º Enriching top ${enrich.length} with 5m intraday (VWAP + entry timing)â€¦`,'linfo');
  let done5=0, fail5=0;
  const BATCH5=4;

  for(let i=0;i<enrich.length;i+=BATCH5){
    const batch=enrich.slice(i,i+BATCH5);
    const res5=await Promise.allSettled(batch.map(async r=>{
      const m5=await yh5m(r.sym);
      const vwap=vwapFromCandles(m5.candles);
      r.vwap=vwap;
      r.price=m5.price||r.price;
      r.abvVWAP=vwap?r.price>vwap:null;
      r.vr=Math.max(r.vr,vSpike(m5.candles));

      const ez=calcEntryZone(r.price,r.ema20,r.sma20,vwap,r.atr14);
      const lv=calcLevels(r.price,ez.entryPrice,r.atr14,r.gapPct,ez.nearestSupport);
      r.entryStatus=ez.status; r.entryReason=ez.entryReason;
      r.entryPrice=ez.entryPrice; r.nearestSupport=ez.nearestSupport;
      r.stopLoss=lv.stopLoss; r.tp1=lv.tp1; r.tp2=lv.tp2; r.rr=lv.rr;

      // Re-score C1 with VWAP known
      const rs=r.chgPct-spyChg;
      const dObj={price:r.price,chgPct:r.chgPct,gapPct:r.gapPct,vr:r.vr,ema20:r.ema20,ema50:r.ema50,ema200:r.ema200,rsi:r.rsi,room:r.room,abvVWAP:r.abvVWAP,rr:r.rr,rs,marketBull:market.bull};
      const c1r=scoreC1(dObj);
      r.c1=c1r.pts; r.c1tags=c1r.tags;
      return r;
    }));
    res5.forEach(r=>{ done5++; if(r.status==='rejected') fail5++; });
    setProgress(55+(done5/enrich.length)*40,`${Math.min(enrich.length,i+BATCH5)}/${enrich.length} 5m`);
    await new Promise(r=>setTimeout(r,200));
  }

  if(fail5) logTo(`âš  Intraday failed for ${fail5} â€” showing with daily data`,'lwarn');
  else logTo('âœ“ Intraday enrichment complete','lok');

  ALL_RESULTS=allScored; // keep all for filter re-renders
  ALL_MARKET=market;
  ALL_FILTERS={minC13:fMinC13,minC1:fMinC1,minVol:fMinVol};
  renderCurrentResults();

  // Telegram scan summary
  const apFinal=allScored.filter(r=>r.c13>=5&&r.c1>=6);
  await sendScanSummary(apFinal);

  // BUG FIX: Pre-populate alreadyAlerted with stocks that were ALREADY READY at scan time.
  // Without this, the first monitor pass fires entry alerts for every A+ stock
  // that happened to be at READY status when the scan finished â€” even though the
  // user just saw them in the scan summary. Only NEW transitions (WAITINGâ†’READY)
  // discovered by the monitor should trigger an individual entry alert.
  const minRRval = parseFloat(document.getElementById('fMinRR')?.value) || 1.5;
  allScored.forEach(r => {
    if(r.entryStatus === 'READY') alreadyAlerted.add(getAlertKey(r));
  });
  const preAlerted = allScored.filter(r=>r.entryStatus==='READY').length;
  if(preAlerted) logTo(`â—ˆ ${preAlerted} stocks already at entry â€” monitor will alert on NEW pullbacks only`,'linfo');

  // Stats
  const entryReady=allScored.filter(r=>r.entryStatus==='READY');
  const close=allScored.filter(r=>r.entryStatus==='CLOSE');
  document.getElementById('s1').textContent=total;
  document.getElementById('s2').textContent=allScored.length;
  document.getElementById('s3').textContent=apFinal.length;
  document.getElementById('s4').textContent=entryReady.length;
  document.getElementById('s5').textContent=close.length;
  document.getElementById('s6').textContent=allScored.filter(r=>r.c13>=fMinC13).length;
  document.getElementById('s8').textContent=((Date.now()-t0)/1000).toFixed(1)+'s';

  setStep(2,allScored.length>0?'done':'active');
  if(entryReady.length>0){setStep(3,'done');setStep(4,'active');}
  else if(close.length>0) setStep(3,'active');
  if(monitorActive) setStep(5,'active');

  const el=((Date.now()-t0)/1000).toFixed(1);
  document.getElementById('scanStatus').textContent=`DONE â€” ${apFinal.length} A+ setups Â· ${entryReady.length} entry ready`;
  document.getElementById('scanStatus').style.color=apFinal.length>0?'var(--green)':'var(--text)';
  document.getElementById('scanTime').textContent=new Date().toLocaleTimeString();
  document.getElementById('footRight').textContent=`Last scan: ${new Date().toLocaleTimeString()} Â· ${apFinal.length} A+ Â· ${entryReady.length} entry ready`;
  document.getElementById('prog').classList.remove('on');
  btn.disabled=false; btn.textContent='â–¶ RESCAN';
  logTo(`âœ“ Scan complete in ${el}s â€” ${apFinal.length} A+ setups`, 'lok');
  autoSuggestPreset();
  // Show position sizer now that we have data
  document.getElementById('posSizer').style.display='block';
  updatePosSizer();
  updateHoursBanner();
  renderWatchlistPanel(); // refresh watchlist chips with latest prices
  gradeOpenAlerts(true);  // silently grade any open alerts using fresh prices
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function computeRankScore(r, mode){
  const vr=r.vr||0, chg=r.chgPct||0, gap=r.gapPct||0, abv=r.abvVWAP===true?1:0;
  const entryBonus=r.entryStatus==='READY'?1000:r.entryStatus==='CLOSE'?500:r.entryStatus==='EXTENDED'?200:0;
  if(mode==='momentum') return (r.c1*4)+(r.c13*1.5)+(Math.max(chg,0)*2)+(Math.max(gap,0)*1.2)+(vr*2)+(abv*1.5)+entryBonus;
  return (r.c13*4)+(r.c1*2)+(vr*1.6)+(abv*1)+(Math.max(gap,0)*0.6)+entryBonus;
}

function sigLabel(r){
  if(r.c13>=5&&r.c1>=6) return `<span class="badge-sig badge-ap">â­ A+</span>`;
  return `<span class="badge-sig badge-watch">â—ˆ WATCH</span>`;
}

function esLabel(s){
  if(s==='READY')    return `<span class="es es-now">âœ… ENTER NOW</span>`;
  if(s==='CLOSE')    return `<span class="es es-close">â³ CLOSE TO ENTRY</span>`;
  if(s==='EXTENDED') return `<span class="es es-wait">ğŸ“ˆ WAIT â€” EXTENDED</span>`;
  if(s==='CHASING')  return `<span class="es es-wait">âš  DO NOT CHASE</span>`;
  return `<span class="es es-hold">â³ WAITING</span>`;
}

function renderCurrentResults(){
  const apOnly=document.getElementById('fAplusOnly').checked;
  const entryOnly=document.getElementById('fEntryReady').checked;
  const mode=document.getElementById('modeMomentum').checked?'momentum':'structured';
  const minRR=parseFloat(document.getElementById('fMinRR')?.value)||0;
  const f=ALL_FILTERS||{minC13:3,minC1:4,minVol:0};
  if(!ALL_RESULTS||!ALL_RESULTS.length) return;
  renderAll(ALL_RESULTS, ALL_MARKET, f.minC13, f.minC1, f.minVol, minRR, apOnly, entryOnly, mode);
}

let expandedRow=null;

function renderAll(results, market, minC13, minC1, minVol, minRR, apOnly, entryOnly, mode){
  results.forEach(r=>{ r.rankScore=computeRankScore(r,mode); });

  let display=results.filter(r=>r.vr>=minVol);

  if(apOnly){
    display=display.filter(r=>r.c13>=5&&r.c1>=6);
  } else {
    display=display.filter(r=>r.c13>=minC13||r.c1>=minC1);
  }

  // Min R:R filter â€” applies to display table (Telegram already gated separately)
  if(minRR>0){
    display=display.filter(r=>!r.rr||r.rr>=minRR);  // pass if rr not yet calculated (non-enriched)
  }

  if(entryOnly){
    display=display.filter(r=>r.entryStatus==='READY');
  }

  display.sort((a,b)=>b.rankScore-a.rankScore);
  display.forEach((r,i)=>{ r.rankPos=i+1; });
  // Store the overall rank-1 stock â€” used by position sizer, immune to stat filters
  TOP_PICK = display[0] || null;

  const tableSection=document.getElementById('tableSection');
  const tableBody=document.getElementById('tableBody');
  const topPickEl=document.getElementById('tableTopPick');
  const emptyState=document.getElementById('emptyState');

  if(!display.length){
    tableSection.style.display='none';
    emptyState.style.display='block';
    emptyState.innerHTML=`
      <div class="empty-icon">ğŸ“­</div>
      <div style="font-size:11px;color:var(--dim);letter-spacing:.12em">NO QUALIFYING SETUPS</div>
      <div style="font-size:9px;color:var(--dim);margin-top:10px;line-height:2">
        ${entryOnly?'No stocks at entry zones right now â€” uncheck "ENTRY READY ONLY".<br>':''}
        ${minRR>0?`Min R:R ${minRR}x is filtering results â€” lower it or set to 0 to see all.<br>`:''}
        Try lowering Min C13 / Min C1, or reduce Min Vol.
      </div>`;
    return;
  }

  emptyState.style.display='none';
  tableSection.style.display='block';

  const best=display[0];
  topPickEl.innerHTML=buildTopPickHTML(best);

  tableBody.innerHTML=display.slice(0,40).map((r,idx)=> buildTableRow(r)).join('');
}

function buildTableRow(r){
    const trCls=(r.c13>=5&&r.c1>=6)?'tr-strong':(r.c1>=6?'tr-mom':'tr-norm');
    const entryReadyCls=r.entryStatus==='READY'?' tr-entry-ready':'';
    const chgColor=r.chgPct>=0?'var(--green)':'var(--red)';
    const rsiColor=r.rsi&&r.rsi>=40&&r.rsi<=65?'var(--green)':r.rsi&&r.rsi>65?'var(--red)':'var(--yellow)';
    const volColor=r.vr>=1.5?'var(--yellow)':r.vr>=1?'var(--text)':'var(--dim)';
    const blendScore=r.c13*4+r.c1*2;
    const blendColor=blendScore>=40?'var(--yellow)':blendScore>=24?'var(--accent)':'var(--dim)';
    const allTags=[...(r.c13tags||[]).slice(0,2).map(t=>`<span class="tag ${t.c}">C13: ${t.t}</span>`),
                   ...(r.c1tags||[]).slice(0,2).map(t=>`<span class="tag ${t.c}">C1: ${t.t}</span>`)].join('');

    return `<tr class="${trCls}${entryReadyCls}" id="tr-${r.sym}" onclick="toggleRowExpand('${r.sym}')">
      <td onclick="event.stopPropagation()" style="text-align:center;padding:0 4px">
        <button class="wl-star${WATCHLIST.has(r.sym)?' wl-on':''}" id="wl-${r.sym}"
          onclick="toggleWatchlist('${r.sym}')" title="Add to watchlist">
          ${WATCHLIST.has(r.sym)?'â˜…':'â˜†'}
        </button>
      </td>
      <td style="color:var(--dim);font-size:10px">${r.rankPos}</td>
      <td>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:17px;letter-spacing:.04em;color:${r.c13>=5&&r.c1>=6?'var(--yellow)':'var(--accent)'}">${r.sym}</div>
        <div style="font-size:8px;color:var(--dim)">${(r.name||'').slice(0,18)}</div>
      </td>
      <td>${sigLabel(r)}</td>
      <td style="text-align:right;font-weight:700">$${fmt2(r.price)}</td>
      <td style="text-align:right;color:${chgColor};font-weight:700">${fmtPct(r.chgPct)}</td>
      <td style="text-align:center;font-weight:700;color:${r.c13>=5?'var(--yellow)':'var(--dim)'}">${r.c13}/9</td>
      <td style="text-align:center;font-weight:700;color:${r.c1>=6?'var(--green)':'var(--dim)'}">${r.c1}/14</td>
      <td style="text-align:center;font-weight:700;color:${blendColor}">${blendScore}</td>
      <td style="text-align:right;color:${volColor}">${fmtX(r.vr)}</td>
      <td>${esLabel(r.entryStatus)}</td>
      <td style="font-size:10px">
        <span style="color:var(--accent)">$${fmt2(r.entryPrice)}</span>
        <span style="color:var(--dim)"> Â· </span>
        <span style="color:var(--red)">$${fmt2(r.stopLoss)}</span>
        <span style="color:var(--dim)"> Â· </span>
        <span style="color:var(--green)">$${fmt2(r.tp2)}</span>
        <span style="color:${r.rr>=2?'var(--green)':r.rr>=1.5?'var(--yellow)':'var(--red)'};font-size:9px;font-weight:700"> R:${fmt2(r.rr)}x</span>
      </td>
      <td>${allTags}</td>
    </tr>
    <tr id="exp-${r.sym}" class="expand-detail" style="display:none">
      <td colspan="12">
        <div class="exp-grid">
          <div class="exp-col">
            <div class="exp-lbl">EMA20</div><div class="exp-val">$${fmt2(r.ema20)}</div>
            <div class="exp-lbl" style="margin-top:8px">SMA20</div><div class="exp-val">$${fmt2(r.sma20)}</div>
          </div>
          <div class="exp-col">
            <div class="exp-lbl">EMA50</div><div class="exp-val">$${fmt2(r.ema50)}</div>
            <div class="exp-lbl" style="margin-top:8px">EMA200</div><div class="exp-val">$${fmt2(r.ema200)}</div>
          </div>
          <div class="exp-col">
            <div class="exp-lbl">VWAP</div><div class="exp-val">$${fmt2(r.vwap)}</div>
            <div class="exp-lbl" style="margin-top:8px">ATR14</div><div class="exp-val">$${fmt2(r.atr14)}</div>
          </div>
          <div class="exp-col">
            <div class="exp-lbl">RSI-14</div><div class="exp-val" style="color:${r.rsi&&r.rsi>=40&&r.rsi<=65?'var(--green)':'var(--yellow)'}">${r.rsi?r.rsi.toFixed(1):'â€”'}</div>
            <div class="exp-lbl" style="margin-top:8px">GAP%</div><div class="exp-val" style="color:${r.gapPct>=1?'var(--green)':'var(--dim)'}">${fmtPct(r.gapPct)}</div>
          </div>
          <div class="exp-col">
            <div class="exp-lbl">ABOVE VWAP</div>
            <div class="exp-val" style="color:${r.abvVWAP===true?'var(--green)':r.abvVWAP===false?'var(--red)':'var(--dim)'}">${r.abvVWAP===true?'YES âœ“':r.abvVWAP===false?'NO âœ—':'â€”'}</div>
            <div class="exp-lbl" style="margin-top:8px">VOL RATIO</div><div class="exp-val">${fmtX(r.vr)}</div>
          </div>
          <div class="exp-col" style="min-width:250px;flex:2">
            <div class="exp-lbl">ENTRY ANALYSIS</div>
            <div class="exp-reason" style="margin-top:4px;color:${r.entryStatus==='READY'?'var(--green)':r.entryStatus==='CLOSE'?'var(--yellow)':'var(--dim)'}">${r.entryReason}</div>
            <div style="margin-top:8px;font-size:9px;color:var(--dim)">
              All C13 signals: ${(r.c13tags||[]).map(t=>t.t).join(' Â· ')}<br>
              All C1 signals: ${(r.c1tags||[]).map(t=>t.t).join(' Â· ')}
            </div>
          </div>
        </div>
      </td>
    </tr>`;
}

function toggleRowExpand(sym){
  const expRow=document.getElementById('exp-'+sym);
  if(!expRow) return;
  const visible=expRow.style.display!=='none';
  // Close all
  document.querySelectorAll('[id^="exp-"]').forEach(el=>{ el.style.display='none'; });
  if(!visible) expRow.style.display='table-row';
}

function buildTopPickHTML(best){
  if(!best) return '';
  return `
    <div class="table-top-pick">
      <div style="display:flex;gap:24px;flex-wrap:wrap;align-items:flex-start">
        <div>
          <div style="font-size:10px;color:var(--yellow);letter-spacing:.18em;margin-bottom:6px">âœ… TOP PICK</div>
          <div style="font-size:22px;font-weight:900;letter-spacing:.04em">${best.sym}
            <span style="font-size:13px;color:var(--dim);font-weight:400"> ${best.name||''}</span>
          </div>
          <div style="margin-top:4px">${sigLabel(best)}
            <span style="color:var(--dim);font-size:11px;margin-left:8px">C13 ${best.c13}/9 Â· C1 ${best.c1}/14 Â· VOL ${fmtX(best.vr)} Â· ${fmtPct(best.chgPct)}</span>
          </div>
          <div style="margin-top:6px;font-size:9px;color:var(--dim)">${(best.c13tags||[]).slice(0,3).map(x=>x.t||x).join(' Â· ')}</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:4px">
          <div style="background:var(--card);border:1px solid var(--border);padding:8px 14px;font-size:12px">
            <div style="font-size:8px;color:var(--dim);letter-spacing:.12em;margin-bottom:3px">ENTRY</div>
            <div style="font-weight:700;color:var(--accent)">$${fmt2(best.entryPrice??best.price)}</div>
          </div>
          <div style="background:var(--card);border:1px solid var(--border);padding:8px 14px;font-size:12px">
            <div style="font-size:8px;color:var(--dim);letter-spacing:.12em;margin-bottom:3px">STOP LOSS</div>
            <div style="font-weight:700;color:var(--red)">$${fmt2(best.stopLoss)}</div>
          </div>
          <div style="background:var(--card);border:1px solid var(--border);padding:8px 14px;font-size:12px">
            <div style="font-size:8px;color:var(--dim);letter-spacing:.12em;margin-bottom:3px">TP1 (+1%)</div>
            <div style="font-weight:700;color:var(--green)">$${fmt2(best.tp1)}</div>
          </div>
          <div style="background:var(--card);border:1px solid var(--border);padding:8px 14px;font-size:12px">
            <div style="font-size:8px;color:var(--dim);letter-spacing:.12em;margin-bottom:3px">TP2 (+1.8%)</div>
            <div style="font-weight:700;color:var(--green)">$${fmt2(best.tp2)}</div>
          </div>
          <div style="font-size:10px;color:var(--dim)">R:R â‰ˆ ${fmt2(best.rr)}x</div>
        </div>
      </div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MONITOR (auto-rescan every 3 min, fires TG alerts)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleMonitor(){
  monitorActive=!monitorActive;
  const btn=document.getElementById('monBtn');
  const bar=document.getElementById('monBar');
  if(monitorActive){
    btn.textContent='â± 3:00 MONITORING'; btn.classList.add('active');
    bar.classList.add('on');
    setStep(5,'active');
    startMonitorCountdown();
    logTo('â± Auto-monitor every 3 min activated','linfo');
  } else {
    btn.textContent='â± AUTO MONITOR'; btn.classList.remove('active');
    bar.classList.remove('on');
    clearInterval(monCountTimer);
    setStep(5,'');
  }
}

function startMonitorCountdown(){
  monitorCountdown=180;
  clearInterval(monCountTimer);
  monCountTimer=setInterval(()=>{
    monitorCountdown--;
    const m=Math.floor(monitorCountdown/60), s=monitorCountdown%60;
    const btn=document.getElementById('monBtn');
    // Live countdown on the button itself
    if(btn && monitorActive) btn.textContent=`â± ${m}:${s.toString().padStart(2,'0')} MONITORING`;
    document.getElementById('monNext').textContent=`Next scan in ${m}:${s.toString().padStart(2,'0')}`;
    const apCount=ALL_RESULTS.filter(r=>r.c13>=5&&r.c1>=6).length;
    const wlCount=WATCHLIST.size;
    document.getElementById('monStatus').textContent=`Watching ${apCount} A+ + ${wlCount} watchlist stocksâ€¦`;
    if(monitorCountdown<=0){ clearInterval(monCountTimer); monitorScan(); }
  },1000);
}

async function monitorScan(){
  if(!monitorActive) return;
  logTo('ğŸ”„ Auto-monitor: checking entry conditionsâ€¦','linfo');
  cache5m={};
  const apStocks=ALL_RESULTS.filter(r=>r.c13>=5&&r.c1>=6);
  for(const r of apStocks){
    try{
      const m5=await yh5m(r.sym);
      const vwap=vwapFromCandles(m5.candles);
      r.vwap=vwap; r.price=m5.price||r.price;
      const ez=calcEntryZone(r.price,r.ema20,r.sma20,vwap,r.atr14);
      const prevStatus=r.entryStatus;
      r.entryStatus=ez.status; r.entryReason=ez.entryReason;
      r.entryPrice=ez.entryPrice;
      const lv=calcLevels(r.price,r.entryPrice,r.atr14,r.gapPct,r.nearestSupport);
      r.stopLoss=lv.stopLoss; r.tp1=lv.tp1; r.tp2=lv.tp2; r.rr=lv.rr;
      // Fire alert when newly entering READY zone
      if(r.entryStatus==='READY' && prevStatus!=='READY' && !alreadyAlerted.has(getAlertKey(r))){
        logTo(`â­ ${r.sym} â€” HIT ENTRY ZONE $${r.entryPrice?.toFixed(2)}! Sending Telegram alertâ€¦`,'lok');
        await sendEntryAlert(r);
        alreadyAlerted.add(getAlertKey(r));
      }
    }catch(e){ logTo(`âš  Monitor: ${r.sym} failed: ${e.message}`,'lwarn'); }
  }

  // â”€â”€ WATCHLIST MONITORING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Check watchlist stocks NOT already covered by the A+ scan above.
  // These fire a distinct "â˜… WATCHLIST ALERT" Telegram message.
  // Starred stocks are monitored regardless of C13/C1 score.
  const apSyms = new Set(apStocks.map(r=>r.sym));
  const wlExtra = [...WATCHLIST].filter(sym => !apSyms.has(sym));
  if(wlExtra.length){
    logTo(`â˜… Checking ${wlExtra.length} watchlist stock${wlExtra.length>1?'s':''} not in A+ scanâ€¦`,'linfo');
    for(const sym of wlExtra){
      try{
        const m5 = await yh5m(sym);
        // Use existing record from ALL_RESULTS if available (has 1D indicators)
        let r = ALL_RESULTS.find(x=>x.sym===sym);
        if(!r){
          // Not in main scan â€” fetch 1D data to build indicators
          const d1 = await yh1d(sym, 160);
          const em20=ema(d1.closes,20), sma20v=sma(d1.closes,20);
          const atr14v=atrFn(d1.highs,d1.lows,d1.closes,14)||d1.price*0.01;
          r={sym,name:sym,price:d1.price,chgPct:d1.chgPct,gapPct:d1.gapPct||0,
             ema20:em20,sma20:sma20v,atr14:atr14v,
             entryStatus:'WAITING',entryReason:'',entryPrice:d1.price,
             stopLoss:+(d1.price-atr14v*0.5).toFixed(2),rr:0,c13:0,c1:0,vr:1};
          ALL_RESULTS.push(r);
        }
        const vwap=vwapFromCandles(m5.candles);
        r.vwap=vwap; r.price=m5.price||r.price;
        r.abvVWAP=vwap?r.price>vwap:null;
        const ez=calcEntryZone(r.price,r.ema20,r.sma20,vwap,r.atr14);
        const prevStatus=r.entryStatus;
        r.entryStatus=ez.status; r.entryReason=ez.entryReason; r.entryPrice=ez.entryPrice;
        r.nearestSupport=ez.nearestSupport;
        const lv=calcLevels(r.price,r.entryPrice,r.atr14,r.gapPct,ez.nearestSupport);
        r.stopLoss=lv.stopLoss; r.tp1=lv.tp1; r.tp2=lv.tp2; r.rr=lv.rr;

        if(r.entryStatus==='READY' && prevStatus!=='READY' && !alreadyAlerted.has(getAlertKey(r))){
          logTo(`â˜… WATCHLIST: ${sym} hit entry $${r.entryPrice.toFixed(2)}! Sending alertâ€¦`,'lok');
          await sendWatchlistAlert(r);
          alreadyAlerted.add(getAlertKey(r));
        } else {
          const icon = r.entryStatus==='READY'?'âœ…':r.entryStatus==='CLOSE'?'â³':'â—ˆ';
          logTo(`${icon} WL ${sym} $${r.price.toFixed(2)} Â· ${r.entryStatus}${r.rr>0?' R:R '+r.rr.toFixed(1)+'x':''}`, 'linfo');
        }
      }catch(e){ logTo(`âš  WL ${sym}: ${e.message}`,'lwarn'); }
    }
  }
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  document.getElementById('scanTime').textContent=new Date().toLocaleTimeString();
  const entryReady=apStocks.filter(r=>r.entryStatus==='READY');
  if(entryReady.length){
    logTo(`âœ… ${entryReady.length} A+ stock(s) at entry: ${entryReady.map(r=>r.sym).join(', ')}`,'lok');
  } else {
    logTo(`â—ˆ Monitor: ${apStocks.length} A+ stocks â€” none at entry yet`,'linfo');
  }
  // Refresh stats + watchlist panel
  document.getElementById('s4').textContent=ALL_RESULTS.filter(r=>r.entryStatus==='READY').length;
  renderCurrentResults();
  renderWatchlistPanel();
  startMonitorCountdown();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANALYZE ANY TICKER (on-demand search at bottom)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function analyzeAnyTicker(){
  const inp=document.getElementById('anyTickerInput');
  const btn=document.getElementById('anyTickerBtn');
  const out=document.getElementById('anyTickerOut');
  const sym=(inp?.value||'').trim().toUpperCase();
  if(!sym) return;

  btn.disabled=true;
  out.innerHTML=`<div style="padding:14px;color:var(--dim);font-size:10px;letter-spacing:.1em">â³ ANALYZING ${sym}â€¦</div>`;

  try{
    // Use market state if already loaded, else quick check
    const mktObj = {bull:lastMarketOk, qqqBull:qqqChg>0, spyBull:spyChg>0, vixOk:true};

    const d1=await yh1d(sym);
    const price=d1.price;
    const chgPct=d1.chgPct||0, gapPct=d1.gapPct||0;
    const em20=ema(d1.closes,20), em50=ema(d1.closes,50), em200=ema(d1.closes,200);
    const rsiv=rsi14(d1.closes);
    const atr14=atrFn(d1.highs,d1.lows,d1.closes,14)||(price||1)*0.01;
    const av=avgVol(d1.volumes,20);
    const todayVol=d1.volumes?.at(-1)||0;
    const vr=av&&av>0?todayVol/av:1;
    const hi20=d1.highs.length>=20?Math.max(...d1.highs.slice(-20)):null;
    const room=hi20&&price?((hi20-price)/price*100):null;
    const sma20v=sma(d1.closes,20);
    const rs=chgPct-spyChg;

    let r={sym,name:'',price,gapPct,chgPct,vr,rsi:rsiv,ema20:em20,ema50:em50,ema200:em200,sma20:sma20v,atr14,room,vwap:null,abvVWAP:null,rs,
      entryStatus:'WAITING',entryReason:'Fetching 5mâ€¦',entryPrice:price,
      stopLoss:+(price-atr14*0.5).toFixed(2),tp1:+(price*1.010).toFixed(2),
      tp2:+(Math.max(price*1.018,price+atr14*2)).toFixed(2),rr:0,c13:0,c1:0,c13tags:[],c1tags:[]};

    const dObj0={price,chgPct,gapPct,vr,ema20:em20,ema50:em50,ema200:em200,rsi:rsiv,room,abvVWAP:null,rr:null,rs,marketBull:mktObj.bull};
    let c13r=scoreC13(dObj0,mktObj), c1r=scoreC1(dObj0);

    try{
      const m5=await yh5m(sym);
      const vwap=vwapFromCandles(m5.candles);
      r.vwap=vwap; r.price=m5.price||r.price;
      r.abvVWAP=vwap?r.price>vwap:null;
      r.vr=Math.max(r.vr,vSpike(m5.candles));
      const ez=calcEntryZone(r.price,r.ema20,r.sma20,vwap,r.atr14);
      r.entryStatus=ez.status; r.entryReason=ez.entryReason; r.entryPrice=ez.entryPrice;
      const lv=calcLevels(r.price,r.entryPrice,r.atr14,r.gapPct,r.nearestSupport);
      r.stopLoss=lv.stopLoss; r.tp1=lv.tp1; r.tp2=lv.tp2; r.rr=lv.rr;
      const dObj1={...dObj0,price:r.price,abvVWAP:r.abvVWAP,rr:r.rr};
      c13r=scoreC13(dObj1,mktObj); c1r=scoreC1(dObj1);
    }catch(e){ r.entryReason='Intraday unavailable â€” daily data only'; }

    r.c13=c13r.pts; r.c1=c1r.pts; r.c13tags=c13r.tags; r.c1tags=c1r.tags;

    const isAP=r.c13>=5&&r.c1>=6;
    const chgColor=r.chgPct>=0?'var(--green)':'var(--red)';
    const gapColor=r.gapPct>=1?'var(--green)':r.gapPct>=0.5?'var(--yellow)':'var(--dim)';
    const rsiColor=r.rsi&&r.rsi>=40&&r.rsi<=65?'var(--green)':r.rsi&&r.rsi>65?'var(--red)':'var(--yellow)';
    const volColor=r.vr>=1.5?'var(--yellow)':r.vr>=1?'var(--text)':'var(--dim)';

    const allTags=[...(r.c13tags||[]).map(t=>`<span class="tag ${t.c}">C13: ${t.t}</span>`),
                   ...(r.c1tags||[]).map(t=>`<span class="tag ${t.c}">C1: ${t.t}</span>`)].join('');

    out.innerHTML=`
      <div style="background:var(--card);border:1px solid ${isAP?'rgba(255,215,0,.3)':'var(--border)'};padding:16px 18px;margin-top:6px">
        <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:12px">
          <div>
            <div style="font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:.04em;color:${isAP?'var(--yellow)':'var(--accent)'}">${sym}</div>
            <div style="margin-top:4px">${sigLabel(r)} ${esLabel(r.entryStatus)}</div>
            <div style="font-size:9px;color:var(--dim);margin-top:4px">C13: ${r.c13}/9 Â· C1: ${r.c1}/14 Â· Vol: ${fmtX(r.vr)} Â· Chg: <span style="color:${chgColor}">${fmtPct(r.chgPct)}</span></div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <div style="background:var(--muted);border:1px solid var(--border);padding:8px 12px;font-size:11px">
              <div style="font-size:8px;color:var(--dim);margin-bottom:3px">ENTRY</div>
              <div style="color:var(--accent);font-weight:700">$${fmt2(r.entryPrice)}</div>
            </div>
            <div style="background:var(--muted);border:1px solid var(--border);padding:8px 12px;font-size:11px">
              <div style="font-size:8px;color:var(--dim);margin-bottom:3px">STOP LOSS</div>
              <div style="color:var(--red);font-weight:700">$${fmt2(r.stopLoss)}</div>
            </div>
            <div style="background:var(--muted);border:1px solid var(--border);padding:8px 12px;font-size:11px">
              <div style="font-size:8px;color:var(--dim);margin-bottom:3px">TP1</div>
              <div style="color:var(--green);font-weight:700">$${fmt2(r.tp1)}</div>
            </div>
            <div style="background:var(--muted);border:1px solid var(--border);padding:8px 12px;font-size:11px">
              <div style="font-size:8px;color:var(--dim);margin-bottom:3px">TP2</div>
              <div style="color:var(--green);font-weight:700">$${fmt2(r.tp2)}</div>
            </div>
            <div style="background:var(--muted);border:1px solid var(--border);padding:8px 12px;font-size:11px">
              <div style="font-size:8px;color:var(--dim);margin-bottom:3px">R:R</div>
              <div style="color:${r.rr>=2?'var(--green)':r.rr>=1.5?'var(--yellow)':'var(--dim)'};font-weight:700">${fmt2(r.rr)}x</div>
            </div>
          </div>
        </div>
        <div style="font-size:10px;color:${r.entryStatus==='READY'?'var(--green)':r.entryStatus==='CLOSE'?'var(--yellow)':'var(--dim)'};margin-bottom:10px;padding:8px 10px;background:var(--muted);border-left:2px solid ${r.entryStatus==='READY'?'var(--green)':'var(--border2)'}">
          ${r.entryReason}
        </div>
        <div style="display:flex;gap:16px;flex-wrap:wrap;font-size:9px;color:var(--dim);margin-bottom:10px">
          <span>EMA20: <b style="color:var(--text)">$${fmt2(r.ema20)}</b></span>
          <span>SMA20: <b style="color:var(--text)">$${fmt2(r.sma20)}</b></span>
          <span>VWAP: <b style="color:var(--text)">$${fmt2(r.vwap)}</b></span>
          <span>ATR14: <b style="color:var(--text)">$${fmt2(r.atr14)}</b></span>
          <span>RSI: <b style="color:${rsiColor}">${r.rsi?r.rsi.toFixed(1):'â€”'}</b></span>
          <span>Gap: <b style="color:${gapColor}">${fmtPct(r.gapPct)}</b></span>
          <span>VWAP pos: <b style="color:${r.abvVWAP===true?'var(--green)':r.abvVWAP===false?'var(--red)':'var(--dim)'}">${r.abvVWAP===true?'ABOVE âœ“':r.abvVWAP===false?'BELOW âœ—':'â€”'}</b></span>
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:3px">${allTags}</div>
      </div>`;

  }catch(e){
    out.innerHTML=`<div style="padding:14px;color:var(--red);font-size:10px">âš  Error analyzing ${sym}: ${e.message}</div>`;
  }finally{
    btn.disabled=false;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEATURE 1 â€” MARKET HOURS GUARD + DEV OVERRIDE
// ET times: Pre-market 4-9:30, Open 9:30-16:00,
// After-hours 16:00-20:00, Closed 20:00-4:00
// Dev override checkbox bypasses all guards for testing
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getETMinutes(){
  // Convert local time to ET (UTC-5 or UTC-4 DST)
  const now = new Date();
  const utc = now.getTime() + now.getTimezoneOffset() * 60000;
  const isDST = isDSTActive(now);
  const etOffset = isDST ? -4 * 3600000 : -5 * 3600000;
  const et = new Date(utc + etOffset);
  return {
    min: et.getHours() * 60 + et.getMinutes(),
    day: et.getDay(), // 0=Sun, 6=Sat
    et
  };
}

function isDSTActive(date){
  // DST: 2nd Sun March â†’ 1st Sun Nov
  const jan = new Date(date.getFullYear(), 0, 1).getTimezoneOffset();
  const jul = new Date(date.getFullYear(), 6, 1).getTimezoneOffset();
  return date.getTimezoneOffset() < Math.max(jan, jul);
}

function getMarketSession(){
  const {min, day} = getETMinutes();
  const isWeekend = day === 0 || day === 6;
  if(isWeekend) return 'weekend';
  if(min < 4*60)         return 'closed';    // midnightâ€“4am
  if(min < 9*60+30)      return 'premarket'; // 4:00â€“9:30
  if(min < 16*60)        return 'open';      // 9:30â€“16:00
  if(min < 20*60)        return 'afterhours';// 16:00â€“20:00
  return 'closed';                            // 20:00â€“midnight
}

function getNextOpenTime(){
  const {min, day, et} = getETMinutes();
  const isWeekend = day === 0 || day === 6;
  if(isWeekend){
    const daysUntilMon = day === 6 ? 2 : 1;
    return `Next open: Monday 9:30 AM ET (${daysUntilMon} day${daysUntilMon>1?'s':''})`;
  }
  if(min < 9*60+30){
    const mins = (9*60+30) - min;
    return `Market opens in ${Math.floor(mins/60)}h ${mins%60}m`;
  }
  if(min >= 16*60){
    return `Next open: Tomorrow 9:30 AM ET`;
  }
  return '';
}

function updateHoursBanner(){
  const bar = document.getElementById('hoursBar');
  const override = document.getElementById('devOverride').checked;
  const session = getMarketSession();
  const btn = document.getElementById('scanBtn');

  // Always show banner
  bar.style.display = 'flex';

  // Clear all state classes
  bar.className = '';
  bar.style.padding = '10px 16px';
  bar.style.marginBottom = '12px';
  bar.style.border = '1px solid';
  bar.style.borderRadius = '2px';
  bar.style.display = 'flex';
  bar.style.alignItems = 'center';
  bar.style.justifyContent = 'space-between';
  bar.style.flexWrap = 'wrap';
  bar.style.gap = '8px';

  const titles = {
    open:       ['ğŸŸ¢ MARKET OPEN',       '9:30 AM â€“ 4:00 PM ET â€” live prices, all features active', 'hours-open'],
    premarket:  ['ğŸŒ… PRE-MARKET',         '4:00 â€“ 9:30 AM ET â€” gap data available, use PRE-MARKET preset', 'hours-pre'],
    afterhours: ['ğŸŒ™ AFTER HOURS',        '4:00 â€“ 8:00 PM ET â€” prices stale, use for planning only', 'hours-after'],
    closed:     ['ğŸ”´ MARKET CLOSED',      'Outside trading hours â€” data is from last close', 'hours-closed'],
    weekend:    ['â¸ WEEKEND',             'Market closed â€” use Dev Override to test the scanner', 'hours-closed'],
  };

  const [title, desc, cls] = titles[session] || titles['closed'];
  document.getElementById('hoursTitle').textContent = override ? title + ' [DEV OVERRIDE ON]' : title;
  document.getElementById('hoursDesc').textContent  = override ? 'Guard bypassed â€” testing mode active' : desc;
  document.getElementById('hoursNextOpen').textContent = getNextOpenTime();
  bar.classList.add(cls);

  // Scan button state
  const canScan = override || session === 'open' || session === 'premarket' || session === 'afterhours';
  btn.disabled = !canScan && !ALL_RESULTS.length;

  // Auto-suggest matching preset
  if(!ALL_RESULTS.length){
    if(session === 'premarket') applyPreset('premarket');
    else if(session === 'afterhours') applyPreset('afterhours');
  }

  // Update preset staleness badges
  updatePresetStaleness();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEATURE 2 â€” POSITION SIZE CALCULATOR
// Uses account size + risk % + stop distance from
// the top-ranked READY stock (or first result)
// Updates live when account/risk inputs change
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updatePosSizer(){
  const account = parseFloat(document.getElementById('psAccount').value) || 0;
  const riskPct = parseFloat(document.getElementById('psRisk').value) || 1;
  const el = document.getElementById('psResult');
  if(!account || !ALL_RESULTS.length){ el.textContent='â€”'; return; }

  // TOP_PICK is set by renderAll every time the table renders â€” it's always rank #1.
  // This is the single source of truth. No re-sorting, no guessing.
  const source = TOP_PICK;
  if(!source || !source.entryPrice || !source.stopLoss){ el.textContent='â€”'; return; }

  const riskDollars = account * (riskPct / 100);
  const stopDist = source.entryPrice - source.stopLoss;
  if(stopDist <= 0){ el.innerHTML=`<span style="color:var(--red)">âš  Stop distance invalid for ${source.sym}</span>`; return; }

  const shares = Math.floor(riskDollars / stopDist);
  const totalCost = shares * source.entryPrice;
  const pctOfAccount = (totalCost / account) * 100;
  const rrColor = source.rr >= 2 ? 'var(--green)' : source.rr >= 1.5 ? 'var(--yellow)' : 'var(--red)';

  const sizeWarn = pctOfAccount > 25
    ? `<span style="color:var(--orange)"> âš  ${pctOfAccount.toFixed(0)}% of account â€” consider fewer shares</span>`
    : `<span style="color:var(--dim)"> (${pctOfAccount.toFixed(1)}% of account)</span>`;

  el.innerHTML = `
    <span style="color:var(--accent);font-weight:700">${source.sym}</span>
    <span style="color:var(--dim)"> Â· </span>
    <span style="color:var(--dim)">Risk </span><span style="color:var(--text)">$${riskDollars.toFixed(0)}</span>
    <span style="color:var(--dim)"> â†’ </span>
    <span style="color:var(--yellow);font-weight:700;font-size:13px">${shares} shares</span>
    <span style="color:var(--dim)"> @ $${source.entryPrice.toFixed(2)} = $${totalCost.toFixed(0)}</span>
    ${sizeWarn}
    <span style="color:var(--dim)"> Â· Stop $${source.stopLoss.toFixed(2)} Â· R:R </span>
    <span style="color:${rrColor};font-weight:700">${source.rr?.toFixed(1)||'â€”'}x</span>
    ${source.entryStatus !== 'READY' ? `<span style="color:var(--dim)"> Â· â³ ${source.entryStatus}</span>` : '<span style="color:var(--green)"> Â· âœ… READY</span>'}
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEATURE 3 â€” RESCAN ALERT DEDUP
// alreadyAlerted persists across rescans using the
// SYMBOL + entry price as a composite key.
// Only clears when price moves away and comes back.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Key format: "SYM@entryPrice" â€” e.g. "NVDA@142.30"
// This means if NVDA pulls back to 142.30 twice on
// the same day, second alert fires only if it left
// and came back (status was not READY in between).
function getAlertKey(r){
  return `${r.sym}@${r.entryPrice.toFixed(2)}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEATURE 4 â€” STRUCTURE-BASED STOP LOSS
// Instead of fixed 0.5Ã—ATR, stop is placed just below
// the nearest support level (EMA20, SMA20, or VWAP)
// with a small buffer (0.1Ã—ATR). More logical â€”
// stop is at a level that MEANS something on the chart.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcLevelsStructure(entryPrice, nearestSupport, atr14){
  // Stop just below the support level we're entering at
  const supportLevel = nearestSupport?.level || entryPrice;
  const buffer = atr14 * 0.10; // tiny buffer below support
  const stopLoss = +(supportLevel - buffer).toFixed(2);
  const tp1 = +(entryPrice * 1.010).toFixed(2);
  const tp2 = +(Math.max(entryPrice * 1.018, entryPrice + atr14 * 2)).toFixed(2);
  const reward = tp1 - entryPrice;
  const risk = entryPrice - stopLoss;
  const rr = risk > 0 ? +(reward / risk).toFixed(2) : 0;
  return {stopLoss, tp1, tp2, rr};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEATURE 5 â€” VOLUME TIME-OF-DAY ADJUSTMENT
// Volume at 9:45 AM looks inflated vs full-day average.
// Adjust by estimating what % of daily volume typically
// occurs by this time, then scale accordingly.
// Prevents false "high volume" signals at open.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getVolAdjustmentFactor(){
  const {min} = getETMinutes();
  const minsIntoDay = min - (9*60+30);
  if(minsIntoDay <= 0) return 1; // pre-market, no adjustment
  // Typical intraday volume curve (first 30 min = ~25% of daily)
  // Source: standard market microstructure U-curve
  const curve = [
    [15,  0.25], // 9:30â€“9:45: 25% of daily in 15 min
    [30,  0.35], // by 10:00: 35%
    [60,  0.45], // by 10:30: 45%
    [90,  0.52], // by 11:00: 52%
    [120, 0.58], // by 11:30: 58%
    [210, 0.72], // by 1:00: 72%
    [330, 0.88], // by 3:00: 88%
    [390, 1.00], // by 4:00: 100%
  ];
  for(const [m, pct] of curve){
    if(minsIntoDay <= m) return 1 / pct; // scale up to annualize
  }
  return 1;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEATURE 6 â€” WATCHLIST PERSISTENCE
// Star any stock to pin it. Survives page refresh.
// Stored in localStorage as a Set of symbols.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WL_KEY = 'alpha_watchlist_v1';

function loadWatchlist(){
  try { return new Set(JSON.parse(localStorage.getItem(WL_KEY)||'[]')); }
  catch(e){ return new Set(); }
}
function saveWatchlist(wl){
  try { localStorage.setItem(WL_KEY, JSON.stringify([...wl])); } catch(e){}
}

let WATCHLIST = loadWatchlist();

function toggleWatchlist(sym){
  if(WATCHLIST.has(sym)) WATCHLIST.delete(sym);
  else WATCHLIST.add(sym);
  saveWatchlist(WATCHLIST);
  // Update star in results table
  const btn = document.getElementById('wl-'+sym);
  if(btn){
    btn.textContent = WATCHLIST.has(sym) ? 'â˜…' : 'â˜†';
    btn.classList.toggle('wl-on', WATCHLIST.has(sym));
  }
  logTo(`${WATCHLIST.has(sym)?'â˜… Added':'â˜† Removed'} ${sym} ${WATCHLIST.has(sym)?'to':'from'} watchlist (${WATCHLIST.size} saved)`, 'linfo');
  renderWatchlistPanel();
}

function renderWatchlistPanel(){
  const chips = document.getElementById('wlChips');
  const count = document.getElementById('wlCount');
  if(!chips) return;

  count.textContent = `${WATCHLIST.size} stock${WATCHLIST.size!==1?'s':''} saved`;

  if(!WATCHLIST.size){
    chips.innerHTML = '<div class="wl-empty">Star any stock in the results table to save it here. Persists across page refreshes.</div>';
    return;
  }

  chips.innerHTML = [...WATCHLIST].map(sym => {
    // Pull live data from ALL_RESULTS if available
    const r = ALL_RESULTS.find(x => x.sym === sym);
    const priceStr  = r ? `$${r.price.toFixed(2)}` : 'â€”';
    const chgStr    = r ? `${r.chgPct>=0?'+':''}${r.chgPct.toFixed(2)}%` : '';
    const chgColor  = r ? (r.chgPct>=0?'var(--green)':'var(--red)') : 'var(--dim)';
    const esStr     = r?.entryStatus === 'READY'   ? 'âœ… READY' :
                      r?.entryStatus === 'CLOSE'   ? 'â³ CLOSE' :
                      r?.entryStatus === 'EXTENDED'? 'ğŸ“ˆ WAIT'  :
                      r?.entryStatus === 'CHASING' ? 'âš  CHASE' : 'â€”';
    const esColor   = r?.entryStatus === 'READY' ? 'var(--green)' :
                      r?.entryStatus === 'CLOSE' ? 'var(--yellow)' : 'var(--dim)';
    const c13str    = r ? `C13:${r.c13}/9` : '';
    const c1str     = r ? `C1:${r.c1}/14` : '';
    const rrStr     = r?.rr ? `R:R ${r.rr.toFixed(1)}x` : '';
    const rrColor   = r?.rr>=2?'var(--green)':r?.rr>=1.5?'var(--yellow)':'var(--dim)';

    return `
    <div class="wl-chip" onclick="highlightStock('${sym}')" title="Click to highlight in table">
      <div>
        <div style="display:flex;align-items:baseline;gap:6px">
          <span class="wl-chip-sym">${sym}</span>
          <span style="font-size:11px;color:var(--text)">${priceStr}</span>
          <span style="font-size:10px;color:${chgColor};font-weight:700">${chgStr}</span>
        </div>
        <div class="wl-chip-data">
          <span style="color:${esColor}">${esStr}</span>
          ${c13str ? `<span style="color:var(--dim)"> Â· </span><span>${c13str} ${c1str}</span>` : ''}
          ${rrStr  ? `<span style="color:var(--dim)"> Â· </span><span style="color:${rrColor}">${rrStr}</span>` : ''}
        </div>
      </div>
      <button class="wl-chip-remove" onclick="event.stopPropagation();removeFromWatchlist('${sym}')" title="Remove">âœ•</button>
    </div>`;
  }).join('');
}

function removeFromWatchlist(sym){
  WATCHLIST.delete(sym);
  saveWatchlist(WATCHLIST);
  const btn = document.getElementById('wl-'+sym);
  if(btn){ btn.textContent='â˜†'; btn.classList.remove('wl-on'); }
  renderWatchlistPanel();
}

function clearWatchlist(){
  if(!WATCHLIST.size) return;
  if(!confirm(`Remove all ${WATCHLIST.size} watchlist entries?`)) return;
  // Reset all stars in table
  WATCHLIST.forEach(sym => {
    const btn = document.getElementById('wl-'+sym);
    if(btn){ btn.textContent='â˜†'; btn.classList.remove('wl-on'); }
  });
  WATCHLIST.clear();
  saveWatchlist(WATCHLIST);
  renderWatchlistPanel();
}

function highlightStock(sym){
  // Scroll to the stock's row in the results table and flash it
  const row = document.getElementById('tr-'+sym);
  if(!row){
    logTo(`${sym} not in current scan results â€” try rescanning`, 'lwarn');
    return;
  }
  row.scrollIntoView({behavior:'smooth', block:'center'});
  row.style.transition='background .2s';
  row.style.background='rgba(255,215,0,.15)';
  setTimeout(()=>{ row.style.background=''; }, 1200);
}

async function rescanWatchlist(){
  if(!WATCHLIST.size){ logTo('Watchlist is empty','lwarn'); return; }

  const btn = document.querySelector('[onclick="rescanWatchlist()"]');
  if(btn){ btn.disabled=true; btn.textContent='â†º SCANNINGâ€¦'; }

  logTo(`â†º Rescanning ${WATCHLIST.size} watchlist stock${WATCHLIST.size>1?'s':''}â€¦`, 'linfo');

  // Ensure market data is available for scoring
  if(!ALL_MARKET) await checkMarket();
  const market = ALL_MARKET || {bull:true, qqqBull:true, spyBull:true, vixOk:true};

  const results = [];
  for(const sym of WATCHLIST){
    try{
      // Bust cache so we get fresh data
      delete cache1d[`${sym}_160`];
      delete cache5m[sym];

      const d1 = await yh1d(sym, 160);
      const em20  = ema(d1.closes,20);
      const em50  = ema(d1.closes,50);
      const em200 = ema(d1.closes,200);
      const rsiv  = rsi14(d1.closes);
      const atr14 = atrFn(d1.highs,d1.lows,d1.closes,14) || d1.price*0.01;
      const av    = avgVol(d1.volumes,20);
      const vr    = av&&av>0 ? (d1.volumes.at(-1)||0)/av : 1;
      const hi20  = d1.highs.length>=20 ? Math.max(...d1.highs.slice(-20)) : null;
      const room  = hi20&&d1.price ? ((hi20-d1.price)/d1.price*100) : null;
      const rs    = d1.chgPct - spyChg;
      const sma20v= sma(d1.closes,20);

      const dObj  = {price:d1.price,chgPct:d1.chgPct,gapPct:d1.gapPct,vr,ema20:em20,ema50:em50,ema200:em200,rsi:rsiv,room,abvVWAP:null,rr:null,rs,marketBull:market.bull};
      const c13r  = scoreC13(dObj, market);
      const c1r   = scoreC1(dObj);

      const r = {sym, name:sym, price:d1.price, chgPct:d1.chgPct, gapPct:d1.gapPct,
        vr, ema20:em20, sma20:sma20v, ema50:em50, ema200:em200, rsi:rsiv, atr14,
        c13:c13r.pts, c13tags:c13r.tags, c1:c1r.pts, c1tags:c1r.tags,
        entryStatus:'WAITING', entryReason:'', entryPrice:d1.price,
        stopLoss:+(d1.price-atr14*0.5).toFixed(2), rr:0};

      // Try to enrich with 5m intraday for VWAP + entry timing
      try{
        const m5 = await yh5m(sym);
        const vwap = vwapFromCandles(m5.candles);
        r.vwap = vwap;
        r.abvVWAP = vwap ? d1.price > vwap : null;
        const ez = calcEntryZone(d1.price, em20, sma20v, vwap, atr14);
        const lv = calcLevels(d1.price, ez.entryPrice, atr14, d1.gapPct, ez.nearestSupport);
        r.entryStatus = ez.status; r.entryReason = ez.entryReason;
        r.entryPrice  = ez.entryPrice; r.nearestSupport = ez.nearestSupport;
        r.stopLoss = lv.stopLoss; r.tp1 = lv.tp1; r.tp2 = lv.tp2; r.rr = lv.rr;
        r.vr = Math.max(r.vr, vSpike(m5.candles));
      }catch(e){ /* no 5m data â€” use 1D only */ }

      results.push(r);
      const esIcon = r.entryStatus==='READY'?'âœ…':r.entryStatus==='CLOSE'?'â³':'â—ˆ';
      logTo(`${esIcon} ${sym} $${d1.price.toFixed(2)} ${d1.chgPct>=0?'+':''}${d1.chgPct.toFixed(2)}% Â· C13:${r.c13}/9 C1:${r.c1}/14 Â· ${r.entryStatus}${r.rr>0?' R:R '+r.rr.toFixed(1)+'x':''}`, r.entryStatus==='READY'?'lok':'linfo');
    }catch(e){
      logTo(`âš  ${sym}: ${e.message}`, 'lwarn');
    }
  }

  // Merge results back into ALL_RESULTS so chips and table show live data
  results.forEach(fresh => {
    const idx = ALL_RESULTS.findIndex(x => x.sym === fresh.sym);
    if(idx >= 0) ALL_RESULTS[idx] = {...ALL_RESULTS[idx], ...fresh};
    else ALL_RESULTS.push(fresh);
  });

  renderWatchlistPanel();
  if(btn){ btn.disabled=false; btn.textContent='â†º RESCAN WATCHLIST'; }
  logTo(`âœ“ Watchlist rescan complete â€” ${results.length} stock${results.length!==1?'s':''} updated`, 'lok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRESET STALENESS â€” dim time-sensitive presets
// outside their valid time window
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Which presets are stale in which sessions:
const STALE_MAP = {
  // preset-key: sessions where it's stale/misleading
  'premarket':  ['open','afterhours','closed','weekend'],
  'breakout':   ['afterhours','closed','weekend','premarket'],
  'momentum':   ['afterhours','closed','weekend'],
  'best-entry': ['afterhours','closed','weekend'],
};

function updatePresetStaleness(){
  const session = getMarketSession();
  Object.entries(STALE_MAP).forEach(([key, staleSessions]) => {
    const btn = document.getElementById('preset-'+key);
    if(!btn) return;
    const isStale = staleSessions.includes(session);
    btn.classList.toggle('stale', isStale);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERFORMANCE TRACKER
// Logs every alert, grades outcomes at 4 PM ET,
// builds scorecard + breakdown analysis over time.
// All data in localStorage â€” persists across sessions.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PERF_KEY = 'alpha_perf_log_v1';

function perfLoad(){ try{ return JSON.parse(localStorage.getItem(PERF_KEY)||'[]'); }catch(e){ return []; } }
function perfSave(log){ try{ localStorage.setItem(PERF_KEY, JSON.stringify(log)); }catch(e){ logTo('âš  Alert log storage full','lwarn'); } }

// Called every time an entry alert fires
function logAlert(r){
  const log = perfLoad();
  // Get active preset name
  const activeBtn = document.querySelector('.preset-btn.active');
  const preset = activeBtn ? activeBtn.id.replace('preset-','') : 'manual';
  const session = getMarketSession();
  const hr = new Date().getHours();
  const timeSlot = hr < 10 ? 'pre-10am' : hr < 11 ? '10-11am' : hr < 12 ? '11am-noon' : hr < 14 ? 'noon-2pm' : 'after-2pm';

  const entry = {
    id: Date.now(),
    ts: new Date().toISOString(),
    date: new Date().toLocaleDateString(),
    time: new Date().toLocaleTimeString(),
    timeSlot,
    sym: r.sym,
    name: r.name || r.sym,
    preset,
    session,
    marketBull: lastMarketOk,
    entryPrice: r.entryPrice,
    stopLoss: r.stopLoss,
    tp1: r.tp1,
    tp2: r.tp2,
    rr: r.rr,
    c13: r.c13,
    c1: r.c1,
    vr: r.vr,
    chgPct: r.chgPct,
    outcome: 'open',   // open | tp1 | tp2 | stop | expired
    gradedPrice: null,
    gradedAt: null,
    pnlPts: null,
    actualRR: null,
  };

  log.push(entry);
  perfSave(log);
  renderAlertLog();
  renderScorecard();
  document.getElementById('perfGradeStatus').textContent = `${log.filter(x=>x.outcome==='open').length} open alerts`;
}

// Grade open alerts against current price
// Called: auto at 4PM ET, manually via GRADE NOW button, after each scan
async function gradeOpenAlerts(silent=false){
  const log = perfLoad();
  const open = log.filter(x => x.outcome === 'open');
  if(!open.length){
    if(!silent) logTo('â—ˆ No open alerts to grade', 'linfo');
    return;
  }
  if(!silent) logTo(`â–º Grading ${open.length} open alert(s)â€¦`, 'linfo');

  for(const entry of open){
    try{
      const d = await yh1d(entry.sym, 5); // last 5 days
      const price = d.price;
      const low   = Math.min(...d.lows.slice(-3));   // recent low
      const high  = Math.max(...d.highs.slice(-3));  // recent high

      let outcome = 'open';
      let gradedPrice = price;

      // Grade: did it hit TP2, TP1, stop, or still open?
      if(high >= entry.tp2){
        outcome = 'tp2';
        gradedPrice = entry.tp2;
      } else if(high >= entry.tp1){
        outcome = 'tp1';
        gradedPrice = entry.tp1;
      } else if(low <= entry.stopLoss){
        outcome = 'stop';
        gradedPrice = entry.stopLoss;
      } else {
        // Check if alert is older than 3 trading days â€” expire it
        const ageMs = Date.now() - entry.id;
        if(ageMs > 3 * 24 * 3600 * 1000) outcome = 'expired';
      }

      if(outcome !== 'open'){
        entry.outcome = outcome;
        entry.gradedPrice = gradedPrice;
        entry.gradedAt = new Date().toLocaleTimeString();
        const pnl = gradedPrice - entry.entryPrice;
        entry.pnlPts = +pnl.toFixed(2);
        const risk = entry.entryPrice - entry.stopLoss;
        entry.actualRR = risk > 0 ? +(pnl / risk).toFixed(2) : 0;
        if(!silent) logTo(`${outcome==='stop'?'ğŸ”´':'âœ…'} ${entry.sym} â†’ ${outcome.toUpperCase()} @ $${gradedPrice.toFixed(2)} (${pnl>=0?'+':''}${pnl.toFixed(2)} pts, R:R ${entry.actualRR}x)`, outcome==='stop'?'lwarn':'lok');
      }
    }catch(e){
      if(!silent) logTo(`âš  Grade failed for ${entry.sym}: ${e.message}`, 'lwarn');
    }
  }

  perfSave(log);
  renderAlertLog();
  renderScorecard();
  renderBreakdown();
  const stillOpen = log.filter(x=>x.outcome==='open').length;
  document.getElementById('perfGradeStatus').textContent = stillOpen ? `${stillOpen} open alerts` : 'All graded âœ“';
  if(!silent) logTo('âœ“ Grading complete', 'lok');
}

// Render alert log table
function renderAlertLog(){
  const log = perfLoad().reverse(); // newest first
  const body = document.getElementById('alertLogBody');
  const empty = document.getElementById('alertLogEmpty');
  if(!body) return;

  if(!log.length){
    body.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  const outcomeLabel = {
    open:    '<span class="al-outcome-open">â³ OPEN</span>',
    tp1:     '<span class="al-outcome-tp1">âœ… TP1 HIT</span>',
    tp2:     '<span class="al-outcome-tp2">ğŸš€ TP2 HIT</span>',
    stop:    '<span class="al-outcome-stop">ğŸ”´ STOPPED</span>',
    expired: '<span class="al-outcome-expired">â¸ EXPIRED</span>',
  };

  body.innerHTML = log.slice(0,100).map(e => {
    const pnlColor = e.pnlPts === null ? 'var(--dim)' : e.pnlPts >= 0 ? 'var(--green)' : 'var(--red)';
    const rrColor  = e.actualRR === null ? 'var(--dim)' : e.actualRR >= 1.5 ? 'var(--green)' : e.actualRR >= 0 ? 'var(--yellow)' : 'var(--red)';
    const rrDisp   = e.rr ? `<span style="color:${e.rr>=2?'var(--green)':e.rr>=1.5?'var(--yellow)':'var(--red)'}">${e.rr.toFixed(1)}x</span>` : 'â€”';
    return `<tr>
      <td style="color:var(--dim);font-size:9px;white-space:nowrap">${e.date}<br>${e.time}</td>
      <td><span style="font-family:'Bebas Neue',sans-serif;font-size:15px;color:var(--yellow)">${e.sym}</span></td>
      <td style="font-size:9px;color:var(--dim)">${e.preset}</td>
      <td style="text-align:right;font-weight:700">$${e.entryPrice.toFixed(2)}</td>
      <td style="text-align:right;color:var(--red)">$${e.stopLoss.toFixed(2)}</td>
      <td style="text-align:right;color:var(--dim)">$${e.tp1.toFixed(2)}</td>
      <td style="text-align:right;color:var(--green)">$${e.tp2.toFixed(2)}</td>
      <td style="text-align:center">${rrDisp}</td>
      <td style="text-align:center;color:${e.c13>=5?'var(--yellow)':'var(--dim)'}">${e.c13}/9</td>
      <td style="text-align:center;color:${e.c1>=6?'var(--green)':'var(--dim)'}">${e.c1}/14</td>
      <td style="text-align:right;color:${e.vr>=1.5?'var(--yellow)':'var(--dim)'}">${e.vr.toFixed(1)}x</td>
      <td style="text-align:center">${outcomeLabel[e.outcome]||'â€”'}</td>
      <td style="text-align:right;color:${pnlColor};font-weight:700">${e.pnlPts!==null?(e.pnlPts>=0?'+':'')+e.pnlPts:'â€”'}</td>
      <td style="text-align:right;color:${rrColor};font-weight:700">${e.actualRR!==null?e.actualRR+'x':'â€”'}</td>
      <td style="font-size:9px;color:var(--dim)">${e.gradedAt||'â€”'}</td>
    </tr>`;
  }).join('');
}

// Scorecard â€” aggregate stats
function renderScorecard(){
  const log = perfLoad().filter(x => x.outcome !== 'open' && x.outcome !== 'expired');
  const grid = document.getElementById('scGrid');
  const insights = document.getElementById('scInsights');
  if(!grid) return;

  const total   = log.length;
  const wins    = log.filter(x => x.outcome === 'tp1' || x.outcome === 'tp2').length;
  const tp2hits = log.filter(x => x.outcome === 'tp2').length;
  const stops   = log.filter(x => x.outcome === 'stop').length;
  const winRate = total > 0 ? Math.round(wins/total*100) : 0;
  const avgRR   = total > 0 ? (log.reduce((s,x)=>s+(x.actualRR||0),0)/total).toFixed(2) : 'â€”';
  const totalPnl = log.reduce((s,x)=>s+(x.pnlPts||0),0).toFixed(2);
  const open    = perfLoad().filter(x=>x.outcome==='open').length;
  const streak  = calcStreak(log);
  const bestTrade = log.reduce((b,x)=>(!b||x.pnlPts>b.pnlPts)?x:b, null);
  const worstTrade= log.reduce((b,x)=>(!b||x.pnlPts<b.pnlPts)?x:b, null);

  const winColor  = winRate>=60?'var(--green)':winRate>=50?'var(--yellow)':'var(--red)';
  const rrNumColor= avgRR>=1.5?'var(--green)':avgRR>=1?'var(--yellow)':'var(--red)';
  const pnlColor  = totalPnl>=0?'var(--green)':'var(--red)';

  const cards = [
    ['Win Rate', total>0?`${winRate}%`:'â€”', winColor],
    ['Graded', total, 'var(--text)'],
    ['Open', open, open>0?'var(--yellow)':'var(--dim)'],
    ['TP2 Hit %', total>0?`${Math.round(tp2hits/total*100)}%`:'â€”', 'var(--green)'],
    ['Stopped %', total>0?`${Math.round(stops/total*100)}%`:'â€”', stops>wins?'var(--red)':'var(--dim)'],
    ['Avg R:R', avgRR+'x', rrNumColor],
    ['Total P&L', (totalPnl>=0?'+':'')+totalPnl+' pts', pnlColor],
    ['Streak', streak.label, streak.color],
  ];

  grid.innerHTML = cards.map(([lbl,val,color])=>`
    <div class="sc-card">
      <div class="sc-num" style="color:${color}">${val}</div>
      <div class="sc-lbl">${lbl}</div>
    </div>`).join('');

  // Insights
  const insightLines = [];
  if(total >= 5){
    if(winRate >= 65) insightLines.push(`ğŸ”¥ Strong win rate (${winRate}%) â€” current settings are working well`);
    else if(winRate < 50) insightLines.push(`âš  Win rate below 50% (${winRate}%) â€” consider raising Min C13 or Min R:R threshold`);

    if(avgRR >= 1.8) insightLines.push(`âœ… Avg R:R ${avgRR}x is excellent â€” your setups have strong reward potential`);
    else if(avgRR < 1.2) insightLines.push(`âš  Avg R:R ${avgRR}x is low â€” consider tightening your stop or waiting for better entries`);

    if(tp2hits/total > 0.4) insightLines.push(`ğŸš€ ${Math.round(tp2hits/total*100)}% of trades hitting TP2 â€” your entries are well-timed`);

    if(bestTrade) insightLines.push(`ğŸ† Best trade: ${bestTrade.sym} +${bestTrade.pnlPts} pts (${bestTrade.actualRR}x R:R) on ${bestTrade.date}`);
    if(worstTrade && worstTrade.pnlPts < 0) insightLines.push(`ğŸ“‰ Worst trade: ${worstTrade.sym} ${worstTrade.pnlPts} pts on ${worstTrade.date}`);
  } else {
    insightLines.push(`Need ${5-total} more graded alert${5-total!==1?'s':''} to generate insights`);
  }
  insights.innerHTML = insightLines.join('<br>') || 'No insights yet';
}

function calcStreak(log){
  if(!log.length) return {label:'â€”', color:'var(--dim)'};
  let streak = 0, isWin = null;
  for(let i=log.length-1; i>=0; i--){
    const win = log[i].outcome==='tp1'||log[i].outcome==='tp2';
    if(isWin===null) isWin=win;
    if(win===isWin) streak++;
    else break;
  }
  if(isWin) return {label:`${streak}W ğŸ”¥`, color:'var(--green)'};
  return {label:`${streak}L`, color:streak>=3?'var(--red)':'var(--yellow)'};
}

// Breakdown â€” win rate by preset, time, C13, market
function renderBreakdown(){
  const log = perfLoad().filter(x => x.outcome !== 'open' && x.outcome !== 'expired');
  const empty = document.getElementById('bkEmpty');
  if(log.length < 5){
    if(empty) empty.style.display='block';
    ['bkPreset','bkTime','bkC13','bkMarket'].forEach(id=>{
      const el=document.getElementById(id); if(el) el.innerHTML='';
    });
    return;
  }
  if(empty) empty.style.display='none';

  const winRateGroup = (items) => {
    const wins = items.filter(x=>x.outcome==='tp1'||x.outcome==='tp2').length;
    return items.length > 0 ? Math.round(wins/items.length*100) : 0;
  };

  const renderBars = (groups, containerId) => {
    const el = document.getElementById(containerId);
    if(!el) return;
    const sorted = Object.entries(groups).sort((a,b)=>b[1].rate-a[1].rate);
    el.innerHTML = sorted.map(([lbl,{rate,n}]) => {
      const color = rate>=65?'var(--green)':rate>=50?'var(--yellow)':'var(--red)';
      return `<div class="bk-bar-row">
        <div class="bk-bar-lbl">${lbl}</div>
        <div class="bk-bar-bg"><div class="bk-bar-fill" style="width:${rate}%;background:${color}"></div></div>
        <div class="bk-bar-pct" style="color:${color}">${rate}% <span style="color:var(--dim);font-size:8px">(${n})</span></div>
      </div>`;
    }).join('');
  };

  // By preset
  const byPreset = {};
  log.forEach(x=>{
    if(!byPreset[x.preset]) byPreset[x.preset]={items:[]};
    byPreset[x.preset].items.push(x);
  });
  renderBars(Object.fromEntries(Object.entries(byPreset).map(([k,v])=>[k,{rate:winRateGroup(v.items),n:v.items.length}])), 'bkPreset');

  // By time slot
  const byTime = {};
  log.forEach(x=>{
    if(!byTime[x.timeSlot]) byTime[x.timeSlot]={items:[]};
    byTime[x.timeSlot].items.push(x);
  });
  renderBars(Object.fromEntries(Object.entries(byTime).map(([k,v])=>[k,{rate:winRateGroup(v.items),n:v.items.length}])), 'bkTime');

  // By C13 score
  const byC13 = {'C13 â‰¤3':[],'C13 4-5':[],'C13 6-7':[],'C13 8-9':[]};
  log.forEach(x=>{
    if(x.c13<=3) byC13['C13 â‰¤3'].push(x);
    else if(x.c13<=5) byC13['C13 4-5'].push(x);
    else if(x.c13<=7) byC13['C13 6-7'].push(x);
    else byC13['C13 8-9'].push(x);
  });
  renderBars(Object.fromEntries(Object.entries(byC13).filter(([,v])=>v.length).map(([k,v])=>[k,{rate:winRateGroup(v),n:v.length}])), 'bkC13');

  // By market condition
  const byMarket = {'Bull Market':log.filter(x=>x.marketBull), 'Bear/Mixed':log.filter(x=>!x.marketBull)};
  renderBars(Object.fromEntries(Object.entries(byMarket).filter(([,v])=>v.length).map(([k,v])=>[k,{rate:winRateGroup(v),n:v.length}])), 'bkMarket');
}

// Export to CSV
function exportCSV(){
  const log = perfLoad();
  if(!log.length){ logTo('No alerts to export','lwarn'); return; }
  const headers = ['Date','Time','Symbol','Preset','Market','Entry','Stop','TP1','TP2','RR','C13','C1','Vol','Outcome','PnL_pts','Actual_RR','Graded_At'];
  const rows = log.map(e=>[
    e.date, e.time, e.sym, e.preset, e.marketBull?'Bull':'Bear',
    e.entryPrice, e.stopLoss, e.tp1, e.tp2, e.rr,
    e.c13, e.c1, e.vr?.toFixed(2)||'',
    e.outcome, e.pnlPts??'', e.actualRR??'', e.gradedAt||''
  ].map(v=>`"${v}"`).join(','));
  const csv = [headers.join(','), ...rows].join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = `alpha_alerts_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  logTo(`âœ“ Exported ${log.length} alerts to CSV`, 'lok');
}

function clearAlertLog(){
  const log = perfLoad();
  if(!log.length) return;
  if(!confirm(`Delete all ${log.length} alert records? This cannot be undone.`)) return;
  localStorage.removeItem(PERF_KEY);
  renderAlertLog(); renderScorecard(); renderBreakdown();
  logTo('Alert log cleared', 'lwarn');
}

function perfTab(tab){
  document.querySelectorAll('.perf-tab').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.perf-section').forEach(s=>s.classList.remove('active'));
  document.getElementById('perf-'+tab).classList.add('active');
  event.target.classList.add('active');
  if(tab==='scorecard') renderScorecard();
  if(tab==='breakdown') renderBreakdown();
}

// Auto-grade at 4 PM ET daily
function scheduleAutoGrade(){
  const {min, day} = getETMinutes();
  const isWeekday = day >= 1 && day <= 5;
  const closeMin = 16 * 60; // 4:00 PM ET
  if(isWeekday && min >= closeMin && min < closeMin + 30){
    // We're in the 4:00â€“4:30 PM window â€” grade now
    const lastGrade = localStorage.getItem('alpha_last_grade');
    const today = new Date().toDateString();
    if(lastGrade !== today){
      localStorage.setItem('alpha_last_grade', today);
      logTo('ğŸ”” Market closed â€” auto-grading open alertsâ€¦', 'linfo');
      gradeOpenAlerts(false);
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STAT CARD CLICK FILTER
// Clicking a stat card jumps to that view instantly.
// Clicking again or clicking Candidates resets to normal.
// Does NOT change preset â€” just a temporary view filter.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let activeStatFilter = null;

function filterByStat(type){
  // Toggle off if already active
  if(activeStatFilter === type){
    activeStatFilter = null;
    document.querySelectorAll('.stat').forEach(s => s.classList.remove('stat-active'));
    logTo('â—ˆ Stat filter cleared â€” showing all results', 'linfo');
    renderCurrentResults();
    return;
  }

  if(!ALL_RESULTS.length){ logTo('Run a scan first','lwarn'); return; }

  activeStatFilter = type;

  // Highlight active stat card
  document.querySelectorAll('.stat').forEach(s => s.classList.remove('stat-active'));
  const statMap = {all:'s2', aplus:'s3', ready:'s4', close:'s5', c13:'s6'};
  document.getElementById(statMap[type])?.closest('.stat')?.classList.add('stat-active');

  // Scroll to table
  document.getElementById('tableSection')?.scrollIntoView({behavior:'smooth', block:'start'});

  // Apply temp filter on top of current results
  const mode = document.getElementById('modeMomentum').checked ? 'momentum' : 'structured';
  const fC13  = parseInt(document.getElementById('fC13').value) || 0;
  const fC1   = parseInt(document.getElementById('fC1').value) || 0;
  const fVol  = parseFloat(document.getElementById('fVol').value) || 0;
  const minRR = parseFloat(document.getElementById('fMinRR').value) || 0;

  let filtered = [...ALL_RESULTS];
  let label = '';

  switch(type){
    case 'all':
      // All candidates â€” just apply standard vol/score filters
      filtered = filtered.filter(r => r.vr >= fVol && (r.c13 >= fC13 || r.c1 >= fC1));
      label = 'All candidates';
      break;
    case 'aplus':
      filtered = filtered.filter(r => r.c13 >= 5 && r.c1 >= 6);
      label = 'A+ setups (C13â‰¥5 AND C1â‰¥6)';
      break;
    case 'ready':
      filtered = filtered.filter(r => r.entryStatus === 'READY');
      label = 'Entry Ready NOW';
      break;
    case 'close':
      filtered = filtered.filter(r => r.entryStatus === 'CLOSE');
      label = 'Close to Entry';
      break;
    case 'c13':
      filtered = filtered.filter(r => r.c13 >= fC13);
      label = `C13 Qualified (â‰¥${fC13})`;
      break;
  }

  // Sort by rank score
  filtered.forEach(r => { r.rankScore = computeRankScore(r, mode); });
  filtered.sort((a,b) => b.rankScore - a.rankScore);

  const tableSection = document.getElementById('tableSection');
  const tableBody    = document.getElementById('tableBody');
  const topPickEl    = document.getElementById('tableTopPick');
  const emptyState   = document.getElementById('emptyState');

  logTo(`ğŸ” Showing: ${label} â€” ${filtered.length} stocks (click stat again to clear)`, 'linfo');

  if(!filtered.length){
    tableSection.style.display = 'none';
    emptyState.style.display = 'block';
    emptyState.innerHTML = `
      <div class="empty-icon">ğŸ“­</div>
      <div style="font-size:11px;color:var(--dim);letter-spacing:.12em">NO ${label.toUpperCase()} RIGHT NOW</div>
      <div style="font-size:9px;color:var(--dim);margin-top:8px">Click the stat card again to clear this filter</div>`;
    return;
  }

  emptyState.style.display = 'none';
  tableSection.style.display = 'block';
  topPickEl.innerHTML = buildTopPickHTML(filtered[0]);

  // Reuse the same row renderer from renderAll
  filtered.slice(0,40).forEach((r,i) => { r.rankPos = i+1; });
  tableBody.innerHTML = filtered.slice(0,40).map(r => buildTableRow(r)).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRESETS â€” one-click strategy configs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PRESETS = {
  'balanced': {
    label: 'âš– BALANCED',
    desc: 'Balanced: good mix of A+ setups + entry timing â€” best for most days',
    gap: 0, c13: 4, c1: 5, vol: 1.1, minRR: 1.5,
    apOnly: false, entryReady: false, momentum: false, skipBad: false,
    tip: 'C13â‰¥4 + C1â‰¥5 + Volâ‰¥1.1x â€” catches the best longs without being too strict. Start here every day.'
  },
  'best-entry': {
    label: 'âœ… BEST ENTRIES',
    desc: 'Best Entries: only stocks AT or very close to EMA20/VWAP â€” ready to buy now',
    gap: 0, c13: 3, c1: 4, vol: 1.0, minRR: 1.5,
    apOnly: false, entryReady: true, momentum: false, skipBad: false,
    tip: 'Entry Ready filter ON â€” only shows stocks already pulled back to support. These are the ones to act on immediately.'
  },
  'aplus': {
    label: 'â­ A+ STRICT',
    desc: 'A+ Strict: only highest-conviction setups â€” C13â‰¥5 AND C1â‰¥6, both models agree',
    gap: 0, c13: 5, c1: 6, vol: 1.2, minRR: 1.5,
    apOnly: true, entryReady: false, momentum: false, skipBad: false,
    tip: 'Fewest alerts (3â€“5) but highest quality. Both trend AND momentum models must agree. Best for sizing up.'
  },
  'momentum': {
    label: 'ğŸ”¥ MOMENTUM',
    desc: 'Momentum Sniper: fast movers, volume spikes, breakouts â€” works 9:30â€“11:00 AM',
    gap: 0.3, c13: 2, c1: 5, vol: 1.5, minRR: 1.2,
    apOnly: false, entryReady: false, momentum: true, skipBad: false,
    tip: 'Low C13 threshold + high volume bar â€” finds fast-moving stocks early. Best in first 90 minutes of market open.'
  },
  'bull': {
    label: 'ğŸ‚ BULL DAY',
    desc: 'Bull Day: QQQ+SPY green, VIX<20 â€” take your best A+ setups confidently',
    gap: 0, c13: 4, c1: 5, vol: 1.1, minRR: 1.5,
    apOnly: false, entryReady: false, momentum: false, skipBad: true,
    tip: 'Same as Balanced but SKIP ON BAD MARKET is ON â€” only runs when conditions are ideal. Max confidence setups.'
  },
  'bear': {
    label: 'ğŸ» BEAR / RS DAY',
    desc: 'Bear/RS Day: market is red â€” find stocks with strong relative strength vs SPY',
    gap: 0, c13: 2, c1: 4, vol: 1.0, minRR: 1.5,
    apOnly: false, entryReady: false, momentum: false, skipBad: false,
    tip: 'Lower C13 threshold because bearish market removes 2pts. Finds stocks holding up or going UP while market sells off â€” these are the real leaders.'
  },
  'premarket': {
    label: 'ğŸŒ… PRE-MARKET',
    desc: 'Pre-Market: use BEFORE 9:30 AM â€” finds gapped stocks to watch at open. No entry yet, just building your watchlist.',
    gap: 0.5, c13: 3, c1: 4, vol: 1.5, minRR: 1.5,
    apOnly: false, entryReady: false, momentum: false, skipBad: false,
    tip: 'Gapâ‰¥0.5% + Volâ‰¥1.5x â€” these stocks gapped up overnight with volume confirming. Add them to your watchlist. Wait for market open + first 5min candle to close before entering.',
    timeHint: 'Best used: Before 9:30 AM ET'
  },
  'breakout': {
    label: 'ğŸš€ MORNING BREAKOUT',
    desc: 'Morning Breakout: use 9:30â€“10:30 AM â€” finds stocks making the first big move of the day on high volume.',
    gap: 0.3, c13: 3, c1: 6, vol: 2.0, minRR: 1.5,
    apOnly: false, entryReady: false, momentum: true, skipBad: false,
    tip: 'Volâ‰¥2.0x is the key â€” real breakouts need massive volume. C1â‰¥6 ensures strong momentum. Momentum Mode ON ranks fastest movers first. These often do NOT pull back to EMA20 â€” buy the breakout or miss it.',
    timeHint: 'Best used: 9:30â€“10:30 AM ET only'
  },
  'afterhours': {
    label: 'ğŸŒ™ AFTER HOURS',
    desc: 'After Hours: 4â€“8 PM ET â€” review today\'s setups, plan tomorrow\'s watchlist. Prices are stale.',
    gap: 0, c13: 3, c1: 4, vol: 0.8, minRR: 1.3,
    apOnly: false, entryReady: false, momentum: false, skipBad: false,
    tip: 'Lower vol threshold (0.8x) â€” after-hours volume is thin. Use to review which stocks held structure today and star them for tomorrow. Do NOT enter trades from these signals.',
    timeHint: 'Best used: 4:00â€“8:00 PM ET'
  }
};

function applyPreset(key){
  const p = PRESETS[key];
  if(!p) return;
  document.getElementById('fGap').value    = p.gap;
  document.getElementById('fC13').value    = p.c13;
  document.getElementById('fC1').value     = p.c1;
  document.getElementById('fVol').value    = p.vol;
  document.getElementById('fMinRR').value  = p.minRR ?? 1.5;
  document.getElementById('fAplusOnly').checked   = p.apOnly;
  document.getElementById('fEntryReady').checked  = p.entryReady;
  document.getElementById('modeMomentum').checked = p.momentum;
  document.getElementById('fGoodMarket').checked  = p.skipBad;
  // Update active state
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('preset-'+key)?.classList.add('active');
  // Show desc + time hint
  const hint = p.timeHint ? ` Â· â° ${p.timeHint}` : '';
  document.getElementById('presetDesc').textContent = p.desc + hint;
  // Remember last used preset across sessions
  try { localStorage.setItem('alpha_last_preset', key); } catch(e){}
  // Show tip + re-render immediately if scan data exists â€” no rescan needed
  if(ALL_RESULTS.length){
    logTo(`ğŸ’¡ Preset "${p.label}"${p.timeHint?' ['+p.timeHint+']':''}: ${p.tip}`, 'linfo');
    renderCurrentResults();
  } else {
    logTo(`ğŸ’¡ Preset "${p.label}" ready â€” press SCAN NOW${p.timeHint?' ('+p.timeHint+')':''}`, 'linfo');
    document.getElementById('log').classList.add('on');
  }
}

// Auto-suggest best preset based on market + time of day after scan
function autoSuggestPreset(){
  if(!ALL_MARKET) return;
  const {qqqBull, spyBull, vixOk} = ALL_MARKET;
  const hr = new Date().getHours();
  const min = new Date().getMinutes();
  const etMin = hr * 60 + min; // rough â€” assumes local = ET or close
  const preMarket  = etMin < 9*60+30;           // before 9:30
  const earlyOpen  = etMin >= 9*60+30 && etMin < 10*60+30; // 9:30â€“10:30
  const midDay     = etMin >= 10*60+30;

  if(preMarket){
    document.getElementById('presetDesc').textContent = 'â° Pre-market hours â€” try ğŸŒ… PRE-MARKET preset to build your gap watchlist for open';
  } else if(earlyOpen && (qqqBull || spyBull)){
    document.getElementById('presetDesc').textContent = 'â° Market open â€” try ğŸš€ MORNING BREAKOUT (first 60min) or âœ… BEST ENTRIES for pullback plays';
  } else if(qqqBull && spyBull && vixOk){
    document.getElementById('presetDesc').textContent = 'ğŸ’¡ Market BULLISH â€” try â­ A+ STRICT or ğŸ‚ BULL DAY for highest conviction plays';
  } else if(!qqqBull && !spyBull){
    document.getElementById('presetDesc').textContent = 'ğŸ’¡ Market BEARISH â€” use ğŸ» BEAR / RS DAY to find stocks outperforming the selloff';
  } else {
    document.getElementById('presetDesc').textContent = 'ğŸ’¡ Mixed market â€” âš– BALANCED or âœ… BEST ENTRIES (only trade what\'s at support right now)';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEPTH SLIDER label sync
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEPTH_LABELS = ['FASTÂ·12','NORMALÂ·24','FULLÂ·40'];
const DEPTH_TIPS   = [
  'Fast: top 12 get 5m VWAP data â€” ~6s. Best for quick morning check.',
  'Normal: top 24 get 5m data â€” ~10s. Best balance of speed + accuracy.',
  'Full: top 40 get 5m data â€” ~16s. Most complete picture, use when time allows.',
];
function syncDepthLabel(){
  const v = parseInt(document.getElementById('enrichSlider').value);
  const el = document.getElementById('depthLabel');
  if(el){ el.textContent = DEPTH_LABELS[v]; el.title = DEPTH_TIPS[v]; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT â€” wire up live filter re-renders
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
['fAplusOnly','fEntryReady','modeMomentum','fC13','fC1','fVol','fMinRR'].forEach(id=>{
  document.getElementById(id)?.addEventListener('change',()=>{
    document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('presetDesc').textContent = 'Custom filters â€” click a preset to reset';
    renderCurrentResults();
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STARTUP PRESET â€” smart default on page load
// Priority: 1) session-specific (pre-market/after-hours)
//           2) last preset you used (remembered in localStorage)
//           3) BALANCED fallback
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pickStartupPreset(){
  const session = getMarketSession();

  // Session-specific overrides â€” these always win
  if(session === 'premarket'){
    applyPreset('premarket');
    return;
  }
  if(session === 'afterhours' || session === 'closed' || session === 'weekend'){
    applyPreset('afterhours');
    return;
  }

  // Market is open â€” restore last used preset if valid
  try{
    const last = localStorage.getItem('alpha_last_preset');
    // Don't restore time-locked presets during market hours
    const openSkip = ['premarket', 'afterhours'];
    if(last && PRESETS[last] && !openSkip.includes(last)){
      applyPreset(last);
      return;
    }
  }catch(e){}

  // Default: BALANCED
  applyPreset('balanced');
}

syncDepthLabel();
refreshProxyUI();
syncTGUI();
pickStartupPreset();          // smart preset before banner so filters are right
updateHoursBanner();
setInterval(() => { updateHoursBanner(); scheduleAutoGrade(); }, 60000);
renderWatchlistPanel();
renderAlertLog();
renderScorecard();
gradeOpenAlerts(true);
</script>
</body>
</html>
