<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NDX100 â€” Trading Scanner Suite</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
/* â”€â”€ Base â”€â”€ */
:root{
  --bg:#04070a;--card:#070d12;--border:#0d1f2d;
  --green:#00ff88;--red:#ff3355;--yellow:#ffd700;
  --accent:#00d4ff;--purple:#c084fc;--orange:#fb923c;
  --dim:#3a5a6a;--text:#ddeeff;--muted:#1a3040;
  --mono:'JetBrains Mono',monospace;
  /* swing palette */
  --sg:#00e5a0;--sr:#ff3d6b;--sy:#fbbf24;--sp:#c084fc;--sb:#38bdf8;
  --sdim:#334d65;--sbright:#c8ddef;
  --surf:#0c1018;--surf2:#111722;--surf3:#161e2e;--bord2:#223040;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:var(--mono);min-height:100vh}
.gridbg{position:fixed;inset:0;pointer-events:none;z-index:0;opacity:.15;
  background-image:linear-gradient(rgba(0,212,255,.22) 1px,transparent 1px),
  linear-gradient(90deg,rgba(0,212,255,.22) 1px,transparent 1px);background-size:40px 40px}
.wrap{max-width:1420px;margin:0 auto;padding:20px;position:relative;z-index:1}

/* â”€â”€ Tabs â”€â”€ */
.tabs{display:flex;border-bottom:2px solid var(--border);margin-bottom:0}
.tab-btn{font-family:'Bebas Neue',sans-serif;font-size:17px;letter-spacing:.12em;
  padding:13px 30px;border:none;background:transparent;color:var(--dim);
  cursor:pointer;border-bottom:3px solid transparent;margin-bottom:-2px;transition:all .2s}
.tab-btn:hover{color:var(--text)}
.td{color:var(--accent);border-bottom-color:var(--accent) !important}
.ts{color:var(--red);border-bottom-color:var(--red) !important}
.tw{color:var(--sg);border-bottom-color:var(--sg) !important}
.tab-panel{display:none;padding-top:22px}
.tab-panel.active{display:block}

/* â”€â”€ Headers â”€â”€ */
.hdr{display:flex;justify-content:space-between;align-items:flex-end;
  border-bottom:1px solid var(--border);padding-bottom:16px;margin-bottom:18px}
.sub{font-size:9px;color:var(--dim);letter-spacing:.2em;margin-top:5px;text-transform:uppercase}
.hdr-right{display:flex;flex-direction:column;align-items:flex-end;gap:8px}
.title-d{font-family:'Bebas Neue',sans-serif;font-size:44px;line-height:1;letter-spacing:.05em;
  background:linear-gradient(135deg,var(--accent),var(--green));-webkit-background-clip:text;background-clip:text;color:transparent}
.title-s{font-family:'Bebas Neue',sans-serif;font-size:44px;line-height:1;letter-spacing:.05em;
  background:linear-gradient(135deg,var(--red),var(--orange));-webkit-background-clip:text;background-clip:text;color:transparent}
.title-w{font-family:'Bebas Neue',sans-serif;font-size:44px;line-height:1;letter-spacing:.04em;
  color:var(--sg);text-shadow:0 0 40px rgba(0,229,160,.2)}

/* â”€â”€ Buttons â”€â”€ */
.btn-d{font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:.12em;
  background:var(--green);color:#000;border:none;padding:12px 32px;cursor:pointer;transition:all .2s;box-shadow:0 0 24px rgba(0,255,136,.25)}
.btn-d:hover{background:#00ffaa}.btn-d:disabled{background:var(--muted);color:var(--dim);cursor:not-allowed;box-shadow:none}
.btn-s{font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:.12em;
  background:var(--red);color:#fff;border:none;padding:12px 32px;cursor:pointer;transition:all .2s;box-shadow:0 0 24px rgba(255,51,85,.25)}
.btn-s:hover{background:#ff5577}.btn-s:disabled{background:var(--muted);color:var(--dim);cursor:not-allowed;box-shadow:none}
.btn-w{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:.12em;
  background:var(--sg);color:#001a0d;border:none;padding:14px 36px;border-radius:4px;cursor:pointer;transition:all .2s;box-shadow:0 0 30px rgba(0,229,160,.2)}
.btn-w:hover{background:#00ffb3}.btn-w:disabled{background:var(--surf3);color:var(--sdim);cursor:not-allowed;box-shadow:none}

/* â”€â”€ Market status â”€â”€ */
.mstat{display:flex;align-items:center;gap:7px;font-size:10px}
.mdot{width:7px;height:7px;border-radius:50%;animation:blink 2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.25}}

/* â”€â”€ Legend / criteria â”€â”€ */
.legend{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
.leg{display:flex;align-items:center;gap:6px;background:var(--card);border:1px solid var(--border);padding:5px 11px;border-radius:2px;font-size:10px;color:var(--dim)}
.ldot{width:6px;height:6px;border-radius:50%}
.criteria{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.crit{display:flex;align-items:center;gap:6px;background:var(--surf2);border:1px solid var(--border);padding:5px 12px;border-radius:3px;font-size:10px;color:var(--text);letter-spacing:.05em}
.cdot{width:7px;height:7px;border-radius:50%;flex-shrink:0}

/* â”€â”€ Regime â”€â”€ */
.regime{display:flex;gap:2px;margin-bottom:16px}
.reg-card{flex:1;background:var(--card);border:1px solid var(--border);padding:12px 16px;display:flex;align-items:center;gap:10px;font-size:11px}
.reg-icon{font-size:18px}.reg-val{font-size:13px;font-weight:700}
.reg-lbl{font-size:9px;color:var(--dim);letter-spacing:.1em;text-transform:uppercase}

/* â”€â”€ Warn â”€â”€ */
.warn{background:rgba(255,51,85,.08);border:1px solid rgba(255,51,85,.25);padding:10px 16px;margin-bottom:16px;font-size:10px;color:var(--red)}

/* â”€â”€ Progress â”€â”€ */
.prog-wrap{margin-bottom:12px;display:none}.prog-wrap.on{display:block}
.prog-lbl{font-size:9px;color:var(--dim);letter-spacing:.08em;margin-bottom:5px;display:flex;justify-content:space-between}
.prog-bg{height:2px;background:var(--muted);border-radius:2px;overflow:hidden}
.pfd{height:100%;background:linear-gradient(90deg,var(--accent),var(--green));border-radius:2px;transition:width .3s}
.pfs{height:100%;background:linear-gradient(90deg,var(--red),var(--orange));border-radius:2px;transition:width .3s}
.pfw{height:100%;background:linear-gradient(90deg,#00b37a,#00e5a0);border-radius:2px;transition:width .3s}

/* â”€â”€ Log â”€â”€ */
.log{background:var(--card);border:1px solid var(--border);padding:10px 14px;max-height:110px;overflow:auto;font-size:10px;line-height:1.9;margin-bottom:14px;display:none}
.log.on{display:block}
.lok{color:var(--green)}.lerr{color:var(--red)}.linfo{color:var(--accent)}.lwarn{color:var(--yellow)}

/* â”€â”€ Stats bar â”€â”€ */
.stats{display:grid;grid-template-columns:repeat(6,1fr);gap:1px;background:var(--border);margin-bottom:16px}
.stat{background:var(--card);padding:14px 10px;text-align:center}
.snum{font-family:'Bebas Neue',sans-serif;font-size:32px;line-height:1;color:var(--text)}
.snum.g{color:var(--green)}.snum.sg{color:var(--sg)}.snum.r{color:var(--red)}
.snum.y{color:var(--yellow)}.snum.a{color:var(--accent)}.snum.o{color:var(--orange)}.snum.p{color:var(--purple)}
.slbl{font-size:8px;color:var(--dim);letter-spacing:.15em;text-transform:uppercase;margin-top:4px}

/* â”€â”€ Tag styles (shared) â”€â”€ */
.tag{font-size:8px;padding:2px 6px;border-radius:2px;letter-spacing:.06em;font-weight:600}
.tg{background:rgba(0,255,136,.1);color:var(--green);border:1px solid rgba(0,255,136,.2)}
.ty{background:rgba(255,215,0,.1);color:var(--yellow);border:1px solid rgba(255,215,0,.2)}
.tp{background:rgba(192,132,252,.1);color:var(--purple);border:1px solid rgba(192,132,252,.2)}
.ta{background:rgba(0,212,255,.1);color:var(--accent);border:1px solid rgba(0,212,255,.2)}
.tr{background:rgba(255,51,85,.1);color:var(--red);border:1px solid rgba(255,51,85,.2)}
.to{background:rgba(251,146,60,.1);color:var(--orange);border:1px solid rgba(251,146,60,.2)}
/* swing tags */
.stg{background:rgba(0,229,160,.1);color:var(--sg);border:1px solid rgba(0,229,160,.2);font-size:9px;padding:2px 6px;border-radius:2px;letter-spacing:.06em;font-weight:500}
.sty{background:rgba(251,191,36,.1);color:var(--sy);border:1px solid rgba(251,191,36,.2);font-size:9px;padding:2px 6px;border-radius:2px;letter-spacing:.06em;font-weight:500}
.stp{background:rgba(192,132,252,.1);color:var(--sp);border:1px solid rgba(192,132,252,.2);font-size:9px;padding:2px 6px;border-radius:2px;letter-spacing:.06em;font-weight:500}
.stb{background:rgba(56,189,248,.1);color:var(--sb);border:1px solid rgba(56,189,248,.2);font-size:9px;padding:2px 6px;border-radius:2px;letter-spacing:.06em;font-weight:500}
.str{background:rgba(255,61,107,.1);color:var(--sr);border:1px solid rgba(255,61,107,.2);font-size:9px;padding:2px 6px;border-radius:2px;letter-spacing:.06em;font-weight:500}

/* â”€â”€ Day/Scalp grid tables â”€â”€ */
.tbl-outer{background:var(--card);border:1px solid var(--border);overflow:hidden}
.day-head,.day-row{display:grid;grid-template-columns:50px 90px 185px 105px 75px 82px 90px 85px 90px 82px 75px;border-bottom:1px solid var(--border)}
.day-head{background:rgba(0,212,255,.04)}
.scalp-head,.scalp-row{display:grid;grid-template-columns:46px 90px 165px 100px 72px 80px 80px 82px 115px 72px 72px;border-bottom:1px solid var(--border)}
.scalp-head{background:rgba(255,51,85,.04)}
.day-head>div,.scalp-head>div{padding:9px 10px;font-size:9px;color:var(--dim);letter-spacing:.15em;text-transform:uppercase}
.day-row,.scalp-row{background:var(--card);transition:background .15s;position:relative}
.day-row:hover{background:#0a1520}.scalp-row:hover{background:#0a1015}
.day-row:last-child,.scalp-row:last-child{border-bottom:none}
.trow-anim{animation:fadein .45s ease both}
@keyframes fadein{from{opacity:0;transform:translateX(-6px)}to{opacity:1;transform:translateX(0)}}
.cell{padding:11px 10px;display:flex;align-items:center;font-size:11px;border-right:1px solid rgba(13,31,45,.7)}
.cell:last-child{border-right:none}
.cell.col{flex-direction:column;align-items:flex-start;gap:2px}
.rankbar{position:absolute;left:0;top:0;bottom:0;width:3px}
.rnum{font-family:'Bebas Neue',sans-serif;font-size:24px;line-height:1}
.rnum.gold{color:#f59e0b}.rnum.silver{color:#94a3b8}.rnum.bronze{color:#b45309}
.tsym{font-family:'Bebas Neue',sans-serif;font-size:17px;letter-spacing:.04em;color:var(--text)}
.tname{font-size:9px;color:var(--dim);margin-top:1px}
.sig-tags{display:flex;gap:4px;flex-wrap:wrap;margin-top:4px}
.chg{font-size:11px;font-weight:700}.chg.pos{color:var(--green)}.chg.neg{color:var(--red)}
.pval{font-size:14px;font-weight:700;color:var(--text)}
.bar-mini{width:44px;height:3px;background:var(--muted);border-radius:2px;overflow:hidden;margin-top:4px}
.bf{height:100%;border-radius:2px}
.bfg{background:var(--green)}.bfr{background:var(--red)}.bfy{background:var(--yellow)}.bfo{background:var(--orange)}
.score-num{font-family:'Bebas Neue',sans-serif;font-size:28px;line-height:1}
.score-den{font-size:9px;color:var(--dim)}
.score-bar{width:44px;height:2px;background:var(--muted);border-radius:2px;overflow:hidden;margin-top:4px}
.sfd{height:100%;background:linear-gradient(90deg,var(--accent),var(--green))}
.sfs{height:100%;background:linear-gradient(90deg,var(--red),var(--orange))}
.target-box{display:flex;flex-direction:column;gap:2px}
.te{font-size:10px;font-weight:700;color:var(--accent)}
.tt{font-size:10px;font-weight:700;color:var(--green)}
.ts2{font-size:10px;font-weight:700;color:var(--red)}
.msg{padding:50px;text-align:center;color:var(--dim);font-size:13px;letter-spacing:.05em}
.spin{display:inline-block;width:9px;height:9px;border:2px solid var(--dim);border-top-color:var(--green);border-radius:50%;animation:spin .8s linear infinite;margin-right:8px;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€ Swing table â”€â”€ */
.sw-wrap{background:var(--surf);border:1px solid var(--border);border-radius:4px;overflow-x:auto;overflow-y:hidden}
.sw-wrap table{width:100%;border-collapse:collapse;min-width:900px}
.sw-wrap thead{background:var(--surf2);border-bottom:1px solid var(--bord2)}
.sw-wrap thead th{padding:9px 10px;font-size:9px;color:var(--sdim);letter-spacing:.12em;text-transform:uppercase;white-space:nowrap;font-weight:500;text-align:left}
.sw-wrap tbody tr{border-bottom:1px solid rgba(26,37,53,.7);transition:background .15s}
.sw-wrap tbody tr:last-child{border:none}.sw-wrap tbody tr:hover{background:var(--surf2)}
.sw-wrap td{padding:10px 10px;white-space:nowrap;vertical-align:middle;text-align:left}
.data-row{animation:rowin .5s ease both}
@keyframes rowin{from{opacity:0;transform:translateX(-8px)}to{opacity:1;transform:translateX(0)}}
.msg-row td{padding:60px;text-align:center;color:var(--dim);font-size:13px;letter-spacing:.05em}
.rank-cell{display:flex;align-items:center}
.rank-bar{width:3px;height:44px;margin-right:12px;border-radius:2px}
.rank-num{font-family:'Bebas Neue',sans-serif;font-size:26px;color:var(--dim)}
.rank-num.top3{color:#f59e0b}
.t-sym{font-size:15px;font-weight:700;color:var(--sbright);letter-spacing:.04em}
.t-name{font-size:9px;color:var(--sdim);margin-top:2px}
.signal-main{font-size:11px}.signal-main.strong{color:var(--sg)}.signal-main.watch{color:var(--sy)}
.price-val{font-size:14px;font-weight:600;color:var(--sbright);font-variant-numeric:tabular-nums}
.swchg{font-size:10px;margin-top:2px;font-variant-numeric:tabular-nums}
.swchg.pos{color:var(--sg)}.swchg.neg{color:var(--sr)}
.rsi-num{font-size:16px;font-weight:700;font-variant-numeric:tabular-nums}
.rsi-num.oversold{color:var(--sg)}.rsi-num.overbought{color:var(--sr)}.rsi-num.neutral{color:var(--sy)}
.mini-bar{width:44px;height:3px;background:var(--surf3);border-radius:2px;overflow:hidden;margin-top:4px;display:inline-block}
.mini-fill{height:100%;border-radius:2px}
.mfg{background:var(--sg)}.mfr{background:var(--sr)}.mfy{background:var(--sy)}
.mfp{background:linear-gradient(90deg,#7c3aed,#c084fc)}.mfb{background:#6366f1}.mfd{background:var(--sdim)}
.mfbull{background:linear-gradient(90deg,#007a56,var(--sg))}.mfbear{background:linear-gradient(90deg,#7a001f,var(--sr))}
.ema-val{font-size:11px;font-variant-numeric:tabular-nums}
.ema-above{color:var(--sg)}.ema-below{color:var(--sr)}
.num-bull{color:var(--sg);font-size:14px;font-weight:700}.num-bear{color:var(--sr);font-size:14px;font-weight:700}.num-dim{color:var(--sdim);font-size:14px;font-weight:700}
.sq-fire{color:var(--sp);font-size:14px;font-weight:700}.sq-warm{color:#818cf8;font-size:14px;font-weight:700}.sq-cool{color:var(--sdim);font-size:14px;font-weight:700}
.score-cell{display:flex;flex-direction:column;align-items:flex-end;gap:2px}
.sw-score-num{font-family:'Bebas Neue',sans-serif;font-size:32px;line-height:1}
.sw-score-den{font-size:9px;color:var(--sdim)}
.sw-score-bar{width:50px;height:3px;background:var(--surf3);border-radius:2px;overflow:hidden}
.sw-score-fill{height:100%;background:linear-gradient(90deg,#00b37a,#00e5a0)}

/* â”€â”€ Footer â”€â”€ */
.foot{margin-top:14px;font-size:9px;color:var(--muted);letter-spacing:.05em;display:flex;justify-content:space-between}

/* â”€â”€ Mobile â”€â”€ */
@media(max-width:768px){
  .wrap{padding:10px 8px}.title-d,.title-s,.title-w{font-size:28px}
  .hdr{flex-direction:column;gap:10px;align-items:flex-start}
  .hdr-right{width:100%;align-items:flex-start}
  .btn-d,.btn-s,.btn-w{width:100%}
  .tab-btn{font-size:13px;padding:10px 12px}
  .regime{flex-wrap:wrap}.reg-card{min-width:calc(50% - 1px)}
  .stats{grid-template-columns:repeat(3,1fr)}
  .legend,.criteria{display:none}
  .tbl-outer,.sw-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
  .day-head,.day-row{min-width:920px}
  .scalp-head,.scalp-row{min-width:900px}
  .sw-wrap table{min-width:900px}
  .foot{flex-direction:column;gap:4px}
}

.chip{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(0,0,0,.35);font-size:12px}
</style>
</head>
<body>
<div class="gridbg"></div>
<div class="wrap">

<!-- â”€â”€ Tab bar â”€â”€ -->
<div class="tabs" style="justify-content:space-between;align-items:center">
  <div style="display:flex">
    <button class="tab-btn td" id="tb-d" onclick="switchTab('d')">âš¡ DAY TRADING</button>
    <button class="tab-btn"    id="tb-s" onclick="switchTab('s')">ğŸ¯ SCALP TRADING</button>
    <button class="tab-btn"    id="tb-w" onclick="switchTab('w')">ğŸ“ˆ SWING TRADING</button>
  </div>
  <label style="display:flex;align-items:center;gap:9px;padding:0 18px;cursor:pointer;font-size:10px;color:var(--dim);letter-spacing:.08em;user-select:none" onclick="toggleTG()">
    <div style="position:relative;width:38px;height:21px;flex-shrink:0">
      <div id="tgTrack" style="position:absolute;inset:0;border-radius:20px;background:var(--muted);border:1px solid var(--border);transition:background .2s,border-color .2s"></div>
      <div id="tgThumb" style="position:absolute;top:3px;left:3px;width:13px;height:13px;border-radius:50%;background:var(--dim);transition:all .2s"></div>
    </div>
    <span id="tgLabel" style="white-space:nowrap;transition:color .2s">ğŸ“² TELEGRAM ALERTS OFF</span>
  </label>
  <button class="btn-d" onclick="openTGSettings()" style="margin-left:10px;padding:8px 10px;font-size:12px;background:transparent;border:1px solid var(--border)">âš™ï¸</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DAY TRADER TAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-d" class="tab-panel active">
  <div class="hdr">
    <div><div class="title-d">NDX100 DAY TRADER</div><div class="sub">Mid-day Momentum Â· Breakout Scoring Â· Top 10 to Buy Today</div></div>
    <div class="hdr-right">
      <button class="btn-d" id="dBtn" onclick="runDay()">&#9654; SCAN NOW</button>
      <div class="mstat"><div class="mdot" id="dDot" style="background:var(--dim)"></div><span id="dStat" style="color:var(--dim)">READY</span><span id="dTime" style="color:var(--dim);margin-left:8px"></span></div>
    </div>
  </div>
  <div class="legend">
    <div class="leg"><div class="ldot" style="background:var(--green)"></div>Intraday % gain</div>
    <div class="leg"><div class="ldot" style="background:var(--yellow)"></div>Volume surge vs 20-day avg</div>
    <div class="leg"><div class="ldot" style="background:var(--accent)"></div>Relative strength vs SPY</div>
    <div class="leg"><div class="ldot" style="background:var(--purple)"></div>Price above VWAP</div>
    <div class="leg"><div class="ldot" style="background:var(--orange)"></div>Gap up held</div>
    <div class="leg"><div class="ldot" style="background:var(--red)"></div>Range expansion (ATR)</div>
  </div>
  <div class="regime">
    <div class="reg-card"><div class="reg-icon">â³</div><div><div class="reg-val" id="dSpyChg" style="color:var(--dim)">â€”</div><div class="reg-lbl">SPY Today</div></div></div>
    <div class="reg-card"><div class="reg-icon">ğŸ“Š</div><div><div class="reg-val" id="dSpyVol" style="color:var(--dim)">â€”</div><div class="reg-lbl">SPY Vol</div></div></div>
    <div class="reg-card"><div class="reg-icon">ğŸŒ¡ï¸</div><div><div class="reg-val" id="dRegime" style="color:var(--dim)">â€”</div><div class="reg-lbl">Market Regime</div></div></div>
    <div class="reg-card"><div class="reg-icon">âš¡</div><div><div class="reg-val" id="dScanT" style="color:var(--dim)">â€”</div><div class="reg-lbl">Scan Time</div></div></div>
  </div>
  <div class="prog-wrap" id="dProg"><div class="prog-lbl"><span id="dPL">Scanning...</span><span id="dPP">0%</span></div><div class="prog-bg"><div class="pfd" id="dPF" style="width:0%"></div></div></div>
  <div class="log" id="dLog"></div>
  <div class="stats">
    <div class="stat"><div class="snum" id="d1">â€”</div><div class="slbl">Scanned</div></div>
    <div class="stat"><div class="snum g" id="d2">â€”</div><div class="slbl">Gaining &gt;1%</div></div>
    <div class="stat"><div class="snum y" id="d3">â€”</div><div class="slbl">Vol Surge</div></div>
    <div class="stat"><div class="snum a" id="d4">â€”</div><div class="slbl">Beats SPY</div></div>
    <div class="stat"><div class="snum p" id="d5">â€”</div><div class="slbl">Gap Up</div></div>
    <div class="stat"><div class="snum" id="d6">â€”</div><div class="slbl">Avg Chg%</div></div>
  </div>
  <div id="dBody"><div class="msg">Press SCAN NOW to load live momentum data</div></div>
<!-- Pre-market + Open Momentum -->
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
  <div class="card" style="padding:14px">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <div>
        <div style="font-weight:900;letter-spacing:.08em">ğŸŒ… PRE-MARKET SCAN</div>
        <div style="color:var(--dim);font-size:12px;margin-top:2px">4:00â€“9:30 ET Â· gap + volume + trend</div>
      </div>
      <button class="btn-d" id="pmBtn" onclick="runPreMarket()" style="padding:10px 14px">â–¶ SCAN PRE-MARKET</button>
    </div>
    <div id="pmOut" style="margin-top:10px"><div class="msg">Run pre-market scan to see movers before open.</div></div>
  </div>

  <div class="card" style="padding:14px">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <div>
        <div style="font-weight:900;letter-spacing:.08em">â±ï¸ OPEN MOMENTUM</div>
        <div style="color:var(--dim);font-size:12px;margin-top:2px">9:30â€“10:30 ET Â· relative volume + VWAP</div>
      </div>
      <button class="btn-d" id="omBtn" onclick="runOpenMomentum()" style="padding:10px 14px">â–¶ SCAN 9:30â€“10:30</button>
    </div>
    <div id="omOut" style="margin-top:10px"><div class="msg">Run open momentum scan during market open for best picks.</div></div>
  </div>
</div>
  <div class="foot"><span>Yahoo Finance Â· No API key Â· No rate limits Â· Not financial advice</span><span id="dFoot"></span></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCALP TRADER TAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-s" class="tab-panel">
  <div class="hdr">
    <div><div class="title-s">NDX100 SCALP SCANNER</div><div class="sub">5-Min Momentum Â· Buy &amp; Sell Within 1 Hour Â· Top 10 Right Now</div></div>
    <div class="hdr-right">
      <button class="btn-s" id="sBtn" onclick="runScalp()">&#9654; SCAN NOW</button>
      <!-- Auto-Monitor Toggle -->
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:10px;color:var(--dim);letter-spacing:.08em;user-select:none;margin-top:6px" onclick="toggleAutoMonitor()">
        <div style="position:relative;width:38px;height:21px;flex-shrink:0">
          <div id="amTrack" style="position:absolute;inset:0;border-radius:20px;background:var(--muted);border:1px solid var(--border);transition:background .2s"></div>
          <div id="amThumb" style="position:absolute;top:3px;left:3px;width:13px;height:13px;border-radius:50%;background:var(--dim);transition:all .2s"></div>
        </div>
        <span id="amLabel" style="white-space:nowrap;transition:color .2s">ğŸ” AUTO-MONITOR OFF</span>
      </label>
      <div id="amStatus" style="font-size:9px;color:var(--dim);margin-top:3px;letter-spacing:.06em">Scans every 5 min Â· alerts Telegram at 11â€“12 pts</div>
      <div class="mstat" style="margin-top:4px"><div class="mdot" id="sDot" style="background:var(--dim)"></div><span id="sStat" style="color:var(--dim)">READY</span><span id="sTime" style="color:var(--dim);margin-left:8px"></span></div>
    </div>
  </div>
  <div class="warn">âš¡ SCALP MODE â€” These signals are for very short trades (15â€“60 min). Always use a stop loss. Not financial advice.</div>
  <div class="legend">
    <div class="leg"><div class="ldot" style="background:var(--green)"></div>Last 3 candles bullish (5-min)</div>
    <div class="leg"><div class="ldot" style="background:var(--yellow)"></div>Volume spike on last candle</div>
    <div class="leg"><div class="ldot" style="background:var(--accent)"></div>Price above VWAP</div>
    <div class="leg"><div class="ldot" style="background:var(--orange)"></div>Momentum accelerating</div>
    <div class="leg"><div class="ldot" style="background:var(--purple)"></div>Relative strength vs SPY 5m</div>
  </div>
  <div class="regime">
    <div class="reg-card"><div class="reg-icon">ğŸ“Š</div><div><div class="reg-val" id="sSpy5m" style="color:var(--dim)">â€”</div><div class="reg-lbl">SPY 5-Min</div></div></div>
    <div class="reg-card"><div class="reg-icon">ğŸŒ¡ï¸</div><div><div class="reg-val" id="sRegime" style="color:var(--dim)">â€”</div><div class="reg-lbl">Market Now</div></div></div>
    <div class="reg-card"><div class="reg-icon">âš¡</div><div><div class="reg-val" id="sMom" style="color:var(--dim)">â€”</div><div class="reg-lbl">SPY Momentum</div></div></div>
    <div class="reg-card"><div class="reg-icon">ğŸ•</div><div><div class="reg-val" id="sScanT" style="color:var(--dim)">â€”</div><div class="reg-lbl">Scan Time</div></div></div>
  </div>
  <div class="prog-wrap" id="sProg"><div class="prog-lbl"><span id="sPL">Scanning...</span><span id="sPP">0%</span></div><div class="prog-bg"><div class="pfs" id="sPF" style="width:0%"></div></div></div>
  <div class="log" id="sLog"></div>
  <div class="stats">
    <div class="stat"><div class="snum" id="s1">â€”</div><div class="slbl">Scanned</div></div>
    <div class="stat"><div class="snum g" id="s2">â€”</div><div class="slbl">Bull Candles</div></div>
    <div class="stat"><div class="snum y" id="s3">â€”</div><div class="slbl">Vol Spike</div></div>
    <div class="stat"><div class="snum a" id="s4">â€”</div><div class="slbl">Above VWAP</div></div>
    <div class="stat"><div class="snum o" id="s5">â€”</div><div class="slbl">Accelerating</div></div>
    <div class="stat"><div class="snum r" id="s6">â€”</div><div class="slbl">Scalp Ready</div></div>
  </div>
  <div class="tbl-outer">
    <div class="scalp-head"><div>#</div><div>Ticker</div><div>Signal</div><div>Price</div><div>5m Chg%</div><div>Vol Spike</div><div>vs VWAP</div><div>Momentum</div><div>Entry / Target / Stop</div><div>RS vs SPY</div><div>Score</div></div>
    <div id="sBody"><div class="msg">Press SCAN NOW to find scalp opportunities right now</div></div>
  </div>

  <!-- â”€â”€ Ticker Lookup â”€â”€ -->
  <div style="margin-top:16px;background:var(--card);border:1px solid var(--border);padding:16px 20px">
    <div style="font-size:10px;color:var(--dim);letter-spacing:.15em;text-transform:uppercase;margin-bottom:10px">ğŸ” CHECK ANY TICKER â€” Scalp Analysis on Demand</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <input id="lookupInput" placeholder="e.g. ZS, PLTR, TSLA" maxlength="10"
        style="background:#03070b;border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:13px;padding:10px 14px;width:180px;letter-spacing:.08em;text-transform:uppercase;outline:none"
        onkeydown="if(event.key==='Enter') lookupTicker()"
        oninput="this.value=this.value.toUpperCase()">
      <button class="btn-s" id="lookupBtn" onclick="lookupTicker()" style="padding:10px 22px;font-size:14px">â–¶ ANALYZE</button>
      <span style="font-size:10px;color:var(--dim)">Any stock â€” not just NDX100</span>
    </div>
    <div id="lookupOut" style="margin-top:12px"></div>
  </div>

  <div class="foot"><span>Yahoo Finance Â· 5-min candles Â· Refresh every scan Â· Not financial advice</span><span id="sFoot"></span></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SWING TRADER TAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-w" class="tab-panel">
  <div class="hdr">
    <div><div class="title-w">NDX100 BUY SCANNER</div><div class="sub">Yahoo Finance Â· All 100 Tickers Â· RSI-14 Â· EMA-20/200 Â· SMA-50 Â· TTM Squeeze Â· Trend Strength Â· Top 10 Ranked</div></div>
    <div class="hdr-right">
      <button class="btn-w" id="wBtn" onclick="runSwing()">&#9654; RESCAN ALL 100</button>
      <div style="font-size:9px;color:var(--sdim);text-align:right;letter-spacing:.06em"><span style="color:var(--sg)">No API key needed</span> Â· Yahoo Finance Â· ~60s scan time</div>
    </div>
  </div>
  <div class="criteria">
    <div class="crit"><div class="cdot" style="background:var(--sg)"></div>Bullish trend (EMA20 &gt; SMA50)</div>
    <div class="crit"><div class="cdot" style="background:var(--sy)"></div>Trend strength &gt; 10%</div>
    <div class="crit"><div class="cdot" style="background:var(--sp)"></div>Squeeze &gt; 70%</div>
    <div class="crit"><div class="cdot" style="background:var(--sb)"></div>Price above EMA200</div>
    <div class="crit"><div class="cdot" style="background:var(--sg)"></div>RSI 30â€“65 buy zone Â· &lt;30 oversold â˜…</div>
    <div class="crit"><div class="cdot" style="background:var(--sr)"></div>Dip below SMA50 (bonus)</div>
  </div>
  <div class="prog-wrap" id="wProg"><div class="prog-lbl"><span id="wPL">Scanning...</span><span id="wPP">0%</span></div><div class="prog-bg"><div class="pfw" id="wPF" style="width:0%"></div></div></div>
  <div class="log" id="wLog"></div>
  <div class="stats">
    <div class="stat"><div class="snum"    id="w1">â€”</div><div class="slbl">Scanned</div></div>
    <div class="stat"><div class="snum sg" id="w2">â€”</div><div class="slbl">Bullish Trend</div></div>
    <div class="stat"><div class="snum y"  id="w3">â€”</div><div class="slbl">RSI Buy Zone</div></div>
    <div class="stat"><div class="snum p"  id="w4">â€”</div><div class="slbl">Squeeze &gt;70%</div></div>
    <div class="stat"><div class="snum sg" id="w5">â€”</div><div class="slbl">Oversold &lt;30</div></div>
    <div class="stat"><div class="snum"    id="w6">â€”</div><div class="slbl">Avg RSI</div></div>
  </div>
  <div class="sw-wrap">
    <table>
      <thead><tr>
        <th>#</th><th>Ticker</th><th>Signal</th>
        <th>Price</th><th>RSI-14</th><th>EMA-20</th><th>EMA-200</th>
        <th>SMA-50</th><th>Trend%</th><th>Squeeze</th><th>Score</th>
      </tr></thead>
      <tbody id="wBody"><tr class="msg-row"><td colspan="11">Press RESCAN ALL 100 to load swing trade data</td></tr></tbody>
    </table>
  </div>
  <div class="foot"><span>Yahoo Finance Â· 400-day history Â· RSI Â· EMA Â· SMA Â· TTM Squeeze Â· Not financial advice</span><span id="wFoot"></span></div>
</div>

</div><!-- /wrap -->
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(t) {
  ['d','s','w'].forEach(x => {
    document.getElementById('tab-'+x).classList.toggle('active', x===t);
    const b = document.getElementById('tb-'+x);
    b.className = 'tab-btn' + (x===t ? ' t'+x : '');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TELEGRAM â€” direct API, checkbox gated
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Telegram settings (stored locally in your browser)
let TG_TOKEN   = localStorage.getItem("tg_token")   || "";
let TG_CHAT_ID = localStorage.getItem("tg_chat_id") || "";
let tgEnabled  = (localStorage.getItem("tg_enabled") === "1");

function syncTGToggleUI(){
  const on = tgEnabled;
  document.getElementById("tgTrack").style.background  = on ? "var(--green)"  : "var(--muted)";
  document.getElementById("tgTrack").style.borderColor = on ? "var(--green)"  : "var(--border)";
  document.getElementById("tgThumb").style.background  = on ? "#000"          : "var(--dim)";
  document.getElementById("tgThumb").style.left        = on ? "22px"          : "3px";
  document.getElementById("tgLabel").textContent       = on ? "ğŸ“² TELEGRAM ALERTS ON" : "ğŸ“² TELEGRAM ALERTS OFF";
  document.getElementById("tgLabel").style.color       = on ? "var(--green)"  : "var(--dim)";
}

function openTGSettings(){
  const m = document.getElementById("tgModal");
  document.getElementById("tgTok").value  = TG_TOKEN;
  document.getElementById("tgChat").value = TG_CHAT_ID;
  document.getElementById("tgAuto").checked = (localStorage.getItem("tg_auto_top") === "1");
  m.style.display = "flex";
}
function closeTGSettings(){ document.getElementById("tgModal").style.display="none"; }
function saveTGSettings(){
  TG_TOKEN   = (document.getElementById("tgTok").value || "").trim();
  TG_CHAT_ID = (document.getElementById("tgChat").value || "").trim();
  localStorage.setItem("tg_token", TG_TOKEN);
  localStorage.setItem("tg_chat_id", TG_CHAT_ID);
  localStorage.setItem("tg_auto_top", document.getElementById("tgAuto").checked ? "1" : "0");
  closeTGSettings();
}

function toggleTG() {
  tgEnabled = !tgEnabled;
  localStorage.setItem("tg_enabled", tgEnabled ? "1" : "0");
  syncTGToggleUI();

  // If user turned ON but token/chat not set, open settings.
  if (tgEnabled && (!TG_TOKEN || !TG_CHAT_ID)) {
    openTGSettings();
  }
}

async function sendAlert(sym,name,price,chgPct,score,maxPts,signal,tags){
  if (!tgEnabled) return;
  if (!TG_TOKEN || !TG_CHAT_ID) return;
  const emoji  = score >= 8 ? "ğŸ”¥" : score >= 7 ? "âš¡" : score >= 6 ? "âœ…" : "ğŸ¯";
  const msg = `${emoji} *${signal} â€” NDX100*
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“Œ *${sym}* â€” ${name}
ğŸ’° Price: $${typeof price === 'number' ? price.toFixed(2) : price}
ğŸ“ˆ Change: ${chgPct >= 0 ? "+" : ""}${typeof chgPct === 'number' ? chgPct.toFixed(2) : chgPct}%
â­ Score: ${score}/${maxPts}
ğŸ“Š ${tags}
â° ${new Date().toLocaleTimeString()}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`;
  try {
    await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({chat_id: TG_CHAT_ID, text: msg, parse_mode: "Markdown"})
    });
  } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHARED TICKER LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let TICKERS = [];        // will be filled dynamically
let TICKERS_LOADED = false;

// Try to load Nasdaq-100 list dynamically (Wikipedia is easiest to parse)
async function fetchNDX100List(){
  const url="https://en.wikipedia.org/wiki/Nasdaq-100";
  const r=await proxyFetch(url);
  const html=await r.text();
  const doc=new DOMParser().parseFromString(html,"text/html");

  // Find a wikitable whose header mentions ticker/symbol
  const tables=Array.from(doc.querySelectorAll("table.wikitable"));
  let best=null;
  for(const t of tables){
    const headerText=(t.querySelector("tr")?.innerText||"").toLowerCase();
    if(headerText.includes("ticker")||headerText.includes("symbol")){
      best=t; break;
    }
  }
  if(!best) throw new Error("Could not find constituents table");

  // Determine symbol column index
  const headerRow=best.querySelector("tr");
  const headerCells=Array.from(headerRow.querySelectorAll("th")).map(th=>th.innerText.trim().toLowerCase());
  let symCol=headerCells.findIndex(h=>h.includes("ticker")||h.includes("symbol"));
  if(symCol<0) symCol=0;

  const rows=Array.from(best.querySelectorAll("tr")).slice(1);
  const out=[];
  const seen=new Set();

  for(const row of rows){
    const cells=Array.from(row.querySelectorAll("td"));
    if(!cells.length) continue;
    const symRaw=(cells[symCol]?.innerText||"").trim();
    if(!symRaw) continue;

    const cleaned=symRaw.replace(/\s+/g,"").replace(/\[.*?\]/g,"");
    if(!cleaned) continue;

    // Yahoo often uses '-' instead of '.' (e.g., BRK.B -> BRK-B)
    const yahooSym=cleaned.includes(".") ? cleaned.replace(".", "-") : cleaned;
    const sym=yahooSym.toUpperCase();
    if(seen.has(sym)) continue;
    seen.add(sym);

    // Best-effort company name (use another column if present)
    const name=(cells.find((_,i)=>i!==symCol)?.innerText||sym).trim();
    out.push({sym, name});
  }
  if(out.length<80) throw new Error(`Got too few tickers (${out.length})`);
  return out.slice(0,110); // safety cap
}

async function ensureTickersLoaded(logId){
  if(TICKERS_LOADED && TICKERS.length) return;
  try{
    if(logId) logTo(logId,"â–º Loading Nasdaq-100 listâ€¦","linfo");
    TICKERS = await fetchNDX100List();
    TICKERS_LOADED = true;
    if(logId) logTo(logId,`âœ“ Loaded ${TICKERS.length} tickers (dynamic NDX100)`,"lok");
  }catch(e){
    if(logId) logTo(logId,`âš  Dynamic NDX100 list failed (${e.message}). Using fallback list.`,"lwarn");
    // Fallback list (top names) so the app still runs
    TICKERS = [
      {sym:"AAPL",name:"Apple"},{sym:"MSFT",name:"Microsoft"},{sym:"NVDA",name:"NVIDIA"},
      {sym:"AMZN",name:"Amazon"},{sym:"META",name:"Meta Platforms"},{sym:"TSLA",name:"Tesla"},
      {sym:"GOOGL",name:"Alphabet A"},{sym:"GOOG",name:"Alphabet C"},{sym:"AVGO",name:"Broadcom"},
      {sym:"COST",name:"Costco"},{sym:"AMD",name:"Advanced Micro Devices"},{sym:"NFLX",name:"Netflix"},
      {sym:"ADBE",name:"Adobe"},{sym:"PEP",name:"PepsiCo"},{sym:"CSCO",name:"Cisco"},
      {sym:"INTC",name:"Intel"},{sym:"TXN",name:"Texas Instruments"},{sym:"AMAT",name:"Applied Materials"},
      {sym:"QCOM",name:"Qualcomm"},{sym:"MU",name:"Micron"},{sym:"HON",name:"Honeywell"},
      {sym:"SBUX",name:"Starbucks"},{sym:"BKNG",name:"Booking"},{sym:"REGN",name:"Regeneron"},
      {sym:"PYPL",name:"PayPal"},{sym:"COIN",name:"Coinbase"}
    ];
    TICKERS_LOADED = true;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOG HELPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function logTo(id, msg, cls="") {
  const b = document.getElementById(id);
  b.classList.add("on");
  const d = document.createElement("div");
  d.textContent = msg; d.className = cls;
  b.appendChild(d); b.scrollTop = b.scrollHeight;
}
function rnCls(i){return i===0?"gold":i===1?"silver":i===2?"bronze":"";}
function rbColor(i,mode){
  if(mode==="s") return i===0?"#ff3355":i===1?"#fb923c":i===2?"#ffd700":"#0d1f2d";
  return i===0?"#f59e0b":i===1?"#94a3b8":i===2?"#b45309":"#0d1f2d";
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// YAHOO FINANCE FETCHERS â€” auto fallback proxies on 429
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let dCache={}, sCache={}, wCache={};

const PROXIES = [
  // Direct Yahoo Finance (works when no CORS restriction, e.g. localhost)
  url => url,
  // Most reliable CORS proxies
  url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
  url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
  url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
  url => `https://corsproxy.org/?${encodeURIComponent(url)}`,
  url => `https://api.cors.lol/?url=${encodeURIComponent(url)}`,
  url => `https://cors.eu.org/${url}`,
];

async function fetchWithTimeout(url, ms=15000) {
  const ctrl = new AbortController();
  const tid = setTimeout(() => ctrl.abort(), ms);
  try {
    const r = await fetch(url, { signal: ctrl.signal });
    clearTimeout(tid); return r;
  } catch(e) { clearTimeout(tid); throw e; }
}

// Fetches Yahoo URL through proxies, validates real JSON, auto-retries on bad content
async function proxyFetchJSON(yahooUrl) {
  let lastErr;
  for (let i = 0; i < PROXIES.length; i++) {
    const proxyUrl = PROXIES[i](yahooUrl);
    try {
      const r = await fetchWithTimeout(proxyUrl, 15000);
      if (r.status === 429 || r.status === 503 || r.status === 403 || r.status === 407) {
        lastErr = new Error(`HTTP ${r.status} from proxy ${i}`); continue;
      }
      if (!r.ok) { lastErr = new Error(`HTTP ${r.status} from proxy ${i}`); continue; }
      const text = await r.text();
      const t = text.trim();
      if (!t || (t[0] !== '{' && t[0] !== '[')) {
        lastErr = new Error(`Non-JSON from proxy ${i}: ${t.slice(0,80)}`);
        continue;
      }
      try {
        return JSON.parse(t);
      } catch(je) {
        lastErr = new Error(`Bad JSON from proxy ${i}: ${t.slice(0,80)}`);
        continue;
      }
    } catch(e) {
      lastErr = new Error(`Proxy ${i} fetch error: ${e.message}`);
    }
  }
  throw lastErr || new Error("All proxies failed â€” check network connection");
}

// Legacy wrapper â€” returns fake Response object
async function proxyFetch(yahooUrl) {
  const isHTML = yahooUrl.includes('wikipedia.org');
  if (isHTML) {
    let lastErr;
    for (let i = 0; i < PROXIES.length; i++) {
      try {
        const r = await fetchWithTimeout(PROXIES[i](yahooUrl), 15000);
        if (!r.ok) { lastErr = new Error(`HTTP ${r.status}`); continue; }
        const text = await r.text();
        if (!text || text.trim().length < 100) { lastErr = new Error('Empty response'); continue; }
        return { text: async () => text, json: async () => null, ok: true, status: 200 };
      } catch(e) { lastErr = e; }
    }
    throw lastErr || new Error("All proxies failed");
  }
  const json = await proxyFetchJSON(yahooUrl);
  return { json: async () => json, text: async () => JSON.stringify(json), ok: true, status: 200 };
}

async function yhDay(sym) {
  if(dCache[sym]) return dCache[sym];
  const now=Math.floor(Date.now()/1000), start=now-2*24*3600;
  // cb= cache-bust param forces Yahoo to return fresh data, not a cached response
  const cb=`&cb=${now}`;
  const [ij,dj] = await Promise.all([
    proxyFetchJSON(`https://query2.finance.yahoo.com/v8/finance/chart/${sym}?interval=5m&period1=${start}&period2=${now}${cb}`),
    proxyFetchJSON(`https://query2.finance.yahoo.com/v8/finance/chart/${sym}?interval=1d&range=3mo${cb}`)
  ]);
  const intra=ij?.chart?.result?.[0], daily=dj?.chart?.result?.[0];
  if(!daily) throw new Error("No data");
  const m=daily.meta, iQ=intra?.indicators?.quote?.[0], dQ=daily.indicators?.quote?.[0];
  const price=m.regularMarketPrice||m.previousClose, prev=m.previousClose||m.chartPreviousClose;
  const open=m.regularMarketOpen||prev, high=m.regularMarketDayHigh||price, low=m.regularMarketDayLow||price;
  const r={price,prev,open,high,low,
    chgPct:prev>0?((price-prev)/prev)*100:0,
    gapPct:prev>0?((open-prev)/prev)*100:0,
    candles:(iQ&&intra?.timestamp)?{c:iQ.close,h:iQ.high,l:iQ.low,v:iQ.volume}:null,
    closes:(dQ?.close||[]).map(v=>v??0), volumes:(dQ?.volume||[]).map(v=>v??0),
    highs:(dQ?.high||[]).map(v=>v??0),   lows:(dQ?.low||[]).map(v=>v??0)};
  dCache[sym]=r; return r;
}

async function yhScalp(sym) {
  if(sCache[sym]) return sCache[sym];
  const now=Math.floor(Date.now()/1000), start=now-3*24*3600;
  const j=await proxyFetchJSON(`https://query2.finance.yahoo.com/v8/finance/chart/${sym}?interval=5m&period1=${start}&period2=${now}&cb=${now}`);
  const res=j?.chart?.result?.[0];
  if(!res) throw new Error("No data");
  const m=res.meta, q=res.indicators?.quote?.[0], t=res.timestamp||[];
  if(!q||!q.close||q.close.length<3) throw new Error("Not enough candles");
  const candles=[];
  for(let i=0;i<t.length;i++) if(q.close[i]&&q.open[i]&&q.high[i]&&q.low[i]&&q.volume[i])
    candles.push({t:t[i],o:q.open[i],h:q.high[i],l:q.low[i],c:q.close[i],v:q.volume[i]});
  if(candles.length<3) throw new Error("Too few candles");
  const rv={price:m.regularMarketPrice||candles[candles.length-1].c, candles};
  sCache[sym]=rv; return rv;
}

async function yhSwing(sym) {
  if(wCache[sym]) return wCache[sym];
  const to=Math.floor(Date.now()/1000), from=to-400*86400;
  const json=await proxyFetchJSON(`https://query2.finance.yahoo.com/v8/finance/chart/${sym}?interval=1d&period1=${from}&period2=${to}&cb=${to}`);
  const res=json?.chart?.result?.[0];
  if(!res) throw new Error(json?.chart?.error?.description||"No data");
  const q=res.indicators.quote[0], adj=res.indicators.adjclose?.[0]?.adjclose||q.close;
  const valid=res.timestamp.map((t,i)=>({c:adj[i],h:q.high[i],l:q.low[i],o:q.open[i],v:q.volume[i]})).filter(x=>x.c!=null&&x.h!=null&&x.l!=null);
  if(valid.length<60) throw new Error(`Only ${valid.length} days`);
  const rv={closes:valid.map(x=>x.c), highs:valid.map(x=>x.h), lows:valid.map(x=>x.l),
    price:res.meta.regularMarketPrice||valid[valid.length-1].c, chgPct:res.meta.regularMarketChangePercent||0};
  wCache[sym]=rv; return rv;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHARED MATH / INDICATORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function vwapArr(c,h,l,v){if(!c)return null;let tp=0,vl=0;for(let i=0;i<c.length;i++){if(!c[i]||!v[i])continue;tp+=((h[i]+l[i]+c[i])/3)*v[i];vl+=v[i];}return vl>0?tp/vl:null;}
function vwapObj(cs){let tp=0,vl=0;for(const c of cs){const t=(c.h+c.l+c.c)/3;tp+=t*c.v;vl+=c.v;}return vl>0?tp/vl:null;}
function avgVol(vols,n=20){if(vols.length<n)return null;return vols.slice(-n-1,-1).reduce((a,b)=>a+b,0)/n;}
function atr(highs,lows,closes,n=14){if(closes.length<n+1)return null;const tr=[];for(let i=closes.length-n;i<closes.length;i++)tr.push(Math.max(highs[i]-lows[i],Math.abs(highs[i]-closes[i-1]),Math.abs(lows[i]-closes[i-1])));return tr.reduce((a,b)=>a+b,0)/n;}
function intVol(c){if(!c?.v)return 0;return c.v.reduce((a,b)=>a+(b||0),0);}
function bullStreak(c,n){return c.slice(-n).every(x=>x.c>x.o);}
function vSpike(c){if(c.length<11)return 0;const l=c[c.length-1],p=c.slice(-11,-1),a=p.reduce((x,y)=>x+y.v,0)/10;return a>0?l.v/a:0;}
function isAccel(c){if(c.length<4)return false;const c1=c[c.length-1],c3=c[c.length-3];return c1.c>c1.o&&Math.abs(c1.c-c1.o)>Math.abs(c3.c-c3.o);}
function r5m(c){if(c.length<4)return 0;const n=c[c.length-1].c,a=c[c.length-4].c;return a>0?((n-a)/a)*100:0;}
function levels(c,p){const a=c.slice(-5).reduce((x,y)=>x+(y.h-y.l),0)/5;return{entry:p,target:+(p+a*1.5).toFixed(2),stop:+(p-a*0.75).toFixed(2)};}
function ema(arr,p){if(arr.length<p)return null;const k=2/(p+1);let v=arr.slice(0,p).reduce((a,b)=>a+b,0)/p;for(let i=p;i<arr.length;i++)v=arr[i]*k+v*(1-k);return v;}
function sma(arr,p){if(arr.length<p)return null;return arr.slice(-p).reduce((a,b)=>a+b,0)/p;}
function rsi14(c){if(c.length<15)return null;let g=0,l=0;for(let i=c.length-14;i<c.length;i++){const d=c[i]-c[i-1];if(d>0)g+=d;else l-=d;}const ag=g/14,al=l/14;return al===0?100:100-100/(1+ag/al);}
function squeeze(h,l,c){const n=c.length;if(n<20)return{pct:null,inSq:false};const s=sma(c,20),sl=c.slice(-20),mean=sl.reduce((a,b)=>a+b,0)/20,sd=Math.sqrt(sl.reduce((a,b)=>a+Math.pow(b-mean,2),0)/20);const bbU=s+2*sd,bbL=s-2*sd,trs=[];for(let i=Math.max(1,n-21);i<n;i++)trs.push(Math.max(h[i]-l[i],Math.abs(h[i]-c[i-1]),Math.abs(l[i]-c[i-1])));const at=trs.reduce((a,b)=>a+b,0)/trs.length,kcU=s+1.5*at,kcL=s-1.5*at,pct=kcU-kcL>0?Math.round(Math.max(0,Math.min(1,1-(bbU-bbL)/(kcU-kcL)))*100):0;return{pct,inSq:bbU<kcU&&bbL>kcL};}
function trendStr(c){const e20=ema(c,20),s50=sma(c,50);if(!e20||!s50)return{pct:0,rawPct:0,dir:"neu"};const diff=(e20-s50)/s50*100;return{pct:Math.min(100,Math.abs(diff)*8),rawPct:diff,dir:diff>0.15?"bull":diff<-0.15?"bear":"neu"};}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DAY SCANNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const D_MAX=9;

// High-probability "Buy Today / Sell Today or Tomorrow" score (max 9)
// +2 Price above EMA20/50/200
// +2 Volume spike >1.5x (vs 20d avg)
// +2 Market bullish (QQQ green today)
// +1 RSI in 45â€“60
// +2 Clear upside room (>=2% to 20d high)
function dScore(d, market){
  let pts=0; const tags=[];

  // 1) Trend stack
  const aboveAll = (d.ema20!=null && d.ema50!=null && d.ema200!=null)
    ? (d.price>d.ema20 && d.price>d.ema50 && d.price>d.ema200)
    : false;
  if(aboveAll){ pts+=2; tags.push({t:"EMA20/50/200 âœ“",c:"tg"}); }
  else { tags.push({t:"EMA stack âœ—",c:"tr"}); }

  // 2) Volume spike
  if(d.vr>=1.5){ pts+=2; tags.push({t:`VOL ${d.vr.toFixed(1)}x âœ“`,c:"ty"}); }
  else if(d.vr>0){ tags.push({t:`VOL ${d.vr.toFixed(1)}x`,c:"ta"}); }
  else { tags.push({t:"VOL â€”",c:"ta"}); }

  // 3) Market filter (QQQ)
  if(market?.bull===true){ pts+=2; tags.push({t:`QQQ +${market.chg.toFixed(2)}% âœ“`,c:"tg"}); }
  else if(market?.bull===false){ tags.push({t:`QQQ ${market.chg.toFixed(2)}% âœ—`,c:"tr"}); }
  else { tags.push({t:"QQQ â€”",c:"ta"}); }

  // 4) RSI quality
  if(d.rsi!=null && d.rsi>=45 && d.rsi<=60){ pts+=1; tags.push({t:`RSI ${d.rsi.toFixed(1)} âœ“`,c:"tp"}); }
  else if(d.rsi!=null){ tags.push({t:`RSI ${d.rsi.toFixed(1)}`,c:"ta"}); }
  else { tags.push({t:"RSI â€”",c:"ta"}); }

  // 5) Upside room (to 20d high)
  if(d.roomPct!=null && d.roomPct>=2){ pts+=2; tags.push({t:`ROOM +${d.roomPct.toFixed(1)}% âœ“`,c:"to"}); }
  else if(d.roomPct!=null){ tags.push({t:`ROOM +${d.roomPct.toFixed(1)}%`,c:"ta"}); }
  else { tags.push({t:"ROOM â€”",c:"ta"}); }

  return {pts,tags};
}
function fmt2(x){return (typeof x==='number' && isFinite(x)) ? x.toFixed(2) : 'â€”';}

function dSigLabel(p){
  if(p>=8)return`<span style="color:var(--green);font-weight:700">ğŸ”¥ STRONG</span>`;
  if(p>=7) return`<span style="color:var(--yellow);font-weight:700">âš¡ MOMENTUM</span>`;
  if(p>=5) return`<span style="color:var(--accent);font-weight:700">â—ˆ WATCH</span>`;
  return`<span style="color:var(--dim)">â—‡ WEAK</span>`;
}
function renderDay(data){
  const b = document.getElementById("dBody");
  if(!data.length){ b.innerHTML = `<div class="msg">No results found</div>`; return; }
  const top10 = data.slice(0,10);
  const best  = top10[0];

  try{
    const autoTop = (localStorage.getItem("tg_auto_top") === "1");
    if(autoTop && tgEnabled && best && !best._tgSent){
      best._tgSent = true;
      sendAlert(best.sym, best.name, best.price, best.chgPct, best._s.pts, D_MAX, "TOP PICK", best._tagsText || "");
    }
  }catch(e){}

  const bestCard = best ? `
    <div style="background:rgba(0,255,136,.05);border:1px solid rgba(0,255,136,.2);padding:16px 20px;margin-bottom:2px">
      <div style="font-size:9px;letter-spacing:.18em;color:var(--green);margin-bottom:8px">âœ… TOP PICK</div>
      <div style="display:flex;gap:24px;flex-wrap:wrap;align-items:flex-start">
        <div>
          <div style="font-size:22px;font-weight:900;letter-spacing:.04em">${best.sym} <span style="font-size:13px;color:var(--dim);font-weight:400">${best.name}</span></div>
          <div style="margin-top:4px">${dSigLabel(best._s.pts)} <span style="color:var(--dim);font-size:11px;margin-left:8px">Score ${best._s.pts}/${D_MAX} Â· RSI ${best.rsi!=null?best.rsi.toFixed(1):'â€”'} Â· VOL ${best.vr!=null?best.vr.toFixed(2)+'x':'â€”'} Â· Room ${best.roomPct!=null?best.roomPct.toFixed(1)+'%':'â€”'}</span></div>
          <div style="margin-top:6px;font-size:10px;color:var(--dim)">${(best._tags||[]).join(' Â· ')}</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:4px">
          <div style="background:var(--card);border:1px solid var(--border);padding:8px 14px;border-radius:3px;font-size:12px">
            <div style="font-size:8px;color:var(--dim);letter-spacing:.12em;margin-bottom:3px">ENTRY</div>
            <div style="font-weight:700;color:var(--accent)">$${fmt2(best._trade.entry)}</div>
          </div>
          <div style="background:var(--card);border:1px solid var(--border);padding:8px 14px;border-radius:3px;font-size:12px">
            <div style="font-size:8px;color:var(--dim);letter-spacing:.12em;margin-bottom:3px">STOP LOSS</div>
            <div style="font-weight:700;color:var(--red)">$${fmt2(best._trade.stop)}</div>
          </div>
          <div style="background:var(--card);border:1px solid var(--border);padding:8px 14px;border-radius:3px;font-size:12px">
            <div style="font-size:8px;color:var(--dim);letter-spacing:.12em;margin-bottom:3px">TAKE PROFIT</div>
            <div style="font-weight:700;color:var(--green)">$${fmt2(best._trade.tp)}</div>
          </div>
          <div style="font-size:10px;color:var(--dim)">R:R â‰ˆ ${best._trade.rr.toFixed(2)}x</div>
        </div>
      </div>
    </div>` : "";

  let html = `${bestCard}<div class="sw-wrap"><table style="table-layout:fixed;width:100%"><thead><tr>
    <th style="width:36px">#</th>
    <th style="width:130px">Symbol</th>
    <th style="width:110px">Signal</th>
    <th style="text-align:right;width:80px">Price</th>
    <th style="text-align:right;width:72px">Chg%</th>
    <th style="text-align:right;width:46px">RSI</th>
    <th style="text-align:right;width:54px">VOL</th>
    <th style="text-align:right;width:54px">Room</th>
    <th style="width:220px">Entry Â· Stop Â· Take Profit</th>
    <th style="text-align:center;width:54px">Score</th>
    <th>Reasons</th>
  </tr></thead><tbody>`;

  top10.forEach((d,i)=>{
    const pts = d._s.pts;
    const hl = pts>=7 ? "background:rgba(0,255,136,.06);border-left:3px solid var(--green)" :
               pts>=6 ? "background:rgba(255,215,0,.04);border-left:3px solid var(--yellow)" :
               "border-left:3px solid transparent";
    const chgCol = d.chgPct>=0 ? "color:var(--green)" : "color:var(--red)";
    const rsiCol = d.rsi!=null && d.rsi>=45 && d.rsi<=60 ? "color:var(--green)" : "color:var(--dim)";
    html += `<tr style="${hl}">
      <td style="color:var(--dim)">${i+1}</td>
      <td><b style="font-size:13px;letter-spacing:.04em">${d.sym}</b><br><span style="font-size:9px;color:var(--dim)">${d.name}</span></td>
      <td>${dSigLabel(pts)}</td>
      <td style="text-align:right;font-weight:700">$${fmt2(d.price)}</td>
      <td style="text-align:right;${chgCol};font-weight:600">${d.chgPct>=0?'+':''}${fmt2(d.chgPct)}%</td>
      <td style="text-align:right;${rsiCol}">${d.rsi!=null?d.rsi.toFixed(1):'â€”'}</td>
      <td style="text-align:right">${d.vr!=null?d.vr.toFixed(2)+'x':'â€”'}</td>
      <td style="text-align:right">${d.roomPct!=null?d.roomPct.toFixed(1)+'%':'â€”'}</td>
      <td>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:nowrap">
          <div style="text-align:center">
            <div style="font-size:8px;color:var(--dim);letter-spacing:.1em">ENTRY</div>
            <div style="font-size:11px;font-weight:700;color:var(--accent)">$${fmt2(d._trade.entry)}</div>
          </div>
          <div style="color:var(--dim);font-size:10px">â†’</div>
          <div style="text-align:center">
            <div style="font-size:8px;color:var(--dim);letter-spacing:.1em">STOP</div>
            <div style="font-size:11px;font-weight:700;color:var(--red)">$${fmt2(d._trade.stop)}</div>
          </div>
          <div style="color:var(--dim);font-size:10px">â†’</div>
          <div style="text-align:center">
            <div style="font-size:8px;color:var(--dim);letter-spacing:.1em">TP</div>
            <div style="font-size:11px;font-weight:700;color:var(--green)">$${fmt2(d._trade.tp)}</div>
          </div>
          <div style="font-size:9px;color:var(--dim);margin-left:2px">${d._trade.rr.toFixed(1)}x</div>
        </div>
      </td>
      <td style="text-align:center"><b style="font-size:18px;color:${pts>=7?'var(--green)':pts>=5?'var(--yellow)':'var(--dim)'}">${pts}</b><span style="color:var(--dim);font-size:9px">/${D_MAX}</span></td>
      <td style="color:var(--dim);font-size:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:0">${(d._tags||[]).join(' Â· ')}</td>
    </tr>`;
  });

  html += `</tbody></table></div>`;
  b.innerHTML = html;
}
async function runDay(){
  dCache={};
  const btn=document.getElementById("dBtn"); btn.disabled=true; btn.textContent="SCANNING...";
  document.getElementById("dLog").innerHTML=""; document.getElementById("dLog").className="log on";
  await ensureTickersLoaded("dLog");
  document.getElementById("dProg").className="prog-wrap on";
  document.getElementById("dBody").innerHTML=`<div class="msg"><span class="spin"></span>FETCHING LIVE DATA...</div>`;
  document.getElementById("dDot").style.background="var(--yellow)";
  document.getElementById("dStat").style.color="var(--yellow)"; document.getElementById("dStat").textContent="SCANNING";
  const t0=Date.now(); let spyChg=null, spyPct=0; let qqqChg=null; let market={bull:null, chg:0};
  logTo("dLog",`â–º Scan started at ${new Date().toLocaleTimeString()} â€” data will be fresh (cache-busted)`,"linfo");
  try {
    const spy=await yhDay("SPY"); spyChg=spy.chgPct; spyPct=spy.chgPct||0;
    document.getElementById("dSpyVol").textContent="Live"; document.getElementById("dSpyVol").style.color="var(--accent)";
    logTo("dLog",`âœ“ SPY: $${spy.price.toFixed(2)} Â· ${spyChg>=0?"+":""}${spyChg.toFixed(2)}% Â· fetched ${new Date().toLocaleTimeString()}`,"lok");
  } catch(e){logTo("dLog",`âš  SPY failed: ${e.message}`,"lwarn");}
  try {
    const qqq=await yhDay("QQQ"); qqqChg=qqq.chgPct||0;
    market = {bull: qqqChg>0, chg: qqqChg};
    logTo("dLog",`âœ“ QQQ: $${qqq.price.toFixed(2)} Â· ${qqqChg>=0?"+":""}${qqqChg.toFixed(2)}% (market filter)`,"lok");
  } catch(e){logTo("dLog",`âš  QQQ failed: ${e.message}`,"lwarn");}
  const results=[], total=TICKERS.length;
  logTo("dLog",`â–º Scanning ${total} stocks in parallel batches of 5...`,"linfo");
  const BATCH=5;
  let done=0;
  for(let i=0;i<total;i+=BATCH){
    const batch=TICKERS.slice(i,i+BATCH);
    const br=await Promise.allSettled(batch.map(t=>yhDay(t.sym).then(yh=>{
      const{price,chgPct,high,low,gapPct,candles}=yh;
      const ir=high-low, rs=chgPct-spyPct;
      const vwap=vwapArr(candles?.c,candles?.h,candles?.l,candles?.v);
      const abvVWAP=vwap!==null?price>vwap:null;
      const iv=intVol(candles), av=avgVol(yh.volumes,20);
      const tv=iv>0?iv:(yh.volumes[yh.volumes.length-1]||0);
      const vr=av>0?tv/av:0;
      const at=atr(yh.highs,yh.lows,yh.closes,14);
      const rr=(at>0&&ir>0)?ir/at:0;
      const closes=yh.closes||[], highs=yh.highs||[];
      const ema20v=ema(closes,20), ema50v=ema(closes,50), ema200v=ema(closes,200);
      const rsiv=rsi14(closes);
      const hi20=highs.length>=21?Math.max(...highs.slice(-21,-1)):(highs.length?Math.max(...highs):null);
      const roomPct=(hi20!=null&&price>0)?((hi20-price)/price)*100:null;
      const d={sym:t.sym,name:t.name,price,chgPct,gap:gapPct,rs,vr,rr,abvVWAP,
        ema20:ema20v,ema50:ema50v,ema200:ema200v,rsi:rsiv,roomPct};
      d._s=dScore(d,market);
      d._tags=(d._s.tags||[]).map(x=>x.t);
      d._tagsText=d._tags.join(" Â· ");
      d._flags={trendOK:(d.price>d.ema20&&d.price>d.ema50&&d.price>d.ema200)};
      d._mkt={qqqChgPct:(market&&typeof market.chg==='number')?market.chg:null};
      const atr14=(at!=null&&isFinite(at)&&at>0)?at:(d.price*0.01);
      const entry=d.price, stop=Math.max(0,entry-atr14), tp=entry+(2*atr14);
      d._trade={entry,stop,tp,risk:Math.max(0,entry-stop),reward:Math.max(0,tp-entry),rr:(entry-stop)>0?((tp-entry)/(entry-stop)):0};
      return d;
    })));
    br.forEach((res,j)=>{
      done++; const t=batch[j];
      if(res.status==="fulfilled"){
        const d=res.value; results.push(d);
        logTo("dLog",`âœ“ ${t.sym.padEnd(6)} | SCORE ${d._s.pts}/${D_MAX} | EMA:${d._flags.trendOK?"âœ“":"âœ—"} | VOL:${d.vr?d.vr.toFixed(1)+"x":"â€”"} | RSI:${d.rsi!=null?d.rsi.toFixed(1):"â€”"} | ROOM:${d.roomPct!=null?d.roomPct.toFixed(1)+"%":"â€”"}`,"lok");
      } else {
        logTo("dLog",`âœ— ${t.sym} â€” ${res.reason?.message||"failed"}`,"lerr");
      }
    });
    const pct=Math.round((done/total)*100);
    document.getElementById("dPL").textContent=`${done}/${total} â€” ${batch[batch.length-1].sym}`;
    document.getElementById("dPP").textContent=pct+"%"; document.getElementById("dPF").style.width=pct+"%";
    // Live partial render after every batch
    if(results.length>0){
      const partial=[...results].sort((a,b)=>b._s.pts!==a._s.pts?b._s.pts-a._s.pts:b.chgPct-a.chgPct);
      renderDay(partial);
    }
    await new Promise(r=>setTimeout(r,200));
  }
  results.sort((a,b)=>b._s.pts!==a._s.pts?b._s.pts-a._s.pts:b.chgPct-a.chgPct);
  renderDay(results);
  document.getElementById("d1").textContent=results.length;
  document.getElementById("d2").textContent=results.filter(d=>d.chgPct>=1).length;
  document.getElementById("d3").textContent=results.filter(d=>d.vr>=1.5).length;
  document.getElementById("d4").textContent=results.filter(d=>d.rs>0).length;
  document.getElementById("d5").textContent=results.filter(d=>d.gap>=0.5).length;
  const avg=results.length?(results.reduce((a,b)=>a+b.chgPct,0)/results.length).toFixed(2):"â€”";
  const ae=document.getElementById("d6"); ae.textContent=avg!=="â€”"?(avg>=0?"+":"")+avg+"%":"â€”"; ae.className="snum "+(parseFloat(avg)>=0?"g":"r");
  if(spyChg!==null){document.getElementById("dSpyChg").textContent=(spyChg>=0?"+":"")+spyChg.toFixed(2)+"%";document.getElementById("dSpyChg").style.color=spyChg>=0?"var(--green)":"var(--red)";document.getElementById("dRegime").textContent=spyChg>=0.3?"BULLISH DAY":spyChg<=-0.3?"BEARISH DAY":"CHOPPY";document.getElementById("dRegime").style.color=spyChg>=0.3?"var(--green)":spyChg<=-0.3?"var(--red)":"var(--yellow)";}
  const el=((Date.now()-t0)/1000).toFixed(1);
  document.getElementById("dScanT").textContent=el+"s"; document.getElementById("dScanT").style.color="var(--accent)";
  document.getElementById("dFoot").textContent=`Scanned ${results.length} in ${el}s Â· Top: ${results[0]?.sym||"â€”"} Â· ${new Date().toLocaleTimeString()}`;
  document.getElementById("dDot").style.background="var(--green)"; document.getElementById("dStat").style.color="var(--green)"; document.getElementById("dStat").textContent="DONE";
  document.getElementById("dProg").className="prog-wrap"; document.getElementById("dTime").textContent=new Date().toLocaleTimeString();
  if(results[0]) logTo("dLog",`\nâ–º TOP: ${results[0].sym} â€” ${results[0]._s.pts}/${D_MAX}pts Â· +${results[0].chgPct.toFixed(2)}%`,"linfo");
  btn.disabled=false; btn.textContent="â–¶ RESCAN";
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCALP SCANNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S_MAX=12;
function sScore(d){
  let pts=0; const tags=[];
  if(d.b3){pts+=3;tags.push({t:"3 BULL CANDLES âœ“",c:"tg"});}
  else if(d.b2){pts+=1;tags.push({t:"2 BULL CANDLES",c:"ty"});}
  else tags.push({t:"NO STREAK",c:"tr"});
  if(d.vs>=2.5){pts+=3;tags.push({t:"VOL "+d.vs.toFixed(1)+"x ğŸš€",c:"tg"});}
  else if(d.vs>=1.5){pts+=2;tags.push({t:"VOL "+d.vs.toFixed(1)+"x â†‘",c:"ty"});}
  else if(d.vs>=1.1){pts+=1;tags.push({t:"VOL "+d.vs.toFixed(1)+"x",c:"ta"});}
  else tags.push({t:"VOL WEAK",c:"tr"});
  if(d.abv){pts+=2;tags.push({t:"ABOVE VWAP âœ“",c:"tg"});}else tags.push({t:"BELOW VWAP",c:"tr"});
  if(d.ac){pts+=2;tags.push({t:"ACCEL âš¡",c:"to"});}
  if(d.rs>0.3){pts+=2;tags.push({t:"RS +"+d.rs.toFixed(2)+"%",c:"tg"});}
  else if(d.rs>0){pts+=1;tags.push({t:"RS +"+d.rs.toFixed(2)+"%",c:"ty"});}
  else tags.push({t:"RS "+d.rs.toFixed(2)+"%",c:"tr"});
  return{pts,tags};
}
function sSigLabel(p){
  if(p>=10)return`<span style="color:var(--red);font-weight:700">ğŸ¯ SCALP NOW</span>`;
  if(p>=7) return`<span style="color:var(--orange);font-weight:700">âš¡ STRONG SETUP</span>`;
  if(p>=5) return`<span style="color:var(--yellow);font-weight:700">â—ˆ WATCH</span>`;
  return`<span style="color:var(--dim)">â—‡ SKIP</span>`;
}
function renderScalp(data){
  const b=document.getElementById("sBody");
  if(!data.length){b.innerHTML=`<div class="msg">No setups found</div>`;return;}
  const best=data[0];
  const lvlB=best.lvl, rrB=lvlB.target>lvlB.entry&&lvlB.entry>lvlB.stop?((lvlB.target-lvlB.entry)/(lvlB.entry-lvlB.stop)).toFixed(1):"â€”";
  const bestNote = best ? `
    <div style="background:rgba(255,51,85,.05);border:1px solid rgba(255,51,85,.2);padding:16px 20px;margin-bottom:2px">
      <div style="font-size:9px;letter-spacing:.18em;color:var(--red);margin-bottom:8px">ğŸ¯ BEST SCALP SETUP</div>
      <div style="display:flex;gap:24px;flex-wrap:wrap;align-items:flex-start">
        <div>
          <div style="font-size:22px;font-weight:900;letter-spacing:.04em">${best.sym} <span style="font-size:13px;color:var(--dim);font-weight:400">${best.name}</span></div>
          <div style="margin-top:4px">${sSigLabel(best._s.pts)} <span style="color:var(--dim);font-size:11px;margin-left:8px">Score ${best._s.pts}/${S_MAX} Â· 5m ${best.c5m>=0?'+':''}${best.c5m.toFixed(2)}% Â· VOL ${best.vs.toFixed(1)}x Â· VWAP ${best.abv?'ABOVE âœ“':'BELOW'}</span></div>
          <div style="margin-top:6px;font-size:10px;color:var(--dim)">Entry: wait for green candle confirmation. Stop: below VWAP or intraday low.</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:4px">
          <div style="background:var(--card);border:1px solid var(--border);padding:8px 14px;border-radius:3px;font-size:12px">
            <div style="font-size:8px;color:var(--dim);letter-spacing:.12em;margin-bottom:3px">ENTRY</div>
            <div style="font-weight:700;color:var(--accent)">$${lvlB.entry.toFixed(2)}</div>
          </div>
          <div style="background:var(--card);border:1px solid var(--border);padding:8px 14px;border-radius:3px;font-size:12px">
            <div style="font-size:8px;color:var(--dim);letter-spacing:.12em;margin-bottom:3px">STOP LOSS</div>
            <div style="font-weight:700;color:var(--red)">$${lvlB.stop.toFixed(2)}</div>
          </div>
          <div style="background:var(--card);border:1px solid var(--border);padding:8px 14px;border-radius:3px;font-size:12px">
            <div style="font-size:8px;color:var(--dim);letter-spacing:.12em;margin-bottom:3px">TAKE PROFIT</div>
            <div style="font-weight:700;color:var(--green)">$${lvlB.target.toFixed(2)}</div>
          </div>
          <div style="font-size:10px;color:var(--dim)">R:R â‰ˆ ${rrB}x</div>
        </div>
      </div>
    </div>` : '';

  b.innerHTML = bestNote + data.slice(0,10).map((d,i)=>{
    const sc=d._s; const col=sc.pts>=10?"#ff3355":sc.pts>=7?"#fb923c":sc.pts>=5?"#ffd700":"#3a5a6a";
    const cc=d.c5m>=0?"pos":"neg", cs=d.c5m>=0?"â–²":"â–¼";
    const vF=Math.min(100,(d.vs/3)*100), vC=d.vs>=2?"bfg":d.vs>=1.2?"bfy":"bfr";
    const rsF=Math.min(100,Math.max(0,(d.rs+1)/2*100));
    const lvl=d.lvl, rr=lvl.target>lvl.entry&&lvl.entry>lvl.stop?((lvl.target-lvl.entry)/(lvl.entry-lvl.stop)).toFixed(1):"â€”";
    const th=sc.tags.map(t=>`<span class="tag ${t.c}">${t.t}</span>`).join("");
    return`<div class="scalp-row trow-anim" style="animation-delay:${i*0.05}s">
      <div class="rankbar" style="background:${rbColor(i,'s')}"></div>
      <div class="cell"><span class="rnum ${rnCls(i)}">${i+1}</span></div>
      <div class="cell col"><span class="tsym">${d.sym}</span><span class="tname">${d.name}</span></div>
      <div class="cell col">${sSigLabel(sc.pts)}<div class="sig-tags">${th}</div></div>
      <div class="cell col"><span style="font-size:14px;font-weight:700;color:var(--text)">$${d.price.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}</span><span style="font-size:9px;color:var(--dim)">VWAP $${d.vwap?d.vwap.toFixed(2):"â€”"}</span></div>
      <div class="cell col"><span class="chg ${cc}" style="font-size:13px">${cs}${Math.abs(d.c5m).toFixed(2)}%</span><div class="bar-mini"><div class="bf ${d.c5m>=0?'bfg':'bfr'}" style="width:${Math.min(100,Math.abs(d.c5m)/2*100)}%"></div></div></div>
      <div class="cell col"><span style="font-size:13px;font-weight:700;color:${d.vs>=1.5?'var(--yellow)':'var(--dim)'}">${d.vs>0?d.vs.toFixed(1)+"x":"â€”"}</span><div class="bar-mini"><div class="bf ${vC}" style="width:${vF}%"></div></div></div>
      <div class="cell">${d.abv?`<span style="color:var(--green);font-weight:700">ABOVE âœ“</span>`:`<span style="color:var(--red)">BELOW</span>`}</div>
      <div class="cell">${d.ac?`<span style="color:var(--orange);font-weight:700">ACCEL âš¡</span>`:`<span style="color:var(--dim)">FLAT</span>`}</div>
      <div class="cell"><div class="target-box">
        <span class="te">ENTRY $${lvl.entry.toFixed(2)}</span>
        <span class="tt">TARGET $${lvl.target.toFixed(2)}</span>
        <span class="ts2">STOP $${lvl.stop.toFixed(2)} Â· R:R ${rr}x</span>
      </div></div>
      <div class="cell col"><span style="font-size:13px;font-weight:700;color:${d.rs>0?'var(--green)':'var(--red)'}">${d.rs>0?"+":""}${d.rs.toFixed(2)}%</span><div class="bar-mini"><div class="bf ${d.rs>0?'bfg':'bfr'}" style="width:${rsF}%"></div></div></div>
      <div class="cell col"><span class="score-num" style="color:${col}">${sc.pts}</span><span class="score-den">/${S_MAX}</span><div class="score-bar"><div class="sfs" style="width:${(sc.pts/S_MAX)*100}%"></div></div></div>
    </div>`;
  }).join("");
}
async function runScalp(silent=false){
  sCache={};
  const btn=document.getElementById("sBtn"); btn.disabled=true; btn.textContent="SCANNING...";
  document.getElementById("sLog").innerHTML=""; document.getElementById("sLog").className="log on";
  await ensureTickersLoaded("sLog");
  document.getElementById("sProg").className="prog-wrap on";
  document.getElementById("sBody").innerHTML=`<div class="msg"><span class="spin"></span>SCANNING 5-MIN CANDLES...</div>`;
  document.getElementById("sDot").style.background="var(--yellow)";
  document.getElementById("sStat").style.color="var(--yellow)"; document.getElementById("sStat").textContent="SCANNING";
  const t0=Date.now(); let spy5m=0, spyBull=false, spyAc=false;
  try {
    const sp=await yhScalp("SPY"); spy5m=r5m(sp.candles); spyBull=bullStreak(sp.candles,3); spyAc=isAccel(sp.candles);
    logTo("sLog",`âœ“ SPY 5m: ${spy5m>=0?"+":""}${spy5m.toFixed(2)}% | Bull:${spyBull?"YES":"NO"} | Accel:${spyAc?"YES":"NO"}`,"lok");
    document.getElementById("sSpy5m").textContent=(spy5m>=0?"+":"")+spy5m.toFixed(2)+"% (5m)"; document.getElementById("sSpy5m").style.color=spy5m>=0?"var(--green)":"var(--red)";
    document.getElementById("sRegime").textContent=spyBull?"BULLISH":spy5m>0?"RISING":"FALLING"; document.getElementById("sRegime").style.color=spyBull?"var(--green)":spy5m>0?"var(--yellow)":"var(--red)";
    document.getElementById("sMom").textContent=spyAc?"ACCEL âš¡":"STEADY"; document.getElementById("sMom").style.color=spyAc?"var(--orange)":"var(--dim)";
  } catch(e){logTo("sLog",`âš  SPY failed: ${e.message}`,"lwarn");}
  const results=[], total=TICKERS.length;
  logTo("sLog",`â–º Scanning ${total} stocks for scalp setups in batches of 5...`,"linfo");
  const BATCH=5; let done=0;
  for(let i=0;i<total;i+=BATCH){
    const batch=TICKERS.slice(i,i+BATCH);
    const br=await Promise.allSettled(batch.map(t=>yhScalp(t.sym).then(yh=>{
      const{price,candles}=yh;
      const vwap=vwapObj(candles), abv=vwap!==null?price>vwap:false;
      const vs=vSpike(candles), b3=bullStreak(candles,3), b2=bullStreak(candles,2);
      const ac=isAccel(candles), c5m=r5m(candles), rs=c5m-spy5m, lvl=levels(candles,price);
      const d={sym:t.sym,name:t.name,price,vwap,abv,vs,b3,b2,ac,c5m,rs,lvl};
      d._s=sScore(d); return d;
    })));
    br.forEach((res,j)=>{
      done++; const t=batch[j];
      if(res.status==="fulfilled"){
        const d=res.value; results.push(d);
        logTo("sLog",`âœ“ ${t.sym.padEnd(6)} | 5m:${d.c5m>=0?"+":""}${d.c5m.toFixed(2)}% | VOL:${d.vs.toFixed(1)}x | VWAP:${d.abv?"â–²":"â–¼"} | ${d._s.pts}/${S_MAX}pts`,"lok");
      } else {
        logTo("sLog",`âœ— ${t.sym} â€” ${res.reason?.message||"failed"}`,"lerr");
      }
    });
    const pct=Math.round((done/total)*100);
    document.getElementById("sPL").textContent=`${done}/${total} â€” ${batch[batch.length-1].sym}`;
    document.getElementById("sPP").textContent=pct+"%"; document.getElementById("sPF").style.width=pct+"%";
    await new Promise(r=>setTimeout(r,200));
  }
  results.sort((a,b)=>b._s.pts!==a._s.pts?b._s.pts-a._s.pts:b.c5m-a.c5m);
  renderScalp(results);
  document.getElementById("s1").textContent=results.length;
  document.getElementById("s2").textContent=results.filter(d=>d.b3).length;
  document.getElementById("s3").textContent=results.filter(d=>d.vs>=1.5).length;
  document.getElementById("s4").textContent=results.filter(d=>d.abv).length;
  document.getElementById("s5").textContent=results.filter(d=>d.ac).length;
  document.getElementById("s6").textContent=results.filter(d=>d._s.pts>=7).length;
  const el=((Date.now()-t0)/1000).toFixed(1);
  document.getElementById("sScanT").textContent=el+"s"; document.getElementById("sScanT").style.color="var(--accent)";
  document.getElementById("sFoot").textContent=`Scanned ${results.length} in ${el}s Â· Top: ${results[0]?.sym||"â€”"} Â· ${new Date().toLocaleTimeString()}`;
  document.getElementById("sDot").style.background="var(--green)"; document.getElementById("sStat").style.color="var(--green)"; document.getElementById("sStat").textContent="DONE";
  document.getElementById("sProg").className="prog-wrap"; document.getElementById("sTime").textContent=new Date().toLocaleTimeString();
  if(results[0]) logTo("sLog",`\nğŸ¯ TOP: ${results[0].sym} â€” ${results[0]._s.pts}/${S_MAX}pts Â· Entry $${results[0].lvl.entry.toFixed(2)} â†’ Target $${results[0].lvl.target.toFixed(2)}`,"linfo");
  for(const x of results.filter(d=>d._s.pts>=7)){
    const l=x.lvl;
    // Only send Telegram on manual scans â€” auto-monitor handles its own 11+ alerts separately
    if (!silent) {
      await sendAlert(x.sym,x.name,x.price,x.c5m,x._s.pts,S_MAX,x._s.pts>=10?"SCALP NOW":"STRONG SETUP",x._s.tags.map(t=>t.t).join(" Â· ")+` Â· Entry $${l.entry.toFixed(2)} Target $${l.target.toFixed(2)} Stop $${l.stop.toFixed(2)}`);
      await new Promise(r=>setTimeout(r,300));
    }
  }
  btn.disabled=false; btn.textContent="â–¶ RESCAN";
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SWING SCANNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const W_MAX=13;
function wScore(d){
  let pts=0; const tags=[];
  if(d.trend.dir==="bull"){pts+=3;tags.push({t:"â–² BULLISH TREND",c:"stg"});}
  else if(d.trend.dir==="bear") tags.push({t:"â–¼ BEARISH",c:"str"});
  if(d.trend.pct>10){pts+=2;tags.push({t:`STRENGTH ${d.trend.pct.toFixed(0)}%`,c:"sty"});}
  if(d.sqPct>70){pts+=2;tags.push({t:`SQUEEZE ${d.sqPct}%`,c:"stp"});}
  else if(d.sqPct>50){pts+=1;tags.push({t:`SQUEEZE ${d.sqPct}%`,c:"stb"});}
  if(d.ema200&&d.price>d.ema200){pts+=2;tags.push({t:"ABOVE EMA200",c:"stg"});}
  else if(d.ema200&&d.price<d.ema200) tags.push({t:"BELOW EMA200",c:"str"});
  if(d.rsi<30){pts+=3;tags.push({t:`RSI ${d.rsi.toFixed(1)} OVERSOLD â˜…`,c:"stg"});}
  else if(d.rsi<=65){pts+=2;tags.push({t:`RSI ${d.rsi.toFixed(1)} BUY ZONE`,c:"sty"});}
  else tags.push({t:`RSI ${d.rsi.toFixed(1)} HIGH`,c:"str"});
  if(d.sma50&&d.price<d.sma50){pts+=1;tags.push({t:"DIP vs SMA50",c:"stb"});}
  return{pts,tags};
}
function wRankColor(i){return i===0?"#f59e0b":i===1?"#94a3b8":i===2?"#b45309":"#1a2535";}
function renderSwingRow(d,rank,s,delay){
  const cc=d.chgPct>=0?"pos":"neg", cs=d.chgPct>=0?"â–²":"â–¼";
  const rCls=d.rsi<30?"oversold":d.rsi>70?"overbought":"neutral";
  const rMf=d.rsi<30?"mfg":d.rsi>70?"mfr":"mfy";
  const e20c=d.ema20?(d.price>=d.ema20?"ema-above":"ema-below"):"";
  const e200c=d.ema200?(d.price>=d.ema200?"ema-above":"ema-below"):"";
  const s50c=d.sma50?(d.price>=d.sma50?"ema-above":"ema-below"):"";
  const tCls=d.trend.dir==="bull"?"num-bull":d.trend.dir==="bear"?"num-bear":"num-dim";
  const tMf=d.trend.dir==="bull"?"mfbull":d.trend.dir==="bear"?"mfbear":"mfd";
  const sqCls=d.sqPct>70?"sq-fire":d.sqPct>40?"sq-warm":"sq-cool";
  const sqMf=d.sqPct>70?"mfp":d.sqPct>40?"mfb":"mfd";
  const sc=s.pts>=9?"#00e5a0":s.pts>=6?"#fbbf24":"#7a9ab8";
  const sig=s.pts>=9?`<span class="signal-main strong">â˜… STRONG BUY</span>`:s.pts>=6?`<span class="signal-main watch">â—ˆ WATCH</span>`:`<span class="signal-main">â—‡ WEAK</span>`;
  const f=v=>v!=null?v.toFixed(2):"â€”";
  return`<tr class="data-row" style="animation-delay:${delay}s">
    <td><div class="rank-cell"><div class="rank-bar" style="background:${wRankColor(rank)}"></div><span class="rank-num ${rank<3?"top3":""}">${rank+1}</span></div></td>
    <td><div class="t-sym">${d.sym}</div><div class="t-name">${d.name}</div></td>
    <td>${sig}<div class="sig-tags">${s.tags.map(t=>`<span class="${t.c}">${t.t}</span>`).join("")}</div></td>
    <td><div class="price-val">$${d.price.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}</div><div class="swchg ${cc}">${cs} ${Math.abs(d.chgPct).toFixed(2)}%</div></td>
    <td><div class="rsi-num ${rCls}">${d.rsi!=null?d.rsi.toFixed(1):"â€”"}</div><div class="mini-bar"><div class="mini-fill ${rMf}" style="width:${Math.min(100,d.rsi||0)}%"></div></div></td>
    <td><span class="ema-val ${e20c}">${f(d.ema20)}</span></td>
    <td><span class="ema-val ${e200c}">${f(d.ema200)}</span></td>
    <td><span class="ema-val ${s50c}">${f(d.sma50)}</span></td>
    <td><div class="${tCls}">${d.trend.rawPct!=null?(d.trend.rawPct>=0?"+":"")+d.trend.rawPct.toFixed(2)+"%":"â€”"}</div><div class="mini-bar"><div class="mini-fill ${tMf}" style="width:${d.trend.pct||0}%"></div></div></td>
    <td><div class="${sqCls}">${d.sqPct!=null?d.sqPct+"%":"â€”"}</div><div class="mini-bar"><div class="mini-fill ${sqMf}" style="width:${d.sqPct||0}%"></div></div></td>
    <td><div class="score-cell"><span class="sw-score-num" style="color:${sc}">${s.pts}</span><span class="sw-score-den">/${W_MAX}</span><div class="sw-score-bar"><div class="sw-score-fill" style="width:${(s.pts/W_MAX)*100}%"></div></div></div></td>
  </tr>`;
}
function updateSwingTable(results){
  const sorted=[...results].sort((a,b)=>b._s.pts!==a._s.pts?b._s.pts-a._s.pts:(a.rsi||99)-(b.rsi||99));
  document.getElementById("wBody").innerHTML=sorted.slice(0,10).length
    ?sorted.slice(0,10).map((d,i)=>renderSwingRow(d,i,d._s,i*0.06)).join("")
    :`<tr class="msg-row"><td colspan="11">No results yet...</td></tr>`;
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO-MONITOR â€” continuous scan every 5 min, Telegram alert at 11-12 pts
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let autoMonitorEnabled = false;
let autoMonitorTimer   = null;
let autoMonitorAlerted = {};   // sym -> timestamp, prevents repeat alerts within 30 min
const AM_INTERVAL_MS   = 5 * 60 * 1000;  // 5 minutes
const AM_MIN_SCORE     = 11;              // alert threshold

function syncAutoMonitorUI() {
  const on = autoMonitorEnabled;
  document.getElementById("amTrack").style.background  = on ? "var(--red)"   : "var(--muted)";
  document.getElementById("amTrack").style.borderColor = on ? "var(--red)"   : "var(--border)";
  document.getElementById("amThumb").style.background  = on ? "#fff"         : "var(--dim)";
  document.getElementById("amThumb").style.left        = on ? "22px"         : "3px";
  document.getElementById("amLabel").textContent       = on ? "ğŸ” AUTO-MONITOR ON"  : "ğŸ” AUTO-MONITOR OFF";
  document.getElementById("amLabel").style.color       = on ? "var(--red)"   : "var(--dim)";
  document.getElementById("amStatus").style.color      = on ? "var(--orange)": "var(--dim)";
  document.getElementById("amStatus").textContent      = on
    ? `â± Next scan in ${AM_INTERVAL_MS/60000} min Â· alerting Telegram at ${AM_MIN_SCORE}+ pts`
    : `Scans every ${AM_INTERVAL_MS/60000} min Â· alerts Telegram at ${AM_MIN_SCORE}â€“12 pts`;
}

function toggleAutoMonitor() {
  autoMonitorEnabled = !autoMonitorEnabled;
  syncAutoMonitorUI();
  if (autoMonitorEnabled) {
    // Warn if Telegram not configured
    if (!TG_TOKEN || !TG_CHAT_ID) {
      openTGSettings();
      const waitCheck = setInterval(()=>{
        if (TG_TOKEN && TG_CHAT_ID) { clearInterval(waitCheck); startAutoMonitor(); }
      }, 1000);
      return;
    }
    startAutoMonitor();
  } else {
    stopAutoMonitor();
  }
}

function startAutoMonitor() {
  stopAutoMonitor(); // clear any existing timer
  autoMonitorAlerted = {};
  logTo("sLog", `ğŸ” Auto-monitor started â€” scanning every ${AM_INTERVAL_MS/60000} min, alerting at ${AM_MIN_SCORE}+ pts`, "linfo");
  // Run immediately, then on interval
  runAutoMonitorScan();
  autoMonitorTimer = setInterval(runAutoMonitorScan, AM_INTERVAL_MS);
  updateAmCountdown();
}

function stopAutoMonitor() {
  if (autoMonitorTimer) { clearInterval(autoMonitorTimer); autoMonitorTimer = null; }
  if (window._amCountdownTimer) { clearInterval(window._amCountdownTimer); window._amCountdownTimer = null; }
}

// Countdown display in the status line
function updateAmCountdown() {
  if (window._amCountdownTimer) clearInterval(window._amCountdownTimer);
  let secsLeft = AM_INTERVAL_MS / 1000;
  window._amCountdownTimer = setInterval(()=>{
    if (!autoMonitorEnabled) { clearInterval(window._amCountdownTimer); return; }
    secsLeft--;
    if (secsLeft <= 0) secsLeft = AM_INTERVAL_MS / 1000;
    const m = Math.floor(secsLeft/60), s = secsLeft%60;
    document.getElementById("amStatus").textContent =
      `â± Next scan in ${m}:${String(s).padStart(2,'0')} Â· alerting at ${AM_MIN_SCORE}â€“12 pts`;
  }, 1000);
}

async function runAutoMonitorScan() {
  if (!autoMonitorEnabled) return;
  sCache = {}; // always fresh data
  document.getElementById("sDot").style.background = "var(--orange)";
  document.getElementById("sStat").textContent = "AUTO-SCAN";
  document.getElementById("sStat").style.color  = "var(--orange)";
  document.getElementById("sBody").innerHTML = `<div class="msg"><span class="spin"></span>AUTO-MONITOR SCANNING...</div>`;

  const logId = "sLog";
  logTo(logId, `ğŸ” [${new Date().toLocaleTimeString()}] Auto-monitor scan starting...`, "linfo");

  await ensureTickersLoaded(logId);

  let spy5m = 0, spyBull = false, spyAc = false;
  try {
    const sp = await yhScalp("SPY");
    spy5m = r5m(sp.candles);
    spyBull = bullStreak(sp.candles, 3);
    spyAc   = isAccel(sp.candles);
    document.getElementById("sSpy5m").textContent  = (spy5m>=0?"+":"")+spy5m.toFixed(2)+"% (5m)";
    document.getElementById("sSpy5m").style.color  = spy5m>=0?"var(--green)":"var(--red)";
    document.getElementById("sRegime").textContent = spyBull?"BULLISH":spy5m>0?"RISING":"FALLING";
    document.getElementById("sRegime").style.color = spyBull?"var(--green)":spy5m>0?"var(--yellow)":"var(--red)";
    document.getElementById("sMom").textContent    = spyAc?"ACCEL âš¡":"STEADY";
    document.getElementById("sMom").style.color    = spyAc?"var(--orange)":"var(--dim)";
  } catch(e) {}

  const total = TICKERS.length, BATCH = 5;
  const allResults = [];   // ALL scored tickers for table rendering
  const hotAlerts  = [];   // only 11+ for Telegram
  const now = Date.now();
  let done = 0;

  for (let i = 0; i < total; i += BATCH) {
    if (!autoMonitorEnabled) break;
    const batch = TICKERS.slice(i, i + BATCH);
    const br = await Promise.allSettled(batch.map(t => yhScalp(t.sym).then(yh => {
      const { price, candles } = yh;
      const vwap = vwapObj(candles), abv = vwap !== null ? price > vwap : false;
      const vs = vSpike(candles), b3 = bullStreak(candles,3), b2 = bullStreak(candles,2);
      const ac = isAccel(candles), c5m = r5m(candles), rs = c5m - spy5m, lvl = levels(candles, price);
      const d = { sym:t.sym, name:t.name, price, vwap, abv, vs, b3, b2, ac, c5m, rs, lvl };
      d._s = sScore(d);
      return d;
    })));
    br.forEach((res, j) => {
      done++;
      if (res.status !== "fulfilled") return;
      const d = res.value;
      allResults.push(d);
      if (d._s.pts >= AM_MIN_SCORE) {
        const lastAlert = autoMonitorAlerted[d.sym] || 0;
        if (now - lastAlert > 30 * 60 * 1000) {
          hotAlerts.push(d);
          autoMonitorAlerted[d.sym] = now;
        }
      }
    });
    // Live partial render every batch
    if (allResults.length > 0) {
      const sorted = [...allResults].sort((a,b) => b._s.pts !== a._s.pts ? b._s.pts - a._s.pts : b.c5m - a.c5m);
      renderScalp(sorted);
    }
    const pct = Math.round((done/total)*100);
    document.getElementById("sPL").textContent = `${done}/${total}`;
    document.getElementById("sPP").textContent = pct+"%";
    document.getElementById("sPF").style.width  = pct+"%";
    document.getElementById("sProg").className  = "prog-wrap on";
    await new Promise(r => setTimeout(r, 150));
  }

  // Final sorted render
  allResults.sort((a,b) => b._s.pts !== a._s.pts ? b._s.pts - a._s.pts : b.c5m - a.c5m);
  renderScalp(allResults);

  // Update stats bar
  document.getElementById("s1").textContent = allResults.length;
  document.getElementById("s2").textContent = allResults.filter(d=>d.b3).length;
  document.getElementById("s3").textContent = allResults.filter(d=>d.vs>=1.5).length;
  document.getElementById("s4").textContent = allResults.filter(d=>d.abv).length;
  document.getElementById("s5").textContent = allResults.filter(d=>d.ac).length;
  document.getElementById("s6").textContent = allResults.filter(d=>d._s.pts>=7).length;
  document.getElementById("sProg").className = "prog-wrap";
  document.getElementById("sFoot").textContent = `Auto-monitor Â· ${allResults.length} scanned Â· ${new Date().toLocaleTimeString()}`;

  // Send Telegram for 11+ only
  if (hotAlerts.length === 0) {
    logTo(logId, `ğŸ” [${new Date().toLocaleTimeString()}] No ${AM_MIN_SCORE}+ pt setups found this cycle.`, "linfo");
  } else {
    for (const d of hotAlerts) {
      const l = d.lvl;
      const tagStr = d._s.tags.map(t => t.t).join(" Â· ");
      logTo(logId, `ğŸ”¥ ALERT: ${d.sym} scored ${d._s.pts}/${S_MAX} pts â€” sending Telegram!`, "lok");
      const prevEnabled = tgEnabled;
      tgEnabled = true;
      await sendAlert(d.sym, d.name, d.price, d.c5m, d._s.pts, S_MAX, `ğŸ¯ SCALP ${d._s.pts}/${S_MAX}`, tagStr + ` Â· Entry $${l.entry.toFixed(2)} TP $${l.target.toFixed(2)} Stop $${l.stop.toFixed(2)}`);
      tgEnabled = prevEnabled;
      await new Promise(r => setTimeout(r, 300));
    }
  }

  document.getElementById("sDot").style.background = "var(--green)";
  document.getElementById("sStat").textContent = "AUTO";
  document.getElementById("sStat").style.color  = "var(--orange)";
  document.getElementById("sTime").textContent  = new Date().toLocaleTimeString();
  updateAmCountdown();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TICKER LOOKUP â€” analyze any symbol with scalp scoring
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function lookupTicker() {
  const input = document.getElementById("lookupInput");
  const out   = document.getElementById("lookupOut");
  const btn   = document.getElementById("lookupBtn");
  const sym   = (input.value||"").trim().toUpperCase().replace(/[^A-Z0-9.\-]/g,"");
  if (!sym) { out.innerHTML = `<div style="color:var(--red);font-size:11px">Enter a ticker symbol first.</div>`; return; }

  btn.disabled = true; btn.textContent = "LOADING...";
  out.innerHTML = `<div style="font-size:11px;color:var(--dim)"><span class="spin"></span> Fetching 5-min data for <b>${sym}</b>...</div>`;

  // Get current SPY 5m move as baseline (use cached if available)
  let spy5m = 0;
  try {
    const sp = await yhScalp("SPY");
    spy5m = r5m(sp.candles);
  } catch(e) {}

  try {
    // Clear cache so we get fresh data
    delete sCache[sym];
    const yh = await yhScalp(sym);
    const { price, candles } = yh;
    const vwap = vwapObj(candles);
    const abv  = vwap !== null ? price > vwap : false;
    const vs   = vSpike(candles);
    const b3   = bullStreak(candles, 3);
    const b2   = bullStreak(candles, 2);
    const ac   = isAccel(candles);
    const c5m  = r5m(candles);
    const rs   = c5m - spy5m;
    const lvl  = levels(candles, price);
    const d    = { sym, name: sym, price, vwap, abv, vs, b3, b2, ac, c5m, rs, lvl };
    d._s = sScore(d);

    const sc   = d._s;
    const rr   = lvl.target > lvl.entry && lvl.entry > lvl.stop
                 ? ((lvl.target - lvl.entry) / (lvl.entry - lvl.stop)).toFixed(1) : "â€”";
    const verdict = sc.pts >= 10 ? { label:"ğŸ¯ SCALP NOW",   col:"var(--red)",    bg:"rgba(255,51,85,.08)",   border:"rgba(255,51,85,.3)" }
                  : sc.pts >= 7  ? { label:"âš¡ STRONG SETUP", col:"var(--orange)", bg:"rgba(251,146,60,.08)",  border:"rgba(251,146,60,.3)" }
                  : sc.pts >= 5  ? { label:"â—ˆ WATCH",         col:"var(--yellow)", bg:"rgba(255,215,0,.06)",   border:"rgba(255,215,0,.25)" }
                  :                { label:"â—‡ SKIP",           col:"var(--dim)",    bg:"rgba(255,255,255,.02)", border:"var(--border)" };

    const tags = sc.tags.map(t => `<span class="tag ${t.c}">${t.t}</span>`).join(" ");
    const chgCol = c5m >= 0 ? "var(--green)" : "var(--red)";
    const rsCol  = rs  >= 0 ? "var(--green)" : "var(--red)";

    out.innerHTML = `
      <div style="background:${verdict.bg};border:1px solid ${verdict.border};border-radius:3px;padding:16px 20px">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px">
          <div>
            <div style="font-size:28px;font-weight:900;letter-spacing:.04em;font-family:'Bebas Neue',sans-serif">${sym}</div>
            <div style="margin-top:4px;font-size:18px;font-weight:700;color:${verdict.col}">${verdict.label}</div>
            <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">${tags}</div>
          </div>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;min-width:280px">
            <div style="background:var(--card);border:1px solid var(--border);padding:10px 12px;border-radius:3px;text-align:center">
              <div style="font-size:8px;color:var(--dim);letter-spacing:.12em;margin-bottom:4px">PRICE</div>
              <div style="font-size:15px;font-weight:700">$${price.toFixed(2)}</div>
            </div>
            <div style="background:var(--card);border:1px solid var(--border);padding:10px 12px;border-radius:3px;text-align:center">
              <div style="font-size:8px;color:var(--dim);letter-spacing:.12em;margin-bottom:4px">5M CHG</div>
              <div style="font-size:15px;font-weight:700;color:${chgCol}">${c5m>=0?'+':''}${c5m.toFixed(2)}%</div>
            </div>
            <div style="background:var(--card);border:1px solid var(--border);padding:10px 12px;border-radius:3px;text-align:center">
              <div style="font-size:8px;color:var(--dim);letter-spacing:.12em;margin-bottom:4px">VS SPY</div>
              <div style="font-size:15px;font-weight:700;color:${rsCol}">${rs>=0?'+':''}${rs.toFixed(2)}%</div>
            </div>
            <div style="background:var(--card);border:1px solid var(--border);padding:10px 12px;border-radius:3px;text-align:center">
              <div style="font-size:8px;color:var(--dim);letter-spacing:.12em;margin-bottom:4px">VOL SPIKE</div>
              <div style="font-size:15px;font-weight:700;color:${vs>=1.5?'var(--yellow)':'var(--dim)'}">${vs.toFixed(1)}x</div>
            </div>
            <div style="background:var(--card);border:1px solid var(--border);padding:10px 12px;border-radius:3px;text-align:center">
              <div style="font-size:8px;color:var(--dim);letter-spacing:.12em;margin-bottom:4px">VWAP</div>
              <div style="font-size:15px;font-weight:700;color:${abv?'var(--green)':'var(--red)'}">${abv?'ABOVE âœ“':'BELOW âœ—'}</div>
            </div>
            <div style="background:var(--card);border:1px solid var(--border);padding:10px 12px;border-radius:3px;text-align:center">
              <div style="font-size:8px;color:var(--dim);letter-spacing:.12em;margin-bottom:4px">SCORE</div>
              <div style="font-size:15px;font-weight:700;color:${verdict.col}">${sc.pts}/${S_MAX}</div>
            </div>
          </div>
        </div>
        <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <div style="background:var(--card);border:1px solid var(--border);padding:10px 16px;border-radius:3px;text-align:center">
            <div style="font-size:8px;color:var(--dim);letter-spacing:.12em;margin-bottom:4px">ENTRY</div>
            <div style="font-size:16px;font-weight:700;color:var(--accent)">$${lvl.entry.toFixed(2)}</div>
          </div>
          <div style="color:var(--dim)">â†’</div>
          <div style="background:var(--card);border:1px solid var(--border);padding:10px 16px;border-radius:3px;text-align:center">
            <div style="font-size:8px;color:var(--dim);letter-spacing:.12em;margin-bottom:4px">STOP LOSS</div>
            <div style="font-size:16px;font-weight:700;color:var(--red)">$${lvl.stop.toFixed(2)}</div>
          </div>
          <div style="color:var(--dim)">â†’</div>
          <div style="background:var(--card);border:1px solid var(--border);padding:10px 16px;border-radius:3px;text-align:center">
            <div style="font-size:8px;color:var(--dim);letter-spacing:.12em;margin-bottom:4px">TAKE PROFIT</div>
            <div style="font-size:16px;font-weight:700;color:var(--green)">$${lvl.target.toFixed(2)}</div>
          </div>
          <div style="font-size:12px;color:var(--dim);margin-left:6px">R:R ${rr}x Â· VWAP $${vwap!=null?vwap.toFixed(2):'â€”'}</div>
        </div>
        <div style="margin-top:10px;font-size:10px;color:var(--dim)">
          ${b3?'âœ“ 3 bull candles' : b2?'~ 2 bull candles':'âœ— No bull streak'} Â·
          ${ac?'âš¡ Momentum accelerating':'Momentum flat'} Â·
          Candles loaded: ${candles.length} Â· Updated: ${new Date().toLocaleTimeString()}
        </div>
      </div>`;
  } catch(e) {
    out.innerHTML = `<div style="background:rgba(255,51,85,.07);border:1px solid rgba(255,51,85,.2);padding:12px 16px;font-size:11px;color:var(--red)">
      âœ— Could not fetch data for <b>${sym}</b>: ${e.message}<br>
      <span style="color:var(--dim);margin-top:4px;display:block">Make sure the ticker is valid (e.g. TSLA, ZS, PLTR). OTC stocks may not be supported.</span>
    </div>`;
  }

  btn.disabled = false; btn.textContent = "â–¶ ANALYZE";
}

async function runSwing(){
  wCache={};
  const btn=document.getElementById("wBtn"); btn.disabled=true; btn.textContent="SCANNING...";
  document.getElementById("wLog").innerHTML=""; document.getElementById("wLog").className="log on";
  await ensureTickersLoaded("wLog");
  document.getElementById("wProg").className="prog-wrap on";
  document.getElementById("wBody").innerHTML=`<tr class="msg-row"><td colspan="11"><span class="spin"></span>SCANNING ALL 100 NDX TICKERS...</td></tr>`;
  const total=TICKERS.length, results=[];  let done=0;
  logTo("wLog",`â–º Scanning all ${total} NDX-100 tickers Â· batches of 5 Â· est. ~60s`,"linfo");
  const BATCH=5;
  for(let i=0;i<total;i+=BATCH){
    const batch=TICKERS.slice(i,i+BATCH);
    const br=await Promise.allSettled(batch.map(t=>yhSwing(t.sym).then(yf=>{
      const{closes,highs,lows,price,chgPct}=yf;
      const sq=squeeze(highs,lows,closes);
      const d={sym:t.sym,name:t.name,price,chgPct,
        rsi:rsi14(closes), ema20:ema(closes,20),
        ema200:closes.length>=200?ema(closes,200):null,
        sma50:sma(closes,50), trend:trendStr(closes),
        sqPct:sq.pct, inSq:sq.inSq};
      d._s=wScore(d); return d;
    })));
    br.forEach((res,j)=>{
      done++; const t=batch[j];
      if(res.status==="fulfilled"){
        const d=res.value; results.push(d);
        logTo("wLog",`âœ“ ${t.sym.padEnd(6)} | $${d.price.toFixed(2).padStart(8)} | RSI:${d.rsi?d.rsi.toFixed(1).padStart(5):"  â€”"} | ${d.trend.dir.toUpperCase().padEnd(4)} | Sq:${d.sqPct!=null?String(d.sqPct+"%").padStart(4):"  â€”"} | ${d._s.pts}/${W_MAX}pts`,"lok");
      } else {
        logTo("wLog",`âœ— ${t.sym} â€” ${res.reason?.message||"failed"}`,"lerr");
      }
    });
    const pct=Math.round((done/total)*100);
    document.getElementById("wPL").textContent=`${done}/${total} scanned`;
    document.getElementById("wPP").textContent=pct+"%"; document.getElementById("wPF").style.width=pct+"%";
    document.getElementById("w1").textContent=results.length;
    document.getElementById("w2").textContent=results.filter(r=>r.trend.dir==="bull").length;
    document.getElementById("w3").textContent=results.filter(r=>r.rsi&&r.rsi>=30&&r.rsi<=65).length;
    document.getElementById("w4").textContent=results.filter(r=>r.sqPct>70).length;
    document.getElementById("w5").textContent=results.filter(r=>r.rsi&&r.rsi<30).length;
    const rv=results.filter(r=>r.rsi!=null);
    document.getElementById("w6").textContent=rv.length?(rv.reduce((a,b)=>a+b.rsi,0)/rv.length).toFixed(1):"â€”";
    updateSwingTable(results);
    if(i+BATCH<total) await new Promise(r=>setTimeout(r,900));
  }
  document.getElementById("wProg").className="prog-wrap";
  btn.disabled=false; btn.textContent="â–¶ RESCAN ALL 100";
  const sorted=[...results].sort((a,b)=>b._s.pts!==a._s.pts?b._s.pts-a._s.pts:(a.rsi||99)-(b.rsi||99));
  document.getElementById("wFoot").textContent=`Scanned ${results.length}/${total} Â· Top: ${sorted[0]?.sym||"â€”"} (${sorted[0]?._s.pts||0}/${W_MAX} pts) Â· ${new Date().toLocaleTimeString()}`;
  if(sorted[0]) logTo("wLog",`\nâ–º TOP: ${sorted[0].sym} â€” ${sorted[0]._s.pts}/${W_MAX}pts Â· RSI ${sorted[0].rsi?.toFixed(1)} Â· ${sorted[0].trend.dir.toUpperCase()}`,"linfo");
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Pre-market + Open Momentum scanners (intraday 5m)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const NY_TZ = "America/New_York";
const nyFmt = new Intl.DateTimeFormat("en-US", { timeZone: NY_TZ, hour: "2-digit", minute: "2-digit", hour12: false, year:"numeric", month:"2-digit", day:"2-digit" });

function nyParts(date){
  const parts = nyFmt.formatToParts(date);
  const o = {};
  for (const p of parts) o[p.type] = p.value;
  return {
    y: +o.year, m:+o.month, d:+o.day,
    hh:+o.hour, mm:+o.minute
  };
}
function inRangeHM(hh,mm, h1,m1, h2,m2){
  const t = hh*60+mm, a=h1*60+m1, b=h2*60+m2;
  return t>=a && t<=b;
}
function calcVWAP(closes, volumes){
  let pv=0, vv=0;
  for(let i=0;i<closes.length;i++){
    const c=closes[i], v=volumes[i]||0;
    if(c==null || !isFinite(c) || v<=0) continue;
    pv += c*v; vv += v;
  }
  return vv>0 ? (pv/vv) : null;
}

async function fetchChart(sym, range, interval, prepost){
  const url = `https://query2.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(sym)}?range=${range}&interval=${interval}&includePrePost=${prepost?'true':'false'}&events=div%2Csplit`;
  const r = await proxyFetch(url);
  const j = await r.json();
  const res = j?.chart?.result?.[0];
  if(!res) throw new Error("No chart data");
  const q = res.indicators?.quote?.[0] || {};
  return {
    meta: res.meta || {},
    ts: res.timestamp || [],
    open: q.open || [],
    high: q.high || [],
    low: q.low || [],
    close: q.close || [],
    vol: q.volume || []
  };
}

async function runPreMarket(){
  const btn = document.getElementById("pmBtn");
  const out = document.getElementById("pmOut");
  btn.disabled = true; btn.textContent = "SCANNINGâ€¦";
  out.innerHTML = `<div class="msg"><span class="spin"></span>Loading pre-market moversâ€¦</div>`;
  await ensureTickersLoaded("dLog");

  // QQQ market bias (today change)
  let qqqChg = null;
  try{
    const qqq = await fetchChart("QQQ","1d","5m",true);
    const prev = qqq.meta?.previousClose;
    const last = qqq.meta?.regularMarketPrice ?? qqq.close.filter(x=>x!=null).slice(-1)[0];
    if(prev && last) qqqChg = ((last-prev)/prev)*100;
  }catch(e){}

  const results = [];
  const maxN = Math.min(100, TICKERS.length);

  for(let i=0;i<maxN;i++){
    const t = TICKERS[i];
    try{
      const ch = await fetchChart(t.sym,"1d","5m",true);
      const prevClose = ch.meta?.previousClose;
      if(!prevClose || !isFinite(prevClose)) continue;

      // Filter pre-market 04:00â€“09:30 ET
      const pmClose=[], pmVol=[];
      for(let k=0;k<ch.ts.length;k++){
        const p = nyParts(new Date(ch.ts[k]*1000));
        if(inRangeHM(p.hh,p.mm,4,0,9,30)){
          pmClose.push(ch.close[k]);
          pmVol.push(ch.vol[k]||0);
        }
      }
      const lastPM = pmClose.filter(x=>x!=null).slice(-1)[0];
      if(!lastPM || !isFinite(lastPM)) continue;

      const gapPct = ((lastPM - prevClose)/prevClose)*100;
      const pmV = pmVol.reduce((a,b)=>a+(b||0),0);
      const vwap = calcVWAP(pmClose, pmVol);
      const aboveVWAP = (vwap!=null) ? (lastPM>vwap) : false;

      // Score: gap + volume + above VWAP + QQQ bias
      let pts = 0;
      const tags=[];
      if(gapPct>=0.5) { pts+=2; tags.push(`Gap +${gapPct.toFixed(2)}%`); }
      else if(gapPct<=-0.5){ tags.push(`Gap ${gapPct.toFixed(2)}%`); }
      else { tags.push(`Gap ${gapPct.toFixed(2)}%`); }

      const dolV = pmV * lastPM;
      if(dolV >= 5_000_000){ pts+=2; tags.push("PM $Vol high"); }
      else if(dolV >= 1_000_000){ pts+=1; tags.push("PM $Vol"); }
      else { tags.push("PM $Vol low"); }

      if(aboveVWAP){ pts+=1; tags.push("Above VWAP"); }
      if(qqqChg!=null && qqqChg>0){ pts+=1; tags.push("QQQ green"); }

      results.push({sym:t.sym,name:t.name,gapPct,pmV,pmDol:dolV,last:lastPM,vwap,pts,tags});
    }catch(e){}
    if(i%10===0) await new Promise(r=>setTimeout(r,120));
  }

  results.sort((a,b)=> (b.pts-a.pts) || (b.pmDol-a.pmDol));
  const top10 = results.slice(0,10);

  if(!top10.length){
    out.innerHTML = `<div class="msg">No pre-market data found (try closer to market open).</div>`;
  }else{
    let html = `<div class="msg" style="text-align:left">
      <div style="font-weight:900;letter-spacing:.08em;color:var(--green)">TOP 10 PRE-MARKET</div>
      <div style="color:var(--dim);margin-top:6px;font-size:12px">Ranked by gap + premarket dollar volume + VWAP + QQQ bias</div>
    </div>
    <div class="sw-wrap"><table><thead><tr>
      <th>#</th><th>Symbol</th><th>Gap%</th><th>Last</th><th>PM $Vol</th><th>VWAP</th><th>Score</th><th>Notes</th>
    </tr></thead><tbody>`;
    top10.forEach((r,i)=>{
      const green = r.pts>=5 ? "background:rgba(0,255,136,.08);border-left:3px solid var(--green)" : "";
      html += `<tr style="${green}">
        <td>${i+1}</td><td><b>${r.sym}</b></td>
        <td>${r.gapPct>=0?'+':''}${r.gapPct.toFixed(2)}%</td>
        <td>$${fmt2(r.last)}</td>
        <td>$${Math.round(r.pmDol).toLocaleString()}</td>
        <td>${r.vwap!=null?'$'+fmt2(r.vwap):'â€”'}</td>
        <td><b>${r.pts}</b>/6</td>
        <td style="color:var(--dim)">${r.tags.join(" Â· ")}</td>
      </tr>`;
    });
    html += `</tbody></table></div>`;
    out.innerHTML = html;
  }

  btn.disabled=false; btn.textContent="â–¶ SCAN PRE-MARKET";
}

async function runOpenMomentum(){
  const btn = document.getElementById("omBtn");
  const out = document.getElementById("omOut");
  btn.disabled = true; btn.textContent = "SCANNINGâ€¦";
  out.innerHTML = `<div class="msg"><span class="spin"></span>Loading 9:30â€“10:30 momentumâ€¦</div>`;
  await ensureTickersLoaded("dLog");

  const nowNY = nyParts(new Date());
  const isDuringOpenWindow = inRangeHM(nowNY.hh, nowNY.mm, 9,30, 10,30);

  // Market bias (QQQ)
  let qqqChg = null;
  try{
    const qqq = await fetchChart("QQQ","1d","5m",false);
    const prev = qqq.meta?.previousClose;
    const last = qqq.meta?.regularMarketPrice ?? qqq.close.filter(x=>x!=null).slice(-1)[0];
    if(prev && last) qqqChg = ((last-prev)/prev)*100;
  }catch(e){}

  const results = [];
  const maxN = Math.min(100, TICKERS.length);

  for(let i=0;i<maxN;i++){
    const t = TICKERS[i];
    try{
      // 5d gives us past sessions to estimate avg first-hour volume
      const ch = await fetchChart(t.sym,"5d","5m",false);

      // Group bars by NY date and first-hour window
      const byDate = new Map();
      for(let k=0;k<ch.ts.length;k++){
        const p = nyParts(new Date(ch.ts[k]*1000));
        const key = `${p.y}-${String(p.m).padStart(2,'0')}-${String(p.d).padStart(2,'0')}`;
        if(!byDate.has(key)) byDate.set(key, []);
        byDate.get(key).push({hh:p.hh, mm:p.mm, close:ch.close[k], vol:ch.vol[k]||0});
      }

      const dates = Array.from(byDate.keys()).sort();
      const todayKey = dates[dates.length-1];
      const todayBars = byDate.get(todayKey) || [];

      const inOpen = (bar)=>inRangeHM(bar.hh,bar.mm,9,30,10,30);

      const todayOpenBars = todayBars.filter(inOpen);
      if(todayOpenBars.length < 3) continue;

      const firstClose = todayOpenBars.find(b=>b.close!=null)?.close;
      const lastClose  = [...todayOpenBars].reverse().find(b=>b.close!=null)?.close;
      if(firstClose==null || lastClose==null) continue;

      const changePct = ((lastClose-firstClose)/firstClose)*100;
      const todayVol  = todayOpenBars.reduce((a,b)=>a+(b.vol||0),0);
      const todayVWAP = calcVWAP(todayOpenBars.map(b=>b.close), todayOpenBars.map(b=>b.vol));
      const aboveVWAP = (todayVWAP!=null) ? (lastClose>todayVWAP) : false;

      // Average first-hour volume from prior sessions
      const prior = dates.slice(0,-1);
      let vols = [];
      for(const d of prior){
        const bars = (byDate.get(d)||[]).filter(inOpen);
        if(bars.length<3) continue;
        vols.push(bars.reduce((a,b)=>a+(b.vol||0),0));
      }
      const avgFirstHourVol = vols.length ? (vols.reduce((a,b)=>a+b,0)/vols.length) : null;
      const relVol = (avgFirstHourVol && avgFirstHourVol>0) ? (todayVol/avgFirstHourVol) : null;

      // Score (max 9): relVol + move + VWAP + QQQ bias
      let pts = 0;
      const tags=[];

      if(relVol!=null && relVol>=1.5){ pts+=3; tags.push(`RelVol ${relVol.toFixed(2)}x`); }
      else if(relVol!=null && relVol>=1.2){ pts+=2; tags.push(`RelVol ${relVol.toFixed(2)}x`); }
      else if(relVol!=null){ pts+=1; tags.push(`RelVol ${relVol.toFixed(2)}x`); }
      else { tags.push("RelVol â€”"); }

      if(changePct>=0.6){ pts+=2; tags.push(`Move +${changePct.toFixed(2)}%`); }
      else if(changePct<=-0.6){ tags.push(`Move ${changePct.toFixed(2)}%`); }
      else { tags.push(`Move ${changePct.toFixed(2)}%`); }

      if(aboveVWAP){ pts+=2; tags.push("Above VWAP"); }

      if(qqqChg!=null && qqqChg>0){ pts+=2; tags.push("QQQ green"); }
      else if(qqqChg!=null){ tags.push(`QQQ ${qqqChg.toFixed(2)}%`); }

      results.push({sym:t.sym,name:t.name,pts,changePct,relVol,last:lastClose,vwap:todayVWAP,tags});
    }catch(e){}
    if(i%10===0) await new Promise(r=>setTimeout(r,120));
  }

  results.sort((a,b)=> (b.pts-a.pts) || (b.changePct-a.changePct));
  const top10 = results.slice(0,10);

  if(!top10.length){
    out.innerHTML = `<div class="msg">${isDuringOpenWindow ? "No data yet (try again in a few minutes)." : "Best used 9:30â€“10:30 ET. You can still run it, but results may be limited."}</div>`;
  }else{
    let html = `<div class="msg" style="text-align:left">
      <div style="font-weight:900;letter-spacing:.08em;color:var(--green)">TOP 10 OPEN MOMENTUM</div>
      <div style="color:var(--dim);margin-top:6px;font-size:12px">9:30â€“10:30 ET Â· ranked by relative volume + move + VWAP + QQQ bias</div>
    </div>
    <div class="sw-wrap"><table><thead><tr>
      <th>#</th><th>Symbol</th><th>Score</th><th>Move%</th><th>RelVol</th><th>Last</th><th>VWAP</th><th>Notes</th>
    </tr></thead><tbody>`;
    top10.forEach((r,i)=>{
      const green = r.pts>=7 ? "background:rgba(0,255,136,.08);border-left:3px solid var(--green)" : "";
      html += `<tr style="${green}">
        <td>${i+1}</td><td><b>${r.sym}</b></td>
        <td><b>${r.pts}</b>/9</td>
        <td>${r.changePct>=0?'+':''}${r.changePct.toFixed(2)}%</td>
        <td>${r.relVol!=null?r.relVol.toFixed(2)+'x':'â€”'}</td>
        <td>$${fmt2(r.last)}</td>
        <td>${r.vwap!=null?'$'+fmt2(r.vwap):'â€”'}</td>
        <td style="color:var(--dim)">${r.tags.join(" Â· ")}</td>
      </tr>`;
    });
    html += `</tbody></table></div>`;

    // Optional Telegram: send top pick from Open Momentum if enabled
    try{
      const autoTop = (localStorage.getItem("tg_auto_top") === "1");
      if(autoTop && tgEnabled && top10[0]){
        sendAlert(top10[0].sym, top10[0].name, top10[0].last, top10[0].changePct, top10[0].pts, 9, "OPEN MOMENTUM TOP", top10[0].tags.join(" Â· "));
      }
    }catch(e){}

    out.innerHTML = html;
  }

  btn.disabled=false; btn.textContent="â–¶ SCAN 9:30â€“10:30";
}

// Init UI
// Proxy health check â€” runs on load, finds the first working proxy and reorders list
let WORKING_PROXY_IDX = -1;
async function checkProxies() {
  const testUrl = `https://query2.finance.yahoo.com/v8/finance/chart/SPY?interval=1d&range=1d`;
  for (let i = 0; i < PROXIES.length; i++) {
    try {
      const ctrl = new AbortController();
      const tid = setTimeout(() => ctrl.abort(), 8000);
      const r = await fetch(PROXIES[i](testUrl), { signal: ctrl.signal });
      clearTimeout(tid);
      if (!r.ok) continue;
      const text = await r.text();
      if (text.trim()[0] === '{') {
        WORKING_PROXY_IDX = i;
        // Reorder: put working proxy first so first ticker always hits fast
        const working = PROXIES.splice(i, 1)[0];
        PROXIES.unshift(working);
        console.log(`âœ“ Proxy ${i} working`);
        return true;
      }
    } catch(e) { /* try next */ }
  }
  return false;
}

document.addEventListener('DOMContentLoaded', async () => {
  try { syncTGToggleUI(); } catch(e) {}
  try { syncAutoMonitorUI(); } catch(e) {}
  // Silent proxy check in background
  const ok = await checkProxies();
  if (!ok) {
    // Show warning banner on all scan buttons
    const warn = `<div style="background:rgba(255,51,85,.1);border:1px solid rgba(255,51,85,.3);padding:8px 14px;font-size:11px;color:var(--red);margin-bottom:10px;letter-spacing:.04em">
      âš  Network check failed â€” all data proxies are unreachable. This may be a firewall, VPN, or browser extension blocking outbound requests. Try disabling ad-blockers or use a different network.
    </div>`;
    ['dBody','sBody'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.innerHTML = warn + el.innerHTML;
    });
  }
});
</script>
<!-- Telegram Settings Modal -->
<div id="tgModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9999;align-items:center;justify-content:center;padding:18px">
  <div style="width:min(720px,96vw);background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px 16px 14px;box-shadow:0 10px 40px rgba(0,0,0,.55)">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <div>
        <div style="font-weight:900;letter-spacing:.08em">ğŸ“² TELEGRAM SETTINGS</div>
        <div style="color:var(--dim);font-size:12px;margin-top:2px">Stored only in your browser (localStorage). Create a bot with @BotFather, then get your chat_id.</div>
      </div>
      <button class="btn-d" onclick="closeTGSettings()" style="padding:8px 12px">âœ•</button>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px">
      <div>
        <div style="font-size:11px;color:var(--dim);letter-spacing:.08em;margin-bottom:6px">BOT TOKEN</div>
        <input id="tgTok" placeholder="123456:ABCDEF..." style="width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);background:#03070b;color:var(--text)">
      </div>
      <div>
        <div style="font-size:11px;color:var(--dim);letter-spacing:.08em;margin-bottom:6px">CHAT ID</div>
        <input id="tgChat" placeholder="e.g. 123456789" style="width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);background:#03070b;color:var(--text)">
      </div>
    </div>

    <label style="display:flex;gap:10px;align-items:center;margin-top:10px;color:var(--dim);font-size:12px;cursor:pointer">
      <input type="checkbox" id="tgAuto" style="transform:scale(1.15)">
      Auto-send TOP PICK after each scan
    </label>

    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
      <button class="btn-d" onclick="saveTGSettings()">Save</button>
      <button class="btn-d" onclick="closeTGSettings()" style="background:transparent;border:1px solid var(--border)">Cancel</button>
    </div>
  </div>
</div>
</body>
</html>
